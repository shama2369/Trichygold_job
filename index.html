<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trichy Gold Campaigns</title>
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    body {
      background: #fff;
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .btn-primary {
      background-color: #6B46C1;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-primary:hover {
      background-color: #553C9A;
    }
    .btn-secondary {
      background-color: #9F7AEA;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-secondary:hover {
      background-color: #805AD5;
    }
    .btn-remove {
      background-color: #EF4444;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-remove:hover {
      background-color: #DC2626;
    }
    .btn-remove-light {
      background-color: #FFEB3B;
      color: #7C6F00;
      transition: background-color 0.3s;
      border: 1px solid #FBC02D;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      width: 100%;
    }
    .btn-remove-light:hover {
      background-color: #FFF176;
    }
    
    /* Campaign table styles */
    .crm-table {
      border-collapse: collapse;
      font-size: 13px;
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
      background: #fff;
      width: 100%;
    }
    .crm-table th, .crm-table td {
      font-weight: normal;
      padding: 0.32rem 0.6rem 0.32rem 0.6rem;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-left: none;
      vertical-align: middle;
      white-space: nowrap;
      height: 34px;
      min-width: 110px;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #fff;
    }
    .crm-table th {
      background: #f8f9fa;
      color: #222;
      font-size: 13px;
      font-weight: bold;
      border-bottom: 1.5px solid #d0d0d0;
    }
    .crm-table tbody tr:hover {
      background: #f4f7fa;
    }
    .crm-table tr:last-child td {
      border-bottom: 1px solid #e0e0e0;
    }
    .crm-table th:not(:last-child), .crm-table td:not(:last-child) {
      border-right: 1px solid #e0e0e0;
    }
    .crm-table td:last-child {
      white-space: normal;
      overflow: visible;
      min-width: 120px;
      max-width: none;
    }
    .crm-table td:last-child .btn {
      margin: 1px;
      font-size: 11px;
      padding: 2px 6px;
    }
    
    /* Filter styles */
    .form-control-sm {
      height: 28px;
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      width: 100%;
    }
    .form-control-sm:focus {
      border-color: #6B46C1;
      outline: none;
      box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
    }
    .mt-1 {
      margin-top: 2px;
    }
    .section {
      width: 100%;
      padding: 1.25rem 0;
    }

    .card {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    
    /* Custom tooltip styles */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: "Tags can only be generated automatically";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      margin-bottom: 3px;
      z-index: 1000;
    }
  </style>
</head>
  <!-- Login Form -->
  <div id="login-form" class="min-h-screen flex items-center justify-center bg-white" style="display: none;">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Trichy Gold</h1>
        <h2 class="text-lg font-semibold text-purple-600">Campaign Manager</h2>
      </div>
      
      <!-- Login Form -->
      <form class="space-y-8" id="loginForm">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input id="username" name="username" type="text" required autocomplete="username"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your username">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input id="password" name="password" type="password" required autocomplete="current-password"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your password">
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-md text-sm"></div>
        <div>
          <button type="submit" 
                  class="w-full py-3 px-4 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
            Sign in
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="min-h-screen flex items-center justify-center">
  <!-- MAIN CARD - ALL UI SECTIONS MUST BE INSIDE THIS DIV -->
    <div class="card w-full p-6 relative">
    <h1 class="text-2xl font-bold text-center text-purple-700 mb-6">Trichy Gold Campaign Manager</h1>
    
    <!-- Main Menu -->
    <div class="mb-8">
      <div class="flex flex-wrap gap-2 md:gap-4 justify-center">
        <button onclick="showSection('campaigns-table')" class="btn-primary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
          <span>Campaigns Table</span>
        </button>
        <button onclick="showSection('new-campaign')" class="btn-secondary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>New Campaign</span>
        </button>
        <button onclick="showSection('query-campaign')" class="btn-primary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span>Query Campaign</span>
        </button>
        <button onclick="showSection('edit-campaign')" class="btn-secondary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          <span>Edit Campaign</span>
        </button>
        <button onclick="showSection('delete-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center delete-campaign-btn" style="display: none;">
          <span>Delete Campaign</span>
        </button>

        <button onclick="showSection('export-campaign')" class="btn-primary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l3-3m-3 3l-3-3m2-8H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-1V3a1 1 0 00-1-1h-4a1 1 0 00-1 1v2z"></path>
          </svg>
          <span>Export Campaigns</span>
        </button>
        <button onclick="showSection('impression-tracking')" class="btn-secondary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          <span>Impression Tracking</span>
        </button>
        <button onclick="showSection('user-manager')" class="btn-secondary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.485 0 4.797.657 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>User & Role Manager</span>
        </button>

        <button onclick="window.sessionManager.logout()" class="btn-secondary py-2 px-2 md:px-4 rounded-md flex items-center text-sm md:text-base">
          <svg class="w-4 h-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Campaigns Table Section -->
    <div id="campaigns-table" class="section">
      


      <!-- Campaigns Table -->
      <div class="mb-4">
        <div class="mb-2"><b>Total Campaigns:</b> <span id="campaigns-count">0</span></div>
      </div>
      <div style="overflow-x: auto; width: 100%; border-bottom: 1.5px solid #d0d0d0;">
        <table class="crm-table" style="min-width: max-content; width: 100%;">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th style="width: 60px;">#</th>
              <th style="width: 120px;">Campaign ID</th>
              <th style="width: 150px;">Campaign Name</th>
              <th style="width: 120px;">Offers</th>
              <th style="width: 100px;">Work Start Date</th>
              <th style="width: 100px;">Start Date</th>
              <th style="width: 100px;">End Date</th>
              <th style="width: 100px;">Budget (AED)</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 120px;">Target Age</th>
              <th style="width: 100px;">Target Gender</th>
              <th style="width: 150px;">Categories</th>
              <th style="width: 100px;">Goal Sales</th>
              <th style="width: 100px;">Goal Impressions</th>
              <th style="width: 100px;">Goal Conversions</th>
              <th style="width: 120px;">Achvd Sales</th>
              <th style="width: 120px;">Achvd Impressions</th>
              <th style="width: 120px;">Achvd Conversions</th>
              <th style="width: 150px;">Tag Numbers</th>
            </tr>
            <tr>
              <th><!-- No filter for checkbox --></th>
              <th><!-- No filter for # --></th>
              <th><input type="text" id="filter-campaign-id" placeholder="Filter Campaign ID" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-campaign-name" placeholder="Filter Campaign Name" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-offers" placeholder="Filter Offers" class="form-control form-control-sm"></th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">Work Start Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-work-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-work-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">Start Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">End Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-end-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-end-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th>
                <input type="number" id="filter-budget-min" class="form-control form-control-sm" placeholder="Min">
                <input type="number" id="filter-budget-max" class="form-control form-control-sm mt-1" placeholder="Max">
              </th>
              <th>
                <select id="filter-status" class="form-control form-control-sm">
                  <option value="">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </th>
              <th><input type="text" id="filter-target-age" placeholder="Filter Age" class="form-control form-control-sm"></th>
              <th>
                <select id="filter-target-gender" class="form-control form-control-sm">
                  <option value="">All Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="All">All</option>
                </select>
              </th>
              <th>
                <select id="filter-categories" class="form-control form-control-sm">
                  <option value="">All Categories</option>
                  <option value="Tourist">Tourist</option>
                  <option value="Resident">Resident</option>
                  <option value="All Walkin">All Walkin</option>
                  <option value="Social Media">Social Media</option>
                  <option value="Social Groups">Social Groups</option>
                  <option value="Corporates">Corporates</option>
                  <option value="Residential Cmty">Residential Cmty</option>
                  <option value="Local Cmty">Local Cmty</option>
                  <option value="Blue collar wrkrs">Blue collar wrkrs</option>
                  <option value="Existing cutomers">Existing cutomers</option>
                  <option value="HNTW">HNTW</option>
                  <option value="Hotels">Hotels</option>
                  <option value="Tourism Companies">Tourism Companies</option>
                  <option value="Tour Drivers">Tour Drivers</option>
                  <option value="Other Tours Assctd cmpy">Other Tours Assctd cmpy</option>
                  <option value="DGJG">DGJG</option>
                  <option value="Festival & Occasion Buyers">Festival & Occasion Buyers</option>
                  <option value="Product Launch">Product Launch</option>
                </select>
              </th>
              <th>
                <input type="number" id="filter-goal-sales-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-sales-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-goal-impressions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-impressions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-goal-conversions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-goal-conversions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-sales-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-sales-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-impressions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-impressions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="number" id="filter-achieved-conversions-min" class="form-control form-control-sm w-full" placeholder="Min" style="display: block !important; margin-bottom: 4px;">
                <input type="number" id="filter-achieved-conversions-max" class="form-control form-control-sm w-full" placeholder="Max" style="display: block !important;">
              </th>
              <th>
                <input type="text" id="filter-tag-numbers" placeholder="Filter Tag Numbers" class="form-control form-control-sm">
              </th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body">
            <!-- Campaigns will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>


    <div id="new-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Create Campaign</h2>
      <div class="space-y-6">
        <!-- Campaign Form -->
        <div class="mb-6">
          <div class="space-y-6">
            <!-- Campaign ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="campaignId" class="block text-sm font-medium text-purple-700">Campaign ID</label>
                <input id="campaignId" type="text" readonly class="w-full p-2 border rounded-md bg-gray-100 focus:outline-none" placeholder="Will be assigned automatically">
              </div>
              <div>
                <label for="name" class="block text-sm font-medium text-purple-700">Campaign Name</label>
                <input id="name" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Offers -->
            <div>
              <label for="description" class="block text-sm font-medium text-purple-700">Offers</label>
              <input id="description" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            
            <!-- Work Start Date, Start Date and End Date -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="workStartDate" class="block text-sm font-medium text-purple-700">Work Start Date</label>
                <input id="workStartDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="startDate" class="block text-sm font-medium text-purple-700">Start Date</label>
                <input id="startDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="endDate" class="block text-sm font-medium text-purple-700">End Date</label>
                <input id="endDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Budget and Status -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="budget" class="block text-sm font-medium text-purple-700">Budget (AED)</label>
                <input id="budget" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="status" class="block text-sm font-medium text-purple-700">Status</label>
                <select id="status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required> 
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
            </div>
            
            <!-- Target Audience -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Target Audience</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="targetAge" class="block text-sm font-medium text-purple-700">Age</label>
                  <input id="targetAge" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g. 18-30">
                </div>
                <div>
                  <label for="targetGender" class="block text-sm font-medium text-purple-700">Gender</label>
                  <select id="targetGender" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="All">All</option>
                  </select>
                </div>
              </div>
              
              <!-- Category Section - Full Width -->
              <div class="mt-4">
                <label for="targetCategory" class="block text-sm font-medium text-purple-700 mb-2">Category</label>
                <div id="targetCategoryContainer" class="space-y-2">
                  <div class="targetCategorySelect flex flex-wrap items-center gap-2">
                    <select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                      <option value="">Select Category</option>
                      <option>Tourist</option>
                      <option>Resident</option>
                      <option>All Walkin</option>
                      <option>Social Media</option>
                      <option>Social Groups</option>
                      <option>Corporates</option>
                      <option>Residential Cmty</option>
                      <option>Local Cmty</option>
                      <option>Blue collar wrkrs</option>
                      <option>Existing cutomers</option>
                      <option>HNTW</option>
                      <option>Hotels</option>
                      <option>Tourism Companies</option>
                      <option>Tour Drivers</option>
                      <option>Other Tours Assctd cmpy</option>
                      <option>DGJG</option>
                      <option>Festival & Occasion Buyers</option>
                      <option>Product Launch</option>
                      <option>Other</option>
                    </select>
                    <input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="EnterTag">
                    <button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>
                  </div>
                </div>
                <button type="button" id="addCategoryBtn" class="btn-secondary py-1 px-3 rounded-md mt-2">Add Category</button>
              </div>
            </div>
            
            <!-- Goals -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Goals</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label for="goalSales" class="block text-sm font-medium text-purple-700">Sales (AED)</label>
                  <input id="goalSales" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                  <label for="goalImpressions" class="block text-sm font-medium text-purple-700">Impressions</label>
                  <input id="goalImpressions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                  <label for="goalConversions" class="block text-sm font-medium text-purple-700">Conversions</label>
                  <input id="goalConversions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
              </div>
            </div>
            
            <!-- Achieved -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-green-600 mb-2">üéØ Achieved</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label for="achievedSales" class="block text-sm font-medium text-green-700">Sales (AED)</label>
                  <input id="achievedSales" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label for="achievedImpressions" class="block text-sm font-medium text-green-700">Impressions</label>
                  <input id="achievedImpressions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label for="achievedConversions" class="block text-sm font-medium text-green-700">Conversions</label>
                  <input id="achievedConversions" type="number" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
              </div>
            </div>
            
            <!-- Channels -->
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Channels</h3>
              <div id="channelContainer" class="space-y-8">
                <div class="channelEntry grid grid-cols-7 gap-2 items-end p-4 border border-gray-200 rounded-lg bg-gray-50">
                  <div class="col-span-1">
                    <label class="block text-sm font-medium text-purple-700">Channel Type</label>
                    <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
                      <option value="">Select Channel</option>
                      <option value="Social Media">Social Media</option>
                      <option value="Print Media">Print Media</option>
                      <option value="Outdoor Events">Outdoor Events</option>
                      <option value="Email">Email</option>
                      <option value="Message">Message</option>
                      <option value="Radio">Radio</option>
                      <option value="TV">TV</option>
                      <option value="Promotional Items">Promotional Items</option>
                      <option value="Promotional Offer">Promotional Offer</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
                  <div class="col-span-1 flex items-center justify-center">
                    <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
                      Remove
                    </button>
                  </div>
                </div>
              </div>
              <button class="btn-secondary mt-2 py-2 px-4 rounded-md" onclick="addChannelEntry()">Add Channel</button>
            </div>
            
            <button onclick="submitCampaign()" class="btn-primary w-full py-2 rounded-md">Submit Campaign</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Campaign Section -->
    <div id="edit-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Edit Campaign</h2>
      <div class="space-y-6">
        <div class="mb-6">
          <label for="editCampaignId" class="block text-sm font-medium text-gray-700 mb-2">Enter Campaign ID to Edit</label>
          <div class="flex items-center space-x-4">
            <input id="editCampaignId" type="text" 
                   class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   placeholder="e.g., CAMP_00001">
            <button onclick="loadCampaignForEdit()" 
                    class="btn-secondary py-2 px-6 rounded-md whitespace-nowrap ml-12">
              Load Campaign
            </button>
          </div>
        </div>
        <div id="editCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign form will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Query Campaign Section -->
    <div id="query-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Query Campaign</h2>
      <div class="space-y-4">
        <!-- Manual Campaign Code Entry -->
        <div id="queryManualEntryContainer" class="flex gap-2 items-end">
          <input id="queryCampaignCodeInput" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter Campaign Code (e.g., CAMP_00001)">
          <button id="queryLoadBtn" class="btn-secondary py-2 px-4 rounded-md">Load Campaign</button>
        </div>
        <div id="queryCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign details form will be loaded here -->
        </div>
      </div>
      <button id="downloadExcelBtn" class="btn-secondary mt-3 py-2 px-4 rounded-md hidden">Download as Excel</button>
      <script>
        // Helper to show/hide query campaign input section
        function setQueryCampaignInputVisibility(visible) {
          const manualInput = document.getElementById('queryManualEntryContainer');
          if (manualInput) {
            if (visible) {
              manualInput.classList.remove('hidden');
            } else {
              manualInput.classList.add('hidden');
            }
          }
          // Also hide the query form if not visible
          const queryForm = document.getElementById('queryCampaignForm');
          if (!visible && queryForm) {
            queryForm.classList.remove('hidden');
          }
        }

        // Update query section menu functionality to handle both entry points
        function addQueryCampaignMenuFunctionality() {
          const queryMenuBtn = document.querySelector("button[onclick=\"showSection('query-campaign')\"]");
          if (!queryMenuBtn) { console.log('Query menu button not found'); return; }
          queryMenuBtn.addEventListener('click', function(event) {
            event.preventDefault();
            // Find selected campaign
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
            if (selectedRadio) {
              // Query via radio selection: hide input, show form
              setQueryCampaignInputVisibility(false);
              showSection('query-campaign');
              window.querySelectedCampaign();
              // Ensure the query form is visible
              const queryForm = document.getElementById('queryCampaignForm');
              if (queryForm) queryForm.classList.remove('hidden');
            } else {
              // Query via menu: show input, hide form
              showSection('query-campaign');
              setQueryCampaignInputVisibility(true);
              const queryForm = document.getElementById('queryCampaignForm');
              if (queryForm) queryForm.classList.add('hidden');
            }
          });
        }

        // Manual campaign code entry logic for Query
        document.addEventListener('DOMContentLoaded', function() {
          addQueryCampaignMenuFunctionality();
          const queryLoadBtn = document.getElementById('queryLoadBtn');
          if (queryLoadBtn) {
            queryLoadBtn.addEventListener('click', function() {
              const code = document.getElementById('queryCampaignCodeInput').value.trim();
              if (!code) {
                alert('Please enter a campaign code.');
                return;
              }
              // Find by campaignId (not _id)
              const campaign = originalCampaigns.find(c => c.campaignId === code);
              if (!campaign) {
                alert('Campaign not found.');
                return;
              }
              // Simulate radio selection logic
              window.querySelectedCampaignById(campaign._id);
            });
          }
          // Update visibility on page load
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          setQueryCampaignInputVisibility(!selectedRadio);
          // Update visibility on radio selection change
          document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'selected_campaign') {
              setQueryCampaignInputVisibility(false);
              window.querySelectedCampaign();
            }
          });
        });
        // Helper to trigger query by _id
        window.querySelectedCampaignById = function(campaignId) {
          if (typeof window.querySelectedCampaign === 'function') {
            window.querySelectedCampaign(campaignId);
          }
        }
      </script>
    </div>

    <!-- Export Section -->
    <div id="export-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Export All Campaigns to Excel</h2>
      <button onclick="exportCampaigns()" class="btn-primary w-full py-2 rounded-md">Download Excel</button>
    </div>

    <!-- Impression Tracking Section -->
    <div id="impression-tracking" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Impression & Conversion Tracking & Analytics</h2>
      
      <!-- Impression Statistics -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-blue-600 mb-3">üìä Overall Statistics</h3>
        <button onclick="loadImpressionStats()" class="btn-secondary mb-4 py-2 px-4 rounded-md">Refresh Statistics</button>
        <div id="impressionStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Stats will be loaded here -->
        </div>
      </div>

      <!-- Top Performing Channels -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-green-600 mb-3">üèÜ Top Performing Channels</h3>
        <div id="topChannels" class="bg-white p-4 rounded-lg border border-gray-200">
          <!-- Top channels will be loaded here -->
        </div>
      </div>

      <!-- Update Impressions -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-orange-600 mb-3">‚úèÔ∏è Update Impressions</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label for="updateCampaignId" class="block text-sm font-medium text-purple-700">Campaign ID</label>
              <input id="updateCampaignId" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., CAMP_00001">
            </div>
            <div class="flex items-end">
              <button onclick="loadCampaignChannels()" class="btn-secondary py-2 px-4 rounded-md">Load Channels</button>
            </div>
          </div>
          
          <!-- Campaign Channels Display -->
          <div id="campaignChannelsDisplay" class="hidden mt-4">
            <h4 class="text-sm font-medium text-purple-700 mb-3">Campaign Channels</h4>
            <div id="channelsList" class="space-y-3">
              <!-- Channels will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Tag Search -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-indigo-600 mb-3">üîç Search by Tag Number</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label for="searchTagNumber" class="block text-sm font-medium text-purple-700">Tag Number</label>
              <input id="searchTagNumber" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., IG001, FB002">
            </div>
            <div class="flex items-end">
              <button onclick="searchByTag()" class="btn-primary py-2 px-4 rounded-md">Search</button>
            </div>
            <div class="flex items-end">
              <button onclick="loadAllTags()" class="btn-secondary py-2 px-4 rounded-md">View All Tags</button>
            </div>
          </div>
          <div id="tagSearchResults" class="mt-4">
            <!-- Search results will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Tag Counters -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-teal-600 mb-3">üî¢ Tag Number Counters</h3>
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <button onclick="loadTagCounters()" class="btn-secondary mb-4 py-2 px-4 rounded-md">Refresh Counters</button>
          <div id="tagCounters" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <!-- Tag counters will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Campaign Impressions List -->
      <div class="mb-6">
        <h3 class="text-md font-medium text-pink-600 mb-3">üìã All Campaigns with Impressions</h3>
        <div id="campaignImpressionsList" class="bg-white p-4 rounded-lg border border-gray-200">
          <!-- Campaign list will be loaded here -->
        </div>
      </div>
    </div>

    <!-- User & Role Manager Section -->
    <div id="user-manager" class="section hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4">User & Role Manager</h2>
          <div class="flex gap-4 mb-6">
        <button id="toggleUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">User</button>
        <button id="toggleRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Role</button>
          </div>
          <div id="user-manager-user-section">
                      <div class="flex gap-4 mb-6">
                <button id="addUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add User</button>
                <button id="addRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add Role</button>
              </div>
        
        <!-- User Table -->
        <div id="user-table-section">
            <div class="w-full overflow-x-auto">
              <table class="crm-table w-full mb-6 whitespace-nowrap">
                <thead>
                  <tr>
                    <th class="text-lg font-bold">Username</th>
                  <th class="text-lg font-bold">Email</th>
                    <th class="text-lg font-bold">Role</th>
                    <th class="text-lg font-bold">Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
          </div>
        </div>
        
        <!-- User Create Form -->
        <div id="user-create-form-section" class="hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left">Create New User</h2>
          
          <div class="w-full max-w-xl mx-auto">
            <form id="createUserForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
              <div class="sm:col-span-2">
                <label for="newUserUsername" class="block text-sm font-medium text-purple-700">Username</label>
                <input id="newUserUsername" name="username" type="text" required autocomplete="username" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newUserEmail" class="block text-sm font-medium text-purple-700">Email</label>
                <input id="newUserEmail" name="email" type="email" required autocomplete="email" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newUserPassword" class="block text-sm font-medium text-purple-700">Password</label>
                <input id="newUserPassword" name="password" type="password" required autocomplete="new-password" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2 flex flex-col">
                <label for="newUserRoles" class="block text-sm font-medium text-purple-700">Role</label>
                <select id="newUserRoles" name="roles" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full"></select>
              </div>
              <div class="col-span-full flex justify-end gap-2">
                <button type="button" id="cancelCreateUserBtn" class="btn-secondary py-2 px-6 rounded-md">Cancel</button>
                <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create User</button>
              </div>
            </form>
          </div>
            </div>
          </div>
          <div id="user-manager-role-section" class="hidden">
        <div class="w-full max-w-xl mx-auto mb-6 hidden" id="role-create-form-container">
              <form id="createRoleForm" class="grid grid-cols-1 gap-4 bg-white p-8 rounded-lg shadow">
                <div>
                  <label for="newRoleName" class="block text-sm font-medium text-purple-700">Role Name</label>
                  <input id="newRoleName" name="roleName" type="text" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
                </div>
            <div>
              <label for="newRoleDescription" class="block text-sm font-medium text-purple-700">Description</label>
              <textarea id="newRoleDescription" name="roleDescription" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" rows="3" placeholder="Describe what this role can do..."></textarea>
                </div>
            <div>
              <label class="block text-sm font-medium text-purple-700 mb-3">Permissions</label>
              <div class="grid grid-cols-1 gap-3">
                <div class="flex items-center">
                  <input type="checkbox" id="perm_create_campaigns" name="permissions" value="create_campaigns" class="mr-3">
                  <label for="perm_create_campaigns" class="text-sm">Create Campaigns</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_edit_campaigns" name="permissions" value="edit_campaigns" class="mr-3">
                  <label for="perm_edit_campaigns" class="text-sm">Edit Campaigns</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_delete_campaigns" name="permissions" value="delete_campaigns" class="mr-3">
                  <label for="perm_delete_campaigns" class="text-sm">Delete Campaigns</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_campaigns" name="permissions" value="view_campaigns" class="mr-3" checked>
                  <label for="perm_view_campaigns" class="text-sm">View Campaigns</label>
        </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_reports" name="permissions" value="view_reports" class="mr-3">
                  <label for="perm_view_reports" class="text-sm">View Reports</label>
      </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_export_data" name="permissions" value="export_data" class="mr-3">
                  <label for="perm_export_data" class="text-sm">Export Data</label>
    </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_users" name="permissions" value="manage_users" class="mr-3">
                  <label for="perm_manage_users" class="text-sm">Manage Users</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_roles" name="permissions" value="manage_roles" class="mr-3">
                  <label for="perm_manage_roles" class="text-sm">Manage Roles</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_generate_tags" name="permissions" value="generate_tags" class="mr-3">
                  <label for="perm_generate_tags" class="text-sm">Generate Tags</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_channels" name="permissions" value="manage_channels" class="mr-3">
                  <label for="perm_manage_channels" class="text-sm">Manage Channels</label>
          </div>
              </div>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="backToRolesBtn" class="btn-secondary py-2 px-6 rounded-md">Back to Roles</button>
              <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create Role</button>
          </div>
        </form>
        </div>
        <div class="w-full max-w-xl mx-auto" id="roles-table-container">
          <div class="mb-3">
            <h3 class="text-lg font-semibold text-purple-700">Roles</h3>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role Name</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="roles-table-body">
                <!-- Roles will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- User & Role Manager Section -->

    <!-- Delete Campaign Section -->
    <div id="delete-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-red-700 mb-4">Delete Campaign</h2>
      <div class="space-y-6">
        <div id="deleteManualEntryContainer" class="flex gap-2 items-end hidden">
          <input id="deleteCampaignCodeInput" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter Campaign Code (e.g., CAMP_00001)">
          <button id="deleteManualBtn" class="btn-secondary py-2 px-4 rounded-md">Delete Campaign</button>
        </div>
        <div id="deleteResultMsg" class="hidden mt-4"></div>
      </div>
      <script>
        function setDeleteCampaignInputVisibility(visible) {
          const manualInput = document.getElementById('deleteManualEntryContainer');
          if (manualInput) {
            if (visible) {
              manualInput.classList.remove('hidden');
            } else {
              manualInput.classList.add('hidden');
            }
          }
        }
        function addDeleteCampaignMenuFunctionality() {
          const deleteMenuBtn = document.querySelector("button[onclick=\"showSection('delete-campaign')\"]");
          if (!deleteMenuBtn) { console.log('Delete menu button not found'); return; }
          deleteMenuBtn.addEventListener('click', function(event) {
            event.preventDefault();
            // Check if user has permission to delete campaigns
            if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
              alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
              return;
            }
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
            if (selectedRadio) {
              setDeleteCampaignInputVisibility(false);
              showSection('delete-campaign');
              // Auto-delete the selected campaign
              const campaignId = selectedRadio.value;
              const campaign = originalCampaigns.find(c => c._id === campaignId);
              if (campaign) {
                const confirmDelete = confirm(`Are you sure you want to delete the campaign "${campaign.campaignId}"?\n\nThis action cannot be undone.`);
                if (confirmDelete) {
                  deleteCampaignById(campaignId);
                }
              }
            } else {
              showSection('delete-campaign');
              setDeleteCampaignInputVisibility(true);
            }
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          // Ensure delete section is properly hidden on page load
          const deleteSection = document.getElementById('delete-campaign');
          if (deleteSection) {
            deleteSection.classList.add('hidden');
          }
          
          addDeleteCampaignMenuFunctionality();
          const deleteManualBtn = document.getElementById('deleteManualBtn');
          if (deleteManualBtn) {
            deleteManualBtn.addEventListener('click', async function() {
              // Check if user has permission to delete campaigns
              if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
                alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
                return;
              }
              
              const code = document.getElementById('deleteCampaignCodeInput').value.trim();
              const resultMsg = document.getElementById('deleteResultMsg');
              if (!code) {
                alert('Please enter a campaign code.');
                return;
              }
              const campaign = originalCampaigns.find(c => c.campaignId === code);
              if (!campaign) {
                alert('Campaign not found.');
                return;
              }
              // Confirm delete
              const confirmDelete = confirm(`Are you sure you want to delete the campaign "${campaign.campaignId}"?\n\nThis action cannot be undone.`);
              if (!confirmDelete) return;
              try {
                deleteManualBtn.textContent = 'Deleting...';
                deleteManualBtn.disabled = true;
                const response = await fetch(`/api/campaigns/${campaign._id}`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                  originalCampaigns = originalCampaigns.filter(c => c._id !== campaign._id);
                  
                  // Clear any radio selection
                  const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
                  if (selectedRadio) {
                    selectedRadio.checked = false;
                  }
                  
                  // Force table refresh with empty state handling
                  if (originalCampaigns.length === 0) {
                    const tableBody = document.getElementById('campaigns-table-body');
                    if (tableBody) {
                      tableBody.innerHTML = '<tr><td colspan="20" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
                    }
                  }
                  
                  // Refresh the table
                  displayCampaignsTable(originalCampaigns);
                  
                  // Update campaigns count
                  const campaignsCount = document.getElementById('campaigns-count');
                  if (campaignsCount) {
                    campaignsCount.textContent = originalCampaigns.length;
                  }
                  
                  // Clear the input field for next deletion
                  document.getElementById('deleteCampaignCodeInput').value = '';
                  
                  // Keep result message hidden (no need to show success message below input)
                  resultMsg.classList.add('hidden');
                  
                  console.log('Campaign deleted, campaigns remaining:', originalCampaigns.length);
                  alert('Campaign deleted successfully!');
                } else {
                  const error = await response.json();
                  resultMsg.textContent = `Failed to delete campaign: ${error.error || 'Unknown error'}`;
                  resultMsg.className = 'text-red-700 mt-4';
                  resultMsg.classList.remove('hidden');
                  alert(`Failed to delete campaign: ${error.error || 'Unknown error'}`);
                }
              } catch (error) {
                resultMsg.textContent = 'Failed to delete campaign. Please try again.';
                resultMsg.className = 'text-red-700 mt-4';
                resultMsg.classList.remove('hidden');
                alert('Failed to delete campaign. Please try again.');
              } finally {
                deleteManualBtn.textContent = 'Delete Campaign';
                deleteManualBtn.disabled = false;
              }
            });
          }
          // Don't show delete input by default - wait for user interaction
          setDeleteCampaignInputVisibility(false);
          document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'selected_campaign') {
              setDeleteCampaignInputVisibility(false);
            }
          });
        });
      </script>
    </div>
  </div>

  <script>
    function updateChannelFields(select) {
      const entry = select.closest('.channelEntry');
      const fieldsDiv = entry.querySelector('.channelFields');
      const type = select.value;

      // Clear existing fields
      fieldsDiv.innerHTML = '';

      // If no channel type selected, show message and disable all inputs
      if (!type) {
        fieldsDiv.innerHTML = `
          <div class="col-span-4 flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-md">
            <p class="text-gray-500 text-sm">Please select a channel type to configure fields</p>
          </div>
        `;
        return;
      }

      let html = '';
      if (type === 'Outdoor Events') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Venue</label>
            <input type="text" class="channelVenue p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Print Media') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Platform</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Platform</option>
              <option value="Newspaper">Newspaper</option>
              <option value="Magazine">Magazine</option>
              <option value="Flyers">Flyers</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Publication</label>
            <input type="text" class="channelPublication p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Area</label>
            <input type="text" class="channelArea p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // Add platform validation for Print Media
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.addEventListener('change', function() {
              const platform = this.value;
              const allInputs = entry.querySelectorAll('input, select');
              const isPlatformSelected = platform && platform !== '';
              
              allInputs.forEach(input => {
                if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                  input.disabled = !isPlatformSelected;
                  if (!isPlatformSelected) {
                    input.value = '';
                    input.classList.add('bg-gray-100');
                  } else {
                    input.classList.remove('bg-gray-100');
                  }
                }
              });
              
              // Auto-generate tag when platform is selected
              if (isPlatformSelected) {
                // Create a temporary button element to pass the correct entry reference
                const tempButton = document.createElement('button');
                tempButton.style.display = 'none';
                entry.appendChild(tempButton);
                generateTagNumber(tempButton);
                entry.removeChild(tempButton);
              }
            });
          }
        }, 100);
      } else if (type === 'Social Media') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Platform</label>
            <select class="channelPlatform p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              <option value="">Select Platform</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="TikTok">TikTok</option>
              <option value="Google">Google</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
                            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" required disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" min="0" required disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Type</label>
            <select class="channelAdType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" disabled required></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-100" placeholder="0" disabled>
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
        // After rendering, set the ad type dropdown based on platform and add platform validation
        setTimeout(() => {
          const platformSelect = entry.querySelector('.channelPlatform');
          const adTypeSelect = entry.querySelector('.channelAdType');
          function updateAdTypeDropdown() {
            const platform = platformSelect.value;
            
            // Disable all input fields if no platform selected
            const allInputs = entry.querySelectorAll('input, select');
            const isPlatformSelected = platform && platform !== '';
            
            allInputs.forEach(input => {
              if (input !== platformSelect && input !== entry.querySelector('.channelType')) {
                input.disabled = !isPlatformSelected;
                if (!isPlatformSelected) {
                  input.value = '';
                  input.classList.add('bg-gray-100');
                } else {
                  input.classList.remove('bg-gray-100');
                }
              }
            });
            
            let options = '';
            if (platform === 'Instagram') {
              options = `
                <option value="">Select Type *</option>
                <option value="Instagram Post">Instagram Post</option>
                <option value="Instagram Video">Instagram Video</option>
                <option value="Instagram Live Video">Instagram Live Video</option>
                <option value="Instagram Photo Ad">Instagram Photo Ad</option>
                <option value="Instagram Story Ad">Instagram Story Ad</option>
                <option value="Instagram Reel Ad">Instagram Reel Ad</option>
                <option value="Instagram Carousel Ad">Instagram Carousel Ad</option>
                <option value="Instagram Explore Page Ad">Instagram Explore Page Ad</option>
                <option value="Instagram Giveaway Contest">Instagram Giveaway Contest</option>
                <option value="Instagram Influencer Collaboration">Instagram Influencer Collaboration</option>
                <option value="Instagram Shop Product Tag">Instagram Shop Product Tag</option>
                <option value="Instagram Poll or Quiz Post">Instagram Poll or Quiz Post</option>
                <option value="Instagram Click-to-WhatsApp Ad">Instagram Click-to-WhatsApp Ad</option>
                <option value="Other">Other</option>
              `;
            } else if (platform === 'Facebook') {
              options = `
                <option value="">Select Type *</option>
                <option value="Facebook Post">Facebook Post</option>
                <option value="Facebook Video">Facebook Video</option>
                <option value="Facebook Live Video">Facebook Live Video</option>
                <option value="Facebook Feed Ad">Facebook Feed Ad</option>
                <option value="Facebook Story Ad">Facebook Story Ad</option>
                <option value="Facebook Video Ad">Facebook Video Ad</option>
                <option value="Facebook Carousel Ad">Facebook Carousel Ad</option>
                <option value="Facebook Collection Ad">Facebook Collection Ad</option>
                <option value="Facebook Lead Ad">Facebook Lead Ad</option>
                <option value="Facebook Event Ad">Facebook Event Ad</option>
                <option value="Facebook Page Like Ad">Facebook Page Like Ad</option>
                <option value="Facebook App Install Ad">Facebook App Install Ad</option>
                <option value="Facebook Messenger Ad">Facebook Messenger Ad</option>
                <option value="Other">Other</option>
              `;
            } else if (platform === 'TikTok') {
              options = `
                <option value="">Select Type *</option>
                <option value="TikTok Post">TikTok Post</option>
                <option value="TikTok Video">TikTok Video</option>
                <option value="TikTok Live Video">TikTok Live Video</option>
                <option value="TikTok In-Feed Ad">TikTok In-Feed Ad</option>
                <option value="TikTok TopView Ad">TikTok TopView Ad</option>
                <option value="TikTok Branded Hashtag Challenge">TikTok Branded Hashtag Challenge</option>
                <option value="TikTok Branded Effect">TikTok Branded Effect</option>
                <option value="TikTok Collection Ad">TikTok Collection Ad</option>
                <option value="TikTok Dynamic Showcase Ad">TikTok Dynamic Showcase Ad</option>
                <option value="TikTok Spark Ad">TikTok Spark Ad</option>
                <option value="TikTok Video Shopping Ad">TikTok Video Shopping Ad</option>
                <option value="Other">Other</option>
              `;
            } else if (platform === 'Google') {
              options = `
                <option value="">Select Type</option>
                <option value="Google Search Ad">Google Search Ad</option>
                <option value="Google Display Ad">Google Display Ad</option>
                <option value="Google Shopping Ad">Google Shopping Ad</option>
                <option value="Google Video Ad">Google Video Ad</option>
                <option value="Google App Ad">Google App Ad</option>
                <option value="Google Local Ad">Google Local Ad</option>
                <option value="Google Smart Display Ad">Google Smart Display Ad</option>
                <option value="Google Responsive Search Ad">Google Responsive Search Ad</option>
                <option value="Google Performance Max">Google Performance Max</option>
                <option value="Other">Other</option>
              `;
            } else if (platform === 'Other') {
              options = `
                <option value="">Select Type</option>
                <option value="Other">Other</option>
              `;
            }
            adTypeSelect.innerHTML = options;
            
            // Add validation for mandatory Type selection for Instagram, Facebook, and TikTok
            if (platform === 'Instagram' || platform === 'Facebook' || platform === 'TikTok') {
              adTypeSelect.required = true;
              adTypeSelect.classList.add('border-red-500');
              adTypeSelect.addEventListener('change', function() {
                if (this.value && this.value !== '') {
                  this.classList.remove('border-red-500');
                  this.classList.add('border-green-500');
                } else {
                  this.classList.remove('border-green-500');
                  this.classList.add('border-red-500');
                }
              });
            } else {
              adTypeSelect.required = false;
              adTypeSelect.classList.remove('border-red-500', 'border-green-500');
            }
          }
          platformSelect.addEventListener('change', updateAdTypeDropdown);
          updateAdTypeDropdown();
          
          // Auto-generate tag when platform is selected
          platformSelect.addEventListener('change', function() {
            if (this.value && this.value.trim() !== '') {
              // Create a temporary button element to pass the correct entry reference
              const tempButton = document.createElement('button');
              tempButton.style.display = 'none';
              entry.appendChild(tempButton);
              generateTagNumber(tempButton);
              entry.removeChild(tempButton);
            }
          });
        }, 100);
      } else if (type === 'TV') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Network</label>
            <input type="text" class="channelNetwork p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Email' || type === 'Message') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Qty</label>
            <input type="number" class="channelQty p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Radio') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Station</label>
            <input type="text" class="channelStation p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Description</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Start Date</label>
            <input type="date" class="channelStartDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">End Date</label>
            <input type="date" class="channelEndDate p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Promotional Items') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Item Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Promotional Offer') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Offer Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      } else if (type === 'Other') {
        html = `
          <div>
            <label class="block text-sm font-medium text-purple-700">Name</label>
            <input type="text" class="channelAdName p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Cost (AED)</label>
            <input type="number" class="channelCost p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Impressions</label>
            <input type="number" class="channelImpressions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Conversions</label>
            <input type="number" class="channelConversions p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-purple-700">Tag Number</label>
            <input type="text" class="channelTagNumber p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full bg-gray-50" placeholder="Auto-generated" readonly>
          </div>
        `;
      }

      // Insert new fields
      fieldsDiv.innerHTML = html;
      
      // Auto-generate tag for channel types that don't require platform selection
      if (type && type !== 'Social Media' && type !== 'Print Media') {
        setTimeout(() => {
          // Create a temporary button element to pass the correct entry reference
          const tempButton = document.createElement('button');
          tempButton.style.display = 'none';
          entry.appendChild(tempButton);
          generateTagNumber(tempButton);
          entry.removeChild(tempButton);
        }, 100);
      }
      // Set initial placeholder for tag input
      setTimeout(() => {
        const tagInput = entry.querySelector('.channelTagNumber');
        if (tagInput) {
          tagInput.placeholder = 'Auto-generated';
        }
      }, 0);

      // Remove button is handled in the main channel entry structure
      // No need to create additional remove buttons here
    }

    function addChannelEntry() {
      const container = document.getElementById('channelContainer');
      const entry = document.createElement('div');
      entry.className = 'channelEntry grid grid-cols-7 gap-2 items-end mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50';
      entry.innerHTML = `
        <div class="col-span-1">
          <label class="block text-sm font-medium text-purple-700">Channel Type</label>
          <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
            <option value="">Select Channel</option>
            <option value="Social Media">Social Media</option>
            <option value="Print Media">Print Media</option>
            <option value="Outdoor Events">Outdoor Events</option>
            <option value="Email">Email</option>
            <option value="Message">Message</option>
            <option value="Radio">Radio</option>
            <option value="TV">TV</option>
            <option value="Promotional Items">Promotional Items</option>
            <option value="Promotional Offer">Promotional Offer</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
                    <div class="col-span-1 flex items-center justify-center">
              <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
                Remove
              </button>
            </div>
      `;
      container.appendChild(entry);
    }

    function removeChannelEntry(button) {
      const entry = button.closest('.channelEntry');
      if (entry) entry.remove();
      // If no channel entries left, add a new one
      const container = document.getElementById('channelContainer');
      if (container.children.length === 0) {
        addChannelEntry();
      }
    }

    async function submitCampaign() {
      console.log('Submit button clicked - starting validation...');
      
      // Validate category selection
      const categoryContainer = document.getElementById('targetCategoryContainer');
      const categorySelects = categoryContainer.querySelectorAll('.targetCategory');
      console.log('Found category selects:', categorySelects.length);
      
      // All dropdowns must be selected (not empty)
      const allCategoriesSelected = Array.from(categorySelects).every(select => select.value && select.value.trim() !== '');
      console.log('All categories selected:', allCategoriesSelected);
      
      if (!allCategoriesSelected) {
        alert('‚ö†Ô∏è Warning: Please select a category for every row before submitting the campaign.');
        return;
      }
      
      // Validate Status (mandatory)
      const status = document.getElementById('status').value;
      if (!status || status.trim() === '') {
        alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this campaign.');
        return;
      }
      
      // Validate Work Start Date (mandatory only when status is "Planned")
      const workStartDate = document.getElementById('workStartDate').value;
      if (status === 'Planned' && (!workStartDate || workStartDate.trim() === '')) {
        alert('‚ö†Ô∏è Warning: Work Start Date is mandatory when status is "Planned". Please select a date when the team started working on this campaign.');
        return;
      }
      
      // Validate Type selection for Instagram, Facebook, and TikTok platforms
      const channelEntries = document.querySelectorAll('.channelEntry');
      console.log('Found channel entries:', channelEntries.length);
      
      for (const entry of channelEntries) {
        const type = entry.querySelector('.channelType').value;
        console.log('Channel type:', type);
        
        if (type === 'Social Media') {
          const platform = entry.querySelector('.channelPlatform').value;
          const adType = entry.querySelector('.channelAdType').value;
          console.log('Platform:', platform, 'AdType:', adType);
          
          if ((platform === 'Instagram' || platform === 'Facebook' || platform === 'TikTok') && (!adType || adType.trim() === '')) {
            console.log('Validation failed for platform:', platform);
            alert(`‚ö†Ô∏è Warning: Please select a Type for ${platform} platform. Type selection is mandatory for social media campaigns.`);
            return;
          }
        }
      }
      
      const channels = Array.from(channelEntries).map(entry => {
        const type = entry.querySelector('.channelType').value;
        if (type === 'Social Media') {
          const impressionsValue = entry.querySelector('.channelImpressions')?.value;
          console.log('Social Media impressions raw value:', impressionsValue, 'parsed:', parseInt(impressionsValue) || 0);
          return {
            type,
            platform: entry.querySelector('.channelPlatform').value,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            adType: entry.querySelector('.channelAdType').value,
            impressions: parseInt(impressionsValue) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'TV' || type === 'Radio') {
          return {
            type,
            network: entry.querySelector('.channelNetwork')?.value,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            startDate: entry.querySelector('.channelStartDate')?.value,
            endDate: entry.querySelector('.channelEndDate')?.value,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Print Media') {
          return {
            type,
            platform: entry.querySelector('.channelPlatform').value,
            publication: entry.querySelector('.channelPublication').value,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            startDate: entry.querySelector('.channelStartDate').value,
            endDate: entry.querySelector('.channelEndDate').value,
            area: entry.querySelector('.channelArea').value,
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Email' || type === 'Message') {
          return {
            type,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            qty: parseInt(entry.querySelector('.channelQty').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Outdoor Events') {
          return {
            type,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            venue: entry.querySelector('.channelVenue').value,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Promotional Items') {
          return {
            type,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Promotional Offer') {
          return {
            type,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        } else if (type === 'Other') {
          return {
            type,
            adName: entry.querySelector('.channelAdName').value,
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0,
            impressions: parseInt(entry.querySelector('.channelImpressions')?.value) || 0,
            conversions: parseInt(entry.querySelector('.channelConversions')?.value) || 0,
            tagNumber: entry.querySelector('.channelTagNumber')?.value || '',
          };
        }
        return null;
      }).filter(channel => channel);

      const catContainer = document.getElementById('targetCategoryContainer');
      const selects = catContainer.querySelectorAll('.targetCategory');
      const tags = catContainer.querySelectorAll('.categoryTag');
      const categories = Array.from(selects).map((sel, idx) => {
        return {
          category: sel.value,
          tag: tags[idx] ? tags[idx].value : ''
        };
      }).filter(obj => obj.category);

      const campaignData = {
        // campaignId will be assigned by the backend persistent counter
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        workStartDate: document.getElementById('workStartDate').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        budget: parseFloat(document.getElementById('budget').value) || 0,
        status: document.getElementById('status').value,
        targetAudience: {
          age: document.getElementById('targetAge').value,
          gender: document.getElementById('targetGender').value,
          categories: categories
        },
        goals: {
          sales: parseFloat(document.getElementById('goalSales').value) || 0,
          impressions: parseFloat(document.getElementById('goalImpressions').value) || 0,
          conversions: parseFloat(document.getElementById('goalConversions').value) || 0,
        },
        achieved: {
          sales: parseFloat(document.getElementById('achievedSales').value) || 0,
          impressions: parseFloat(document.getElementById('achievedImpressions').value) || 0,
          conversions: parseFloat(document.getElementById('achievedConversions').value) || 0,
        },
        channels,
      };
      
      console.log('=== FINAL CAMPAIGN DATA BEFORE SUBMISSION ===');
      console.log('Campaign data:', JSON.stringify(campaignData, null, 2));
      console.log('Channels with impressions:', channels.map(ch => ({ type: ch.type, platform: ch.platform, impressions: ch.impressions })));

      try {
        const response = await fetch('/api/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(campaignData),
        });
        const result = await response.json();
        if (response.ok) {
          // Display the campaignId assigned by the backend
          document.getElementById('campaignId').value = result.campaignId;
          alert(result.message);
          clearForm();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function clearForm() {
      // Clear basic fields
      document.getElementById('name').value = '';
      document.getElementById('description').value = '';
      document.getElementById('workStartDate').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('budget').value = '';
      document.getElementById('status').value = '';
      
      // Clear campaignId field - it will be assigned by backend
      document.getElementById('campaignId').value = '';

      // Clear target audience
      document.getElementById('targetAge').value = '';
      document.getElementById('targetGender').value = 'All';
      const catContainer = document.getElementById('targetCategoryContainer');
      if (catContainer) {
        catContainer.innerHTML = '';
        // Add one empty select
        const div = document.createElement('div');
        div.className = 'targetCategorySelect mb-2 flex items-center gap-2';
        div.innerHTML = `<select class="targetCategory w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="">Select Category</option>
          <option>Tourist</option>
          <option>Resident</option>
          <option>All Walkin</option>
          <option>Social Media</option>
          <option>Social Groups</option>
          <option>Corporates</option>
          <option>Residential Cmty</option>
          <option>Local Cmty</option>
          <option>Blue collar wrkrs</option>
          <option>Existing cutomers</option>
          <option>HNTW</option>
          <option>Channel Partner</option>
          <option>DGJG</option>
          <option>Hotels</option>
          <option>Tourism Companies</option>
          <option>Tour Drivers</option>
          <option>Other Tours Assctd cmpy</option>
          <option>Festival & Occasion Buyers</option>
          <option>Product Launch</option>
          <option>Other</option>
        </select><input type="text" class="categoryTag w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Category Tag (optional)"><button type="button" class="removeCategoryBtn hidden text-red-500">‚úï</button>`;
        catContainer.appendChild(div);
      }

      // Clear goals
      document.getElementById('goalSales').value = '';
      document.getElementById('goalImpressions').value = '';
      document.getElementById('goalConversions').value = '';

      // Clear achieved
      document.getElementById('achievedSales').value = '';
      document.getElementById('achievedImpressions').value = '';
      document.getElementById('achievedConversions').value = '';

      // Clear channels
      const channelContainer = document.getElementById('channelContainer');
      channelContainer.innerHTML = '';
      addChannelEntry(); // Add one empty channel entry
    }

    // Function to query selected campaign (new radio-based approach)
    window.querySelectedCampaign = async function(campaignId) {
      console.log('querySelectedCampaign function called');
      let idToUse = campaignId;
      if (!idToUse) {
        const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
        if (!selectedRadio) {
          console.log('No campaign selected');
          alert('Please select a campaign from the Campaigns Table first.');
          // Reset the indicator
          const indicator = document.getElementById('campaign-selected-indicator');
          const instructions = document.getElementById('query-instructions');
          if (indicator && instructions) {
            indicator.classList.add('hidden');
            instructions.classList.remove('hidden');
          }
          return;
        }
        idToUse = selectedRadio.value;
      }
      const queryCampaignForm = document.getElementById('queryCampaignForm');
      if (!queryCampaignForm) {
        console.error('queryCampaignForm element not found');
        return;
      }
      // Check if originalCampaigns is available
      if (!originalCampaigns || !Array.isArray(originalCampaigns)) {
        console.error('originalCampaigns is not available or not an array');
        console.log('originalCampaigns:', originalCampaigns);
        return;
      }
      console.log('originalCampaigns length:', originalCampaigns.length);
      console.log('Looking for campaign with ID:', idToUse);
      // Find the campaign in original data
      const campaign = originalCampaigns.find(c => c._id === idToUse);
      if (!campaign) {
        console.log('Campaign not found in original data');
        console.log('Available campaign IDs:', originalCampaigns.map(c => c._id));
        return;
      }
      console.log('Found campaign:', campaign);
      try {
        // Use the campaign data directly instead of making an API call
        const result = campaign;
        // Show the queryCampaignForm div
        queryCampaignForm.classList.remove('hidden');
        // Show the Download as Excel button
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.remove('hidden');
        // Create plain text description layout
        let formHTML = `
          <div class="space-y-4">
            <!-- Campaign ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Campaign ID</label>
                <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Campaign Name</label>
                <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
              </div>
            </div>
            <!-- Offers -->
            <div>
              <label class="block text-sm font-medium text-purple-700">Offers</label>
              <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
            </div>
            <!-- Work Start Date, Start Date and End Date -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Work Start Date</label>
                <p class="text-base text-gray-900">${result.workStartDate ? new Date(result.workStartDate).toLocaleDateString() : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Start Date</label>
                <p class="text-base text-gray-900">${result.startDate ? new Date(result.startDate).toLocaleDateString() : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">End Date</label>
                <p class="text-base text-gray-900">${result.endDate ? new Date(result.endDate).toLocaleDateString() : 'N/A'}</p>
              </div>
            </div>
            <!-- Budget and Status -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Budget (AED)</label>
                <p class="text-base text-gray-900">${result.budget ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.budget) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Status</label>
                <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
              </div>
            </div>
            <!-- Target Audience -->
            ${result.targetAudience ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Target Audience</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-purple-700">Age</label>
                  <p class="text-base text-gray-900">${result.targetAudience.age || 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Gender</label>
                  <p class="text-base text-gray-900">${result.targetAudience.gender || 'N/A'}</p>
                </div>
              </div>
              <!-- Category Section - Full Width -->
              <div class="mt-4">
                <label class="block text-sm font-medium text-purple-700 mb-2">Category</label>
                <p class="text-base text-gray-900">${result.targetAudience.categories && result.targetAudience.categories.length > 0 ? result.targetAudience.categories.map(obj => `${obj.category} (${obj.tag})`).join(', ') : 'N/A'}</p>
              </div>
            </div>` : ''}
            <!-- Goals -->
            ${result.goals ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Goals</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-purple-700">Sales (AED)</label>
                  <p class="text-base text-gray-900">${result.goals.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.goals.sales) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Impressions</label>
                  <p class="text-base text-gray-900">${result.goals.impressions ? new Intl.NumberFormat().format(result.goals.impressions) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-purple-700">Conversions</label>
                  <p class="text-base text-gray-900">${result.goals.conversions ? new Intl.NumberFormat().format(result.goals.conversions) : 'N/A'}</p>
                </div>
              </div>
            </div>` : ''}

            <!-- Achieved -->
            ${result.achieved ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-green-600 mb-2">üéØ Achieved</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-green-700">Sales (AED)</label>
                  <p class="text-base text-green-900">${result.achieved.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.achieved.sales) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-green-700">Impressions</label>
                  <p class="text-base text-green-900">${result.achieved.impressions ? new Intl.NumberFormat().format(result.achieved.impressions) : 'N/A'}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-green-700">Conversions</label>
                  <p class="text-base text-green-900">${result.achieved.conversions ? new Intl.NumberFormat().format(result.achieved.conversions) : 'N/A'}</p>
                </div>
              </div>
            </div>` : ''}

            <!-- Channels -->
            ${result.channels && result.channels.length > 0 ? `
            <div class="border-t pt-4">
              <h3 class="text-md font-medium text-purple-600 mb-2">Channels</h3>
              <div class="space-y-4">
                ${result.channels.map((channel, index) => `
                  <div class="channelEntry grid grid-cols-6 gap-2 items-end">
                    <div class="col-span-1">
                      <label class="block text-sm font-medium text-purple-700">Channel Type</label>
                      <p class="text-base text-gray-900">${channel.type || 'N/A'}</p>
                    </div>
                    <div class="channelFields grid grid-cols-4 gap-2 col-span-4">
                      <div>
                        <label class="block text-sm font-medium text-purple-700">${channel.type === 'Social Media' ? 'Name' : 'Description'}</label>
                        <p class="text-base text-gray-900">${channel.adName || 'N/A'}</p>
                      </div>
                      ${channel.platform ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Platform</label>
                        <p class="text-base text-gray-900">${channel.platform}</p>
                      </div>` : ''}
                      ${channel.network ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Network</label>
                        <p class="text-base text-gray-900">${channel.network}</p>
                      </div>` : ''}
                      ${channel.publication ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Publication</label>
                        <p class="text-base text-gray-900">${channel.publication}</p>
                      </div>` : ''}
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Cost</label>
                        <p class="text-base text-gray-900">${channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A'}</p>
                      </div>
                      ${channel.adType ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Type</label>
                        <p class="text-base text-gray-900">${channel.adType}</p>
                      </div>` : ''}
                      ${channel.qty ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Quantity</label>
                        <p class="text-base text-gray-900">${channel.qty}</p>
                      </div>` : ''}
                      ${channel.impressions ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Impressions</label>
                        <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.impressions)}</p>
                      </div>` : ''}
                      ${channel.conversions ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Conversions</label>
                        <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.conversions)}</p>
                      </div>` : ''}
                      ${channel.tagNumber ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Tag Number</label>
                        <p class="text-base text-gray-900 font-mono bg-yellow-100 px-2 py-1 rounded">${channel.tagNumber}</p>
                      </div>` : ''}
                      ${channel.startDate ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">Start Date</label>
                        <p class="text-base text-gray-900">${new Date(channel.startDate).toLocaleDateString()}</p>
                      </div>` : ''}
                      ${channel.endDate ? `
                      <div>
                        <label class="block text-sm font-medium text-purple-700">End Date</label>
                        <p class="text-base text-gray-900">${new Date(channel.endDate).toLocaleDateString()}</p>
                      </div>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>` : ''}
          </div>`;
        queryCampaignForm.innerHTML = formHTML;
        console.log('Query successful, form displayed.');
      } catch (err) {
        if (queryCampaignForm) {
          queryCampaignForm.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">Error: ${err.message}</p>
            </div>`;
          queryCampaignForm.classList.remove('hidden');
        }
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
      console.log('querySelectedCampaign function finished.');
    }

    // Debug function to check selected campaign
    window.checkSelectedCampaign = function() {
      console.log('=== DEBUG: Checking Selected Campaign ===');
      const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
      console.log('Selected radio:', selectedRadio);
      
      if (selectedRadio) {
        console.log('Selected campaign ID:', selectedRadio.value);
        console.log('originalCampaigns available:', !!originalCampaigns);
        console.log('originalCampaigns length:', originalCampaigns ? originalCampaigns.length : 'N/A');
        
        if (originalCampaigns) {
          const campaign = originalCampaigns.find(c => c._id === selectedRadio.value);
          console.log('Found campaign in data:', !!campaign);
          if (campaign) {
            console.log('Campaign name:', campaign.name);
            console.log('Campaign ID:', campaign.campaignId);
          }
        }
      } else {
        console.log('No campaign selected');
      }
      
      console.log('querySelectedCampaign function exists:', typeof window.querySelectedCampaign);
      console.log('=== END DEBUG ===');
    };

    // Keep the old function for backward compatibility (but it's no longer used)
    async function queryCampaign() {
      
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        
        if (response.ok) {
          // Show the queryResult div
          queryResult.classList.remove('hidden');
          // Show the Download as Excel button
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.remove('hidden');
          let formattedResult = `
            <div class="space-y-6">
              <!-- Basic Information -->
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Campaign Information</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Campaign ID</p>
                    <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Name</p>
                    <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Status</p>
                    <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Budget</p>
                    <p class="text-base text-gray-900">${result.budget ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.budget) : 'N/A'}</p>
                  </div>
                </div>
                <div class="mt-3">
                  <p class="text-sm font-medium text-gray-600">Offers</p>
                  <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Work Start Date</p>
                    <p class="text-base text-gray-900">${result.workStartDate ? new Date(result.workStartDate).toLocaleDateString() : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Start Date</p>
                    <p class="text-base text-gray-900">${result.startDate ? new Date(result.startDate).toLocaleDateString() : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">End Date</p>
                    <p class="text-base text-gray-900">${result.endDate ? new Date(result.endDate).toLocaleDateString() : 'N/A'}</p>
                  </div>
                </div>
              </div>

              <!-- Target Audience -->
              ${result.targetAudience ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Target Audience</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Age</p>
                    <p class="text-base text-gray-900">${result.targetAudience.age || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Gender</p>
                    <p class="text-base text-gray-900">${result.targetAudience.gender || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Category</p>
                    <p class="text-base text-gray-900">${result.targetAudience.categories.map(obj => `${obj.category} (${obj.tag})`).join(', ') || 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Goals -->
              ${result.goals ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Campaign Goals</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Sales Target</p>
                    <p class="text-base text-gray-900">${result.goals.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.goals.sales) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Target Impressions</p>
                    <p class="text-base text-gray-900">${result.goals.impressions ? new Intl.NumberFormat().format(result.goals.impressions) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Target Conversions</p>
                    <p class="text-base text-gray-900">${result.goals.conversions ? new Intl.NumberFormat().format(result.goals.conversions) : 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Achieved -->
              ${result.achieved ? `
              <div class="bg-white p-4 rounded-lg border border-green-200">
                <h4 class="text-lg font-semibold text-green-700 mb-3">üéØ Campaign Achievements</h4>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Sales Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.sales ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(result.achieved.sales) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Impressions Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.impressions ? new Intl.NumberFormat().format(result.achieved.impressions) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Conversions Achieved</p>
                    <p class="text-base text-green-900">${result.achieved.conversions ? new Intl.NumberFormat().format(result.achieved.conversions) : 'N/A'}</p>
                  </div>
                </div>
              </div>` : ''}

              <!-- Channels -->
              ${result.channels && result.channels.length > 0 ? `
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Marketing Channels</h4>
                <div class="space-y-4">
                  ${result.channels.map((channel, index) => `
                    <div class="${index > 0 ? 'border-t pt-4' : ''}">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <p class="text-sm font-medium text-gray-600">Channel Type</p>
                          <p class="text-base text-gray-900">${channel.type || 'N/A'}</p>
                        </div>
                        <div>
                          <p class="text-sm font-medium text-gray-600">${channel.type === 'Social Media' ? 'Name' : 'Description'}</p>
                          <p class="text-base text-gray-900">${channel.adName || 'N/A'}</p>
                        </div>
                        ${channel.platform ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Platform</p>
                          <p class="text-base text-gray-900">${channel.platform}</p>
                        </div>` : ''}
                        ${channel.network ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Network</p>
                          <p class="text-base text-gray-900">${channel.network}</p>
                        </div>` : ''}
                        ${channel.publication ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Publication</p>
                          <p class="text-base text-gray-900">${channel.publication}</p>
                        </div>` : ''}
                        <div>
                          <p class="text-sm font-medium text-gray-600">Cost</p>
                          <p class="text-base text-gray-900">${channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A'}</p>
                        </div>
                        ${channel.adType ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Type</p>
                          <p class="text-base text-gray-900">${channel.adType}</p>
                        </div>` : ''}
                        ${channel.qty ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Quantity</p>
                          <p class="text-base text-gray-900">${channel.qty}</p>
                        </div>` : ''}
                        ${channel.impressions ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Impressions</p>
                          <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.impressions)}</p>
                        </div>` : ''}
                        ${channel.conversions ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Conversions</p>
                          <p class="text-base text-gray-900">${new Intl.NumberFormat().format(channel.conversions)}</p>
                        </div>` : ''}
                        ${channel.tagNumber ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Tag Number</p>
                          <p class="text-base text-gray-900 font-mono bg-yellow-100 px-2 py-1 rounded">${channel.tagNumber}</p>
                        </div>` : ''}
                        ${channel.startDate ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">Start Date</p>
                          <p class="text-base text-gray-900">${new Date(channel.startDate).toLocaleDateString()}</p>
                        </div>` : ''}
                        ${channel.endDate ? `
                        <div>
                          <p class="text-sm font-medium text-gray-600">End Date</p>
                          <p class="text-base text-gray-900">${new Date(channel.endDate).toLocaleDateString()}</p>
                        </div>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>` : ''}
            </div>`;

          queryResult.innerHTML = formattedResult;
          queryResult.classList.remove('hidden');
          console.log('Query successful, result displayed.');
        } else {
          queryResult.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">${result.error}</p>
            </div>`;
          queryResult.classList.remove('hidden');
          console.warn('Query failed, displaying error:', result.error);
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.add('hidden');
        }
      } catch (err) {
        queryResult.innerHTML = `
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <p class="text-red-700">Error: ${err.message}</p>
          </div>`;
        queryResult.classList.remove('hidden');
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
        console.log('queryCampaign function finished.');
    }

    function exportCampaigns() {
      console.log('exportCampaigns function called');
      window.location.href = '/api/campaigns/export';
       console.log('exportCampaigns function finished.');
    }

    // Campaign ID will be assigned by the backend persistent counter
    // No need to pre-generate IDs on the frontend

    // Unified navigation function for all sections
    function showSection(sectionId) {
      console.log(`Attempting to show section: ${sectionId}`);
      // Hide all sections and clear their content where necessary
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
        // Clear content for specific sections
        if (section.id === 'query-campaign') {
          console.log('Clearing query section content');
          const queryIdElement = section.querySelector('#queryCampaignId');
          if (queryIdElement) queryIdElement.value = '';
          const resultContainer = section.querySelector('#queryResultContainer');
          if (resultContainer) resultContainer.innerHTML = '';
          const filterContainer = section.querySelector('#queryFilterContainer');
          if (filterContainer) filterContainer.innerHTML = '';
        } else if (section.id === 'new-campaign') {
          console.log('Clearing new campaign form');
          const form = section.querySelector('form');
          if (form) form.reset();
          // Clear campaignId field - it will be assigned by backend
          const campaignIdField = document.getElementById('campaignId');
          if (campaignIdField) campaignIdField.value = '';
          // Reset categories
          const categoriesContainer = document.getElementById('categoriesContainer');
          if (categoriesContainer) categoriesContainer.innerHTML = '';
          // Re-add initial category input
          if (typeof addCategory === 'function') addCategory();
        }
      });
      
      // Show the requested section
      const sectionToShow = document.getElementById(sectionId);
      if (sectionToShow) {
        console.log(`Found section: ${sectionId}`);
        // Special handling for delete section - check permissions
        if (sectionId === 'delete-campaign') {
          if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
            console.log('Permission denied for delete-campaign section');
            return;
          }
        }
        sectionToShow.classList.remove('hidden');
      } else {
        console.error(`Section ${sectionId} not found`);
      }
      
      // Take specific actions based on section
      if (sectionId === 'campaigns-table') {
        // Auto-load campaigns when table section is shown
        if (typeof loadCampaignsTable === 'function') loadCampaignsTable();
      } else if (sectionId === 'new-campaign') {
        // Reset the form
        const form = document.querySelector('#new-campaign form');
        if (form) form.reset();
        // Clear campaignId field - it will be assigned by backend
        const campaignIdField = document.getElementById('campaignId');
        if (campaignIdField) campaignIdField.value = '';
         // Campaign ID will be assigned by backend when form is submitted
      } else if (sectionId === 'query-campaign') {
          // Clear radio selection so manual input is shown by default
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) selectedRadio.checked = false;
          if (typeof updateQueryManualEntryVisibility === 'function') updateQueryManualEntryVisibility();
      } else if (sectionId === 'edit-campaign') {
          // Nothing needed here, load is triggered by button click
      } else if (sectionId === 'delete-campaign') {
          // Check permission before showing delete section
          if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
            alert('You do not have permission to access the delete campaign section. Only Admin users can delete campaigns.');
            return;
          }
          // Hide manual input by default
          setDeleteCampaignInputVisibility(false);
      } else if (sectionId === 'export-campaign') {
          // Nothing needed here, export is triggered by button click
      } else if (sectionId === 'impression-tracking') {
          // Auto-load stats when section is shown
          loadImpressionStats();
      }
       console.log(`Finished showing section: ${sectionId}`);
    }

    // Helper to show/hide edit campaign input section
    function setEditCampaignInputVisibility(visible) {
      const editInputSection = document.querySelector('#edit-campaign > .space-y-6 > .mb-6');
      if (editInputSection) {
        if (visible) {
          editInputSection.classList.remove('hidden');
        } else {
          editInputSection.classList.add('hidden');
        }
      }
      // Also hide the edit form if not visible
      const editForm = document.getElementById('editCampaignForm');
      if (!visible && editForm) {
        editForm.classList.remove('hidden');
      }
    }

    // Update addEditCampaignMenuFunctionality to handle both entry points
    function addEditCampaignMenuFunctionality() {
      const editMenuBtn = document.querySelector("button[onclick=\"showSection('edit-campaign')\"]");
      if (!editMenuBtn) { console.log('Edit menu button not found'); return; }
      editMenuBtn.addEventListener('click', function(event) {
        event.preventDefault();
        // Find selected campaign
        const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
        console.log('Edit menu clicked. Selected radio:', selectedRadio);
        if (selectedRadio) {
          // Edit via radio selection: hide input, show form
          const selectedCampaignId = selectedRadio.value;
          console.log('Selected campaign ID:', selectedCampaignId);
          const campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
          console.log('Found campaign:', campaign);
          if (campaign) {
            const editInput = document.getElementById('editCampaignId');
            if (editInput) editInput.value = campaign.campaignId;
            showSection('edit-campaign');
            setEditCampaignInputVisibility(false);
            loadCampaignForEditDirect(campaign);
            // Ensure the edit form is visible
            const editForm = document.getElementById('editCampaignForm');
            if (editForm) editForm.classList.remove('hidden');
            console.log('Edit form should now be visible.');
          } else {
            console.log('Campaign not found in originalCampaigns.');
          }
        } else {
          // Edit via menu: show input, hide form
          showSection('edit-campaign');
          setEditCampaignInputVisibility(true);
          const editForm = document.getElementById('editCampaignForm');
          if (editForm) editForm.classList.add('hidden');
          console.log('No campaign selected, showing input.');
        }
      });
    }

    // Update loadCampaignForEdit to prevent empty input
    async function loadCampaignForEdit() {
      const campaignId = document.getElementById('editCampaignId').value.trim();
      if (!campaignId) {
        alert('Please enter a Campaign ID.');
        return;
      }
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        if (response.ok) {
          setEditCampaignInputVisibility(false);
          loadCampaignForEditDirect(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function loadCampaignForEditDirect(campaign) {
      // Clone the new campaign form
      const newCampaignFormTemplate = document.querySelector('#new-campaign .space-y-6');
      const editFormContainer = document.getElementById('editCampaignForm');
      
      // Clear previous content
      editFormContainer.innerHTML = '';

      // Create a new form element and append cloned children
      const editForm = document.createElement('div');
      editForm.className = newCampaignFormTemplate.className; // Copy classes
      Array.from(newCampaignFormTemplate.children).forEach(child => {
          editForm.appendChild(child.cloneNode(true));
      });

      // Add hidden input for MongoDB _id
      const hiddenIdInput = document.createElement('input');
      hiddenIdInput.type = 'hidden';
      hiddenIdInput.id = 'editCampaignMongoId';
      hiddenIdInput.value = campaign._id;
      editForm.appendChild(hiddenIdInput);

      // Clear initial channel entries from cloned template
      const channelContainerInClonedForm = editForm.querySelector('#channelContainer');
      if (channelContainerInClonedForm) {
          channelContainerInClonedForm.innerHTML = '';
      }
      
      // Fill in the form with campaign data
      fillFormWithCampaignData(editForm, campaign);

      // Add one empty channel entry if campaign had none
      if (!campaign.channels || campaign.channels.length === 0) {
          addChannelEntryInEditForm(editForm);
      }

      // Modify the submit button to handle updates
      const submitButton = editForm.querySelector('button[onclick="submitCampaign()"]');
      if (submitButton) {
         submitButton.onclick = () => submitCampaignUpdate();
         submitButton.textContent = 'Update Campaign';
      }
      
      // Show the form
      editFormContainer.appendChild(editForm);
      editFormContainer.classList.remove('hidden');

      // Re-attach event listeners for channel fields in the loaded form
      editForm.querySelectorAll('.channelType').forEach(select => {
          select.onchange = () => updateChannelFields(select);
      });

       // Re-attach event listener for add channel button
       const addChannelButton = editForm.querySelector('button[onclick="addChannelEntry()"]');
        if(addChannelButton) {
            addChannelButton.onclick = () => addChannelEntryInEditForm(editForm);
        }
        
        // Re-attach category removal event listeners AFTER form data is filled
        updateRemoveCategoryBtns();
        
        // Re-attach add category button functionality for edit form
        const editAddCategoryBtn = editForm.querySelector('#addCategoryBtn');
        if (editAddCategoryBtn) {
            editAddCategoryBtn.onclick = function() {
                console.log('Add Category button clicked in edit form');
                const catContainer = editForm.querySelector('#targetCategoryContainer');
                const div = document.createElement('div');
                div.className = 'targetCategorySelect flex flex-wrap items-center gap-2';
                div.innerHTML = `<select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Select Category</option>
                    <option>Tourist</option>
                    <option>Resident</option>
                    <option>All Walkin</option>
                    <option>Social Media</option>
                    <option>Social Groups</option>
                    <option>Corporates</option>
                    <option>Residential Cmty</option>
                    <option>Local Cmty</option>
                    <option>Blue collar wrkrs</option>
                    <option>Existing cutomers</option>
                    <option>HNTW</option>
                    <option>Channel Partner</option>
                    <option>DGJG</option>
                    <option>Hotels</option>
                    <option>Tourism Companies</option>
                    <option>Tour Drivers</option>
                    <option>Other Tours Assctd cmpy</option>
                    <option>Festival & Occasion Buyers</option>
                    <option>Product Launch</option>
                </select><input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tag"><button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>`;
                catContainer.appendChild(div);
                updateRemoveCategoryBtns();
            };
        }
    }

    // A variation of addChannelEntry for the edit form to ensure correct scoping
    function addChannelEntryInEditForm(editFormElement) {
        const container = editFormElement.querySelector('#channelContainer');
        if (!container) return null;

        const entry = document.createElement('div');
        entry.className = 'channelEntry grid grid-cols-7 gap-2 items-end mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50';
        entry.innerHTML = `
          <div class="col-span-1">
            <label class="block text-sm font-medium text-purple-700">Channel Type</label>
            <select class="channelType p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" onchange="updateChannelFields(this)">
              <option value="">Select Channel</option>
              <option value="Social Media">Social Media</option>
              <option value="Print Media">Print Media</option>
              <option value="Email">Email</option>
              <option value="Message">Message</option>
              <option value="Radio">Radio</option>
              <option value="TV">TV</option>
              <option value="Outdoor Events">Outdoor Events</option>
              <option value="Promotional Items">Promotional Items</option>
              <option value="Promotional Offer">Promotional Offer</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="channelFields grid grid-cols-4 gap-2 col-span-4"></div>
          <div class="col-span-1 flex items-center justify-center">
            <button type="button" onclick="removeChannelEntry(this)" class="btn-secondary py-1 px-2 text-xs rounded-md">
              Remove
            </button>
          </div>
        `;
        // Re-attach updateChannelFields listener to the new select
         const newSelect = entry.querySelector('.channelType');
         if(newSelect) newSelect.onchange = () => updateChannelFields(newSelect);

         // Re-attach removeChannelEntry listener to the new remove button if it exists
         const removeBtn = entry.querySelector('.btn-secondary');
         if (removeBtn) {
             removeBtn.onclick = function() { removeChannelEntry(removeBtn); };
         }

        // Append the entry to the container
        container.appendChild(entry);

        return entry;
    }

    async function submitCampaignUpdate() {
      try {
        // Get the edit form
        const editForm = document.getElementById('editCampaignForm');
        
        // Validate category selection
        const editCategorySelects = editForm.querySelectorAll('.targetCategory');
        // All dropdowns must be selected (not empty)
        const allCategoriesSelected = Array.from(editCategorySelects).every(select => select.value && select.value.trim() !== '');
        if (!allCategoriesSelected) {
          alert('‚ö†Ô∏è Warning: Please select a category for every row before updating the campaign.');
          return;
        }
        
        // Validate Status (mandatory)
        const status = editForm.querySelector('#status')?.value;
        if (!status || status.trim() === '') {
          alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this campaign.');
          return;
        }
        
        // Validate Work Start Date (mandatory only when status is "Planned")
        const workStartDate = editForm.querySelector('#workStartDate')?.value;
        if (status === 'Planned' && (!workStartDate || workStartDate.trim() === '')) {
          alert('‚ö†Ô∏è Warning: Work Start Date is mandatory when status is "Planned". Please select a date when the team started working on this campaign.');
          return;
        }
        
        if (!editForm) {
          throw new Error('Edit form not found');
        }

        // Get the MongoDB _id from the hidden input
        const mongoIdInput = editForm.querySelector('#editCampaignMongoId');
        if (!mongoIdInput || !mongoIdInput.value) {
          throw new Error('Campaign ID for update not found');
        }
        const campaignId = mongoIdInput.value;

        // Gather all categories and tags
        const categorySelects = editForm.querySelectorAll('.targetCategory');
        const tagInputs = editForm.querySelectorAll('.categoryTag');
        const categories = Array.from(categorySelects).map((sel, idx) => {
          return {
            category: sel.value,
            tag: tagInputs[idx] ? tagInputs[idx].value : ''
          };
        }).filter(obj => obj.category);

        // Get all form fields
        const formData = {
          campaignId: editForm.querySelector('#campaignId')?.value || '',
          name: editForm.querySelector('#name')?.value || '',
          description: editForm.querySelector('#description')?.value || '',
          workStartDate: editForm.querySelector('#workStartDate')?.value || '',
          startDate: editForm.querySelector('#startDate')?.value || '',
          endDate: editForm.querySelector('#endDate')?.value || '',
          budget: parseFloat(editForm.querySelector('#budget')?.value) || 0,
          status: editForm.querySelector('#status')?.value || 'Active',
          targetAudience: {
            age: editForm.querySelector('#targetAge')?.value || '',
            gender: editForm.querySelector('#targetGender')?.value || 'All',
            categories: categories
          },
          goals: {
            sales: parseFloat(editForm.querySelector('#goalSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#goalImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#goalConversions')?.value) || 0,
          },
          achieved: {
            sales: parseFloat(editForm.querySelector('#achievedSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#achievedImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#achievedConversions')?.value) || 0,
          },
          channels: []
        };

        // Get channel data
        const channelEntries = editForm.querySelectorAll('.channelEntry');
        channelEntries.forEach(entry => {
          const type = entry.querySelector('.channelType').value;
          if (!type) return;

          const channelData = {
            type,
            adName: entry.querySelector('.channelAdName')?.value || '',
            cost: parseFloat(entry.querySelector('.channelCost').value) || 0
          };

          if (type === 'Social Media') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.adType = entry.querySelector('.channelAdType')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'TV' || type === 'Radio') {
            channelData.network = entry.querySelector('.channelNetwork')?.value || '';
            channelData.startDate = entry.querySelector('.channelStartDate')?.value || '';
            channelData.endDate = entry.querySelector('.channelEndDate')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Print Media') {
            channelData.platform = entry.querySelector('.channelPlatform')?.value || '';
            channelData.publication = entry.querySelector('.channelPublication')?.value || '';
            channelData.startDate = entry.querySelector('.channelStartDate')?.value || '';
            channelData.endDate = entry.querySelector('.channelEndDate')?.value || '';
            channelData.area = entry.querySelector('.channelArea')?.value || '';
            channelData.qty = parseInt(entry.querySelector('.channelQty').value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Email' || type === 'Message') {
            channelData.qty = parseInt(entry.querySelector('.channelQty')?.value) || 0;
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Outdoor Events') {
            channelData.venue = entry.querySelector('.channelVenue')?.value || '';
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Promotional Items') {
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Promotional Offer') {
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          } else if (type === 'Other') {
            channelData.impressions = parseInt(entry.querySelector('.channelImpressions')?.value) || 0;
            channelData.conversions = parseInt(entry.querySelector('.channelConversions')?.value) || 0;
            channelData.tagNumber = entry.querySelector('.channelTagNumber')?.value || '';
          }
          formData.channels.push(channelData);
        });

        // Send update request
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const result = await response.json();
        if (response.ok) {
          alert('Campaign updated successfully!');
          showSection('campaigns-table');
          // Optionally reload campaigns
        } else {
          throw new Error('Server returned an error: ' + JSON.stringify(result));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function fillFormWithCampaignData(form, campaign) {
      console.log('=== fillFormWithCampaignData called ===');
      console.log('Form element:', form);
      console.log('Campaign data:', campaign);
      console.log('Campaign structure:', {
        _id: campaign._id,
        campaignId: campaign.campaignId,
        name: campaign.name,
        targetAudience: campaign.targetAudience,
        channels: campaign.channels
      });
      
      // Fill in basic fields
      const campaignIdInput = form.querySelector('#campaignId');
      if (campaignIdInput) campaignIdInput.value = campaign.campaignId || '';
      const nameInput = form.querySelector('#name');
      if (nameInput) nameInput.value = campaign.name || '';
      const descInput = form.querySelector('#description');
      if (descInput) descInput.value = campaign.description || '';
      const workStartDateInput = form.querySelector('#workStartDate');
      if (workStartDateInput) workStartDateInput.value = campaign.workStartDate || '';
      const startDateInput = form.querySelector('#startDate');
      if (startDateInput) startDateInput.value = campaign.startDate || '';
      const endDateInput = form.querySelector('#endDate');
      if (endDateInput) endDateInput.value = campaign.endDate || '';
      const budgetInput = form.querySelector('#budget');
      if (budgetInput) budgetInput.value = campaign.budget || '';
      const statusInput = form.querySelector('#status');
      if (statusInput) {
        statusInput.value = campaign.status || '';
        
        // Add event listener for status change to validate Work Start Date
        statusInput.addEventListener('change', function() {
          const workStartDateInput = form.querySelector('#workStartDate');
          if (this.value === 'Planned' && (!workStartDateInput.value || workStartDateInput.value.trim() === '')) {
            alert('‚ö†Ô∏è Warning: Work Start Date is now required since status changed to "Planned". Please select a date when the team started working on this campaign.');
            workStartDateInput.focus();
          }
        });
      }

      // Fill in target audience
      console.log('Filling target audience...');
      console.log('Campaign targetAudience:', campaign.targetAudience);
      
      if (campaign.targetAudience) {
        const ageInput = form.querySelector('#targetAge');
        if (ageInput) {
          ageInput.value = campaign.targetAudience.age || '';
          console.log('Set age:', campaign.targetAudience.age);
        } else {
          console.log('Age input not found');
        }
        
        const genderInput = form.querySelector('#targetGender');
        if (genderInput) {
          genderInput.value = campaign.targetAudience.gender || 'All';
          console.log('Set gender:', campaign.targetAudience.gender);
        } else {
          console.log('Gender input not found');
        }
        
        const catContainer = form.querySelector('#targetCategoryContainer');
        if (catContainer) {
          console.log('Found targetCategoryContainer');
          catContainer.innerHTML = '';
          
          if (Array.isArray(campaign.targetAudience.categories)) {
            console.log('Categories array found:', campaign.targetAudience.categories);
            console.log('Number of categories:', campaign.targetAudience.categories.length);
            
            campaign.targetAudience.categories.forEach((cat, idx) => {
              console.log(`Processing category ${idx}:`, cat);
              
              const div = document.createElement('div');
              div.className = 'targetCategorySelect flex flex-wrap items-center gap-2';
              div.innerHTML = `<select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">Select Category</option>
                <option${cat.category==='Tourist'?' selected':''}>Tourist</option>
                <option${cat.category==='Resident'?' selected':''}>Resident</option>
                <option${cat.category==='All Walkin'?' selected':''}>All Walkin</option>
                <option${cat.category==='Social Media'?' selected':''}>Social Media</option>
                <option${cat.category==='Social Groups'?' selected':''}>Social Groups</option>
                <option${cat.category==='Corporates'?' selected':''}>Corporates</option>
                <option${cat.category==='Residential Cmty'?' selected':''}>Residential Cmty</option>
                <option${cat.category==='Local Cmty'?' selected':''}>Local Cmty</option>
                <option${cat.category==='Blue collar wrkrs'?' selected':''}>Blue collar wrkrs</option>
                <option${cat.category==='Existing cutomers'?' selected':''}>Existing cutomers</option>
                <option${cat.category==='HNTW'?' selected':''}>HNTW</option>
                <option${cat.category==='Hotels'?' selected':''}>Hotels</option>
                <option${cat.category==='Tourism Companies'?' selected':''}>Tourism Companies</option>
                <option${cat.category==='Tour Drivers'?' selected':''}>Tour Drivers</option>
                <option${cat.category==='Other Tours Assctd cmpy'?' selected':''}>Other Tours Assctd cmpy</option>
                <option${cat.category==='DGJG'?' selected':''}>DGJG</option>
                <option${cat.category==='Festival & Occasion Buyers'?' selected':''}>Festival & Occasion Buyers</option>
                <option${cat.category==='Product Launch'?' selected':''}>Product Launch</option>
                <option${cat.category==='Other'?' selected':''}>Other</option>
              </select><input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tag">
              <button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>`;
              
              // Set values
              const select = div.querySelector('.targetCategory');
              const tag = div.querySelector('.categoryTag');
              
              if (select) {
                select.value = cat.category || '';
                console.log(`Set category ${idx}:`, cat.category, 'in element:', select);
              } else {
                console.log(`Category select not found for index ${idx}`);
              }
              
              if (tag) {
                tag.value = cat.tag || '';
                console.log(`Set tag ${idx}:`, cat.tag, 'in element:', tag);
              } else {
                console.log(`Tag input not found for index ${idx}`);
              }
              
              catContainer.appendChild(div);
              console.log(`Category ${idx} added to container`);
            });
          } else {
            console.log('Categories is not an array or is undefined:', campaign.targetAudience.categories);
          }
        } else {
          console.log('targetCategoryContainer not found');
        }
      } else {
        console.log('No targetAudience found in campaign');
        const ageInput = form.querySelector('#targetAge');
        if (ageInput) ageInput.value = '';
        const genderInput = form.querySelector('#targetGender');
        if (genderInput) genderInput.value = 'All';
        const catInput = form.querySelector('#targetCategory');
        if (catInput) catInput.value = '';
      }

      // Fill in goals
      if (campaign.goals) {
        const salesInput = form.querySelector('#goalSales');
        if (salesInput) salesInput.value = campaign.goals.sales || '';
        const impressionsInput = form.querySelector('#goalImpressions');
        if (impressionsInput) impressionsInput.value = campaign.goals.impressions || '';
        const conversionsInput = form.querySelector('#goalConversions');
        if (conversionsInput) conversionsInput.value = campaign.goals.conversions || '';
      }

      // Fill in achieved
      if (campaign.achieved) {
        const achievedSalesInput = form.querySelector('#achievedSales');
        if (achievedSalesInput) achievedSalesInput.value = campaign.achieved.sales || '';
        const achievedImpressionsInput = form.querySelector('#achievedImpressions');
        if (achievedImpressionsInput) achievedImpressionsInput.value = campaign.achieved.impressions || '';
        const achievedConversionsInput = form.querySelector('#achievedConversions');
        if (achievedConversionsInput) achievedConversionsInput.value = campaign.achieved.conversions || '';
      }

      // Fill in channels
      const channelContainer = form.querySelector('#channelContainer');
      if (!channelContainer) {
        console.error('#channelContainer not found in form.');
        return; // Ensure container exists
      }

      channelContainer.innerHTML = '';

      if (campaign.channels && campaign.channels.length > 0) {
        campaign.channels.forEach(channel => {
          console.log('Processing channel:', channel);
          
                    // Create channel entry
          const channelEntry = addChannelEntryInEditForm(form);
          if (!channelEntry) {
            console.error('Failed to create channel entry');
            return;
          }
          
          // Set channel type first
          const typeSelect = channelEntry.querySelector('.channelType');
          if (typeSelect) {
            typeSelect.value = channel.type;
            console.log('Set channel type:', channel.type);
            
            // Update channel fields to show the correct inputs
            updateChannelFields(typeSelect);
            
            // For Social Media, we need to set platform first, then ad type
            if (channel.type === 'Social Media' && channel.platform) {
              // Wait a bit for the platform dropdown to be created
              setTimeout(() => {
                const platformSelect = channelEntry.querySelector('.channelPlatform');
                if (platformSelect) {
                  platformSelect.value = channel.platform;
                  console.log('Set platform:', channel.platform);
                  
                  // Trigger platform change to populate ad type options
                  platformSelect.dispatchEvent(new Event('change'));
                  
                  // Wait for ad type dropdown to be populated, then set the value
                  setTimeout(() => {
                    fillChannelEntryValues(channelEntry, channel);
                  }, 50);
                }
              }, 50);
            } else {
              // For non-Social Media channels, fill values immediately
              fillChannelEntryValues(channelEntry, channel);
            }
          }
          
          // Append to container after all configuration is complete
          channelContainer.appendChild(channelEntry);
          
          // Ensure the entry is visible and properly rendered
          console.log('Channel entry added to container:', channelEntry);
        });
      }

      // Ensure Add Channel button works after filling
      const addChannelButton = form.querySelector('.btn-secondary');
      if(addChannelButton && addChannelButton.textContent.includes('Add Channel')) {
        addChannelButton.onclick = () => addChannelEntryInEditForm(form);
      }
    }

    // Helper function to fill in channel entry values
    function fillChannelEntryValues(channelEntry, channel) {
      console.log('Filling channel entry values:', channel);
      console.log('Channel entry element:', channelEntry);
      
      // Fill in common fields
      const adNameInput = channelEntry.querySelector('.channelAdName');
      if (adNameInput) {
        adNameInput.value = channel.adName || '';
        console.log('Set adName:', channel.adName, 'in element:', adNameInput);
      } else {
        console.log('AdName input not found');
      }
      
      const costInput = channelEntry.querySelector('.channelCost');
      if (costInput) {
        costInput.value = channel.cost || '';
        console.log('Set cost:', channel.cost, 'in element:', costInput);
      } else {
        console.log('Cost input not found');
      }
      
      const impressionsInput = channelEntry.querySelector('.channelImpressions');
      if (impressionsInput) {
        impressionsInput.value = channel.impressions || '';
        console.log('Set impressions:', channel.impressions, 'in element:', impressionsInput);
      } else {
        console.log('Impressions input not found');
      }
      
      const conversionsInput = channelEntry.querySelector('.channelConversions');
      if (conversionsInput) {
        conversionsInput.value = channel.conversions || '';
        console.log('Set conversions:', channel.conversions, 'in element:', conversionsInput);
      } else {
        console.log('Conversions input not found');
      }
      
      const tagNumberInput = channelEntry.querySelector('.channelTagNumber');
      if (tagNumberInput) {
        tagNumberInput.value = channel.tagNumber || '';
        console.log('Set tagNumber:', channel.tagNumber, 'in element:', tagNumberInput);
      } else {
        console.log('TagNumber input not found');
      }
      
      // Fill in channel-specific fields based on type
      if (channel.type === 'Social Media') {
        console.log('Processing Social Media channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          console.log('Set platform:', channel.platform, 'in element:', platformSelect);
          // Trigger platform change to enable fields and populate ad type
          if (channel.platform) {
            platformSelect.dispatchEvent(new Event('change'));
          }
        } else {
          console.log('Platform select not found');
        }
        
        const adTypeSelect = channelEntry.querySelector('.channelAdType');
        if (adTypeSelect) {
          // Check if the ad type value exists in the dropdown options
          const adTypeExists = Array.from(adTypeSelect.options).some(option => option.value === channel.adType);
          if (adTypeExists) {
            adTypeSelect.value = channel.adType;
            console.log('Set ad type:', channel.adType, 'in element:', adTypeSelect);
          } else {
            console.log('Ad type value not found in dropdown options:', channel.adType);
            console.log('Available options:', Array.from(adTypeSelect.options).map(opt => opt.value));
          }
        } else {
          console.log('Ad type select not found');
        }
      } else if (channel.type === 'TV' || channel.type === 'Radio') {
        console.log('Processing TV/Radio channel...');
        
        const networkInput = channelEntry.querySelector('.channelNetwork');
        if (networkInput) networkInput.value = channel.network || '';
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
      } else if (channel.type === 'Print Media') {
        console.log('Processing Print Media channel...');
        
        const platformSelect = channelEntry.querySelector('.channelPlatform');
        if (platformSelect) {
          platformSelect.value = channel.platform || '';
          // Trigger platform change to enable fields
          if (channel.platform) {
            platformSelect.dispatchEvent(new Event('change'));
          }
        }
        
        const publicationInput = channelEntry.querySelector('.channelPublication');
        if (publicationInput) publicationInput.value = channel.publication || '';
        
        const startDateInput = channelEntry.querySelector('.channelStartDate');
        if (startDateInput) startDateInput.value = channel.startDate || '';
        
        const endDateInput = channelEntry.querySelector('.channelEndDate');
        if (endDateInput) endDateInput.value = channel.endDate || '';
        
        const areaInput = channelEntry.querySelector('.channelArea');
        if (areaInput) areaInput.value = channel.area || '';
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Email' || channel.type === 'Message') {
        console.log('Processing Email/Message channel...');
        
        const qtyInput = channelEntry.querySelector('.channelQty');
        if (qtyInput) qtyInput.value = channel.qty || '';
      } else if (channel.type === 'Outdoor Events') {
        console.log('Processing Outdoor Events channel...');
        
        const venueInput = channelEntry.querySelector('.channelVenue');
        if (venueInput) venueInput.value = channel.venue || '';
      } else if (channel.type === 'Promotional Items') {
        console.log('Processing Promotional Items channel...');
      } else if (channel.type === 'Promotional Offer') {
        console.log('Processing Promotional Offer channel...');
      }
      
      // Enable all fields after setting values (for edit mode)
      const allInputs = channelEntry.querySelectorAll('input, select');
      allInputs.forEach(input => {
        if (input !== channelEntry.querySelector('.channelType') && 
            input !== channelEntry.querySelector('.channelTagNumber')) {
          input.disabled = false;
          input.classList.remove('bg-gray-100');
        }
      });
      
      // Force a re-render to ensure values are visible
      channelEntry.style.display = 'none';
      channelEntry.offsetHeight; // Force reflow
      channelEntry.style.display = '';
      
      console.log('Channel entry values filled successfully');
    }

    // --- CATEGORY DYNAMIC ADD/REMOVE ---
    // Global function for updating remove category buttons
    function updateRemoveCategoryBtns() {
      const btns = document.querySelectorAll('.removeCategoryBtn');
      btns.forEach(btn => {
        btn.onclick = function() {
          btn.parentElement.remove();
          // Hide remove button if only one left
          if (document.querySelectorAll('.targetCategorySelect').length === 1) {
            document.querySelector('.removeCategoryBtn').classList.add('hidden');
          }
        };
      });
      // Hide remove button if only one select
      if (btns.length === 1) btns[0].classList.add('hidden');
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Add Category button logic
      const addCatBtn = document.getElementById('addCategoryBtn');
      if (addCatBtn) {
        addCatBtn.onclick = function() {
          console.log('Add Category button clicked');
          const catContainer = document.getElementById('targetCategoryContainer');
          const div = document.createElement('div');
          div.className = 'targetCategorySelect flex flex-wrap items-center gap-2';
          div.innerHTML = `<select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="">Select Category</option>
            <option>Tourist</option>
            <option>Resident</option>
            <option>All Walkin</option>
            <option>Social Media</option>
            <option>Social Groups</option>
            <option>Corporates</option>
            <option>Residential Cmty</option>
            <option>Local Cmty</option>
            <option>Blue collar wrkrs</option>
            <option>Existing cutomers</option>
            <option>HNTW</option>
            <option>Channel Partner</option>
            <option>DGJG</option>
            <option>Hotels</option>
            <option>Tourism Companies</option>
            <option>Tour Drivers</option>
            <option>Other Tours Assctd cmpy</option>
            <option>Festival & Occasion Buyers</option>
            <option>Product Launch</option>
          </select><input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tag"><button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>`;
          catContainer.appendChild(div);
          updateRemoveCategoryBtns();
        };
      }
      updateRemoveCategoryBtns();
    });

    // Tag Number Generation
    let tagCounter = 1;
    
    async function generateTagNumber(button) {
      const entry = button ? button.closest('.channelEntry') : document.querySelector('.channelEntry:last-child');
      const tagInput = entry.querySelector('.channelTagNumber');
      const channelType = entry.querySelector('.channelType').value;
      const platform = entry.querySelector('.channelPlatform')?.value || '';
      
      // Don't show alert if this is an automatic call (button is null) and no channel type is selected
      // This prevents unwanted alerts during edit mode when fields are being populated
      if (!channelType && !button) {
        return;
      }
      
      if (!channelType) {
        alert('Please select a channel type first');
        return;
      }
      
      // For Social Media, check if platform is selected
      if (channelType === 'Social Media' && !platform) {
        alert('Please select a platform for Social Media');
        return;
      }
      
      try {
        // Use server endpoint to generate unique tag
        const response = await fetch('/api/tags/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelType, platform })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          tagInput.value = result.tagNumber;
          tagInput.disabled = true;
          tagInput.placeholder = 'Auto-generated';
          tagInput.classList.remove('bg-gray-50');
          tagInput.classList.add('bg-blue-50', 'text-blue-900');
          
          // Tags are auto-generated, no buttons to hide
          
          // Make platform uneditable after tag generation
          const platformSelect = entry.querySelector('.channelPlatform');
          if (platformSelect) {
            platformSelect.disabled = true;
            platformSelect.classList.add('bg-gray-100');
            platformSelect.title = "Platform cannot be changed after tag generation";
          }
          
          // Make channel type uneditable after tag generation
          const channelTypeSelect = entry.querySelector('.channelType');
          if (channelTypeSelect) {
            channelTypeSelect.disabled = true;
            channelTypeSelect.classList.add('bg-gray-100');
            channelTypeSelect.title = "Channel type cannot be changed after tag generation";
          }

          console.log(`Generated unique tag: ${result.tagNumber}`);
        } else {
          throw new Error(result.error || 'Failed to generate tag');
        }
      } catch (err) {
        console.error('Error generating unique tag:', err);
        alert('Error generating tag number. Please try again.');
      }
    }

    // Impression Tracking Functions
    async function loadImpressionStats() {
      try {
        console.log('=== LOAD IMPRESSION STATS FUNCTION CALLED ==='); // Clear debug log
        console.log('Loading impression stats...'); // Debug log
        const response = await fetch('/api/impressions/stats');
        console.log('Response status:', response.status); // Debug log
        const stats = await response.json();
        console.log('Raw stats response:', stats); // Debug log
        console.log('Raw stats response type:', typeof stats); // Debug log
        console.log('Raw stats response keys:', Object.keys(stats)); // Debug log
        console.log('Total impressions:', stats.totalImpressions); // Debug log
        console.log('Campaigns with impressions:', stats.campaignsWithImpressions); // Debug log
        console.log('Impressions by channel:', stats.impressionsByChannel); // Debug log
        console.log('Impressions by platform:', stats.impressionsByPlatform); // Debug log
        console.log('Top performing channels:', stats.topPerformingChannels); // Debug log
        
        if (response.ok) {
          displayImpressionStats(stats);
        } else {
          alert('Error loading impression stats: ' + stats.error);
        }
      } catch (err) {
        console.error('Error loading impression stats:', err);
        alert('Error loading impression statistics');
      }
    }

    function displayImpressionStats(stats) {
      console.log('Received impression stats:', stats); // Debug log
      
      // Display overall statistics
      const statsContainer = document.getElementById('impressionStats');
      statsContainer.innerHTML = `
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
          <h4 class="text-sm font-medium text-blue-700 mb-2">Total Impressions</h4>
          <p class="text-2xl font-bold text-blue-900">${new Intl.NumberFormat().format(stats.totalImpressions)}</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
          <h4 class="text-sm font-medium text-green-700 mb-2">Campaigns with Impressions</h4>
          <p class="text-2xl font-bold text-green-900">${stats.campaignsWithImpressions}</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
          <h4 class="text-sm font-medium text-purple-700 mb-2">Channel Types</h4>
          <p class="text-2xl font-bold text-purple-900">${Object.keys(stats.impressionsByChannel).length}</p>
        </div>
        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
          <h4 class="text-sm font-medium text-orange-700 mb-2">Social Media Platforms</h4>
          <p class="text-2xl font-bold text-orange-900">${Object.keys(stats.impressionsByPlatform).length}</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
          <h4 class="text-sm font-medium text-red-700 mb-2">Total Conversions</h4>
          <p class="text-2xl font-bold text-red-900">${new Intl.NumberFormat().format(stats.totalConversions || 0)}</p>
        </div>
      `;

      // Display top performing channels
      const topChannelsContainer = document.getElementById('topChannels');
      if (stats.topPerformingChannels.length > 0) {
        topChannelsContainer.innerHTML = `
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Channel Type</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impressions</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${stats.topPerformingChannels.map(channel => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${channel.campaignName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${channel.channelType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${channel.platform}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${channel.adName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${new Intl.NumberFormat().format(channel.impressions)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${new Intl.NumberFormat().format(channel.conversions || 0)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        topChannelsContainer.innerHTML = '<p class="text-gray-500">No impression data available yet.</p>';
      }

      // Display channel breakdown
      const campaignListContainer = document.getElementById('campaignImpressionsList');
      if (Object.keys(stats.impressionsByChannel).length > 0) {
        campaignListContainer.innerHTML = `
          <div class="space-y-4">
            <h4 class="text-sm font-medium text-gray-700 mb-3">Impressions by Channel Type</h4>
            ${Object.entries(stats.impressionsByChannel).map(([channelType, impressions]) => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">${channelType}</span>
                <span class="text-lg font-bold text-purple-600">${new Intl.NumberFormat().format(impressions)}</span>
              </div>
            `).join('')}
            ${Object.keys(stats.impressionsByPlatform).length > 0 ? `
              <h4 class="text-sm font-medium text-gray-700 mb-3 mt-6">Impressions by Social Media Platform</h4>
              ${Object.entries(stats.impressionsByPlatform).map(([platform, impressions]) => `
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                  <span class="font-medium text-blue-700">${platform}</span>
                  <span class="text-lg font-bold text-blue-600">${new Intl.NumberFormat().format(impressions)}</span>
                </div>
              `).join('')}
            ` : ''}
          </div>
        `;
      } else {
        campaignListContainer.innerHTML = '<p class="text-gray-500">No impression data available yet.</p>';
      }
    }

    async function searchByTag() {
      const tagNumber = document.getElementById('searchTagNumber').value.trim();
      console.log('Searching for tag number:', tagNumber);
      
      if (!tagNumber) {
        alert('Please enter a tag number to search');
        return;
      }

      try {
        console.log('Making API request to:', `/api/campaigns/tag/${tagNumber}`);
        const response = await fetch(`/api/campaigns/tag/${tagNumber}`);
        console.log('Response status:', response.status);
        
        const result = await response.json();
        console.log('Response data:', result);
        
        if (response.ok) {
          displayTagSearchResults(result);
        } else {
          document.getElementById('tagSearchResults').innerHTML = 
            `<p class="text-red-500">${result.error}</p>`;
        }
      } catch (err) {
        console.error('Error searching by tag:', err);
        document.getElementById('tagSearchResults').innerHTML = 
          '<p class="text-red-500">Error searching for tag</p>';
      }
    }

    async function loadAllTags() {
      try {
        const response = await fetch('/api/tags');
        const result = await response.json();
        
        if (response.ok) {
          displayAllTags(result);
        } else {
          alert('Error loading tags: ' + result.error);
        }
      } catch (err) {
        console.error('Error loading tags:', err);
        alert('Error loading tags');
      }
    }

    function displayTagSearchResults(result) {
      const container = document.getElementById('tagSearchResults');
      
      if (result.campaigns.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No campaigns found with this tag.</p>';
        return;
      }

      let html = `
        <div class="bg-green-50 p-3 rounded-lg mb-4">
          <h4 class="text-sm font-medium text-green-700">Found ${result.count} campaign(s) with tag: ${result.tagNumber}</h4>
        </div>
      `;

      result.campaigns.forEach(campaign => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4 mb-4">
            <h5 class="font-semibold text-purple-700 mb-2">${campaign.name} (${campaign.campaignId})</h5>
            <p class="text-sm text-gray-600 mb-3">${campaign.description || 'No description'}</p>
            
            <h6 class="text-sm font-medium text-gray-700 mb-2">Channels with tag ${result.tagNumber}:</h6>
            <div class="space-y-2">
        `;

        campaign.channels.forEach((channel, index) => {
          if (channel.tagNumber === result.tagNumber) {
            html += `
              <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                  <div>
                    <span class="font-medium">Type:</span> ${channel.type}
                  </div>
                  <div>
                    <span class="font-medium">Name:</span> ${channel.adName}
                  </div>
                  ${channel.platform ? `<div><span class="font-medium">Platform:</span> ${channel.platform}</div>` : ''}
                  <div>
                    <span class="font-medium">Cost:</span> ${channel.cost ? new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(channel.cost) : 'N/A'}
                  </div>
                  ${channel.impressions ? `<div><span class="font-medium">Impressions:</span> ${new Intl.NumberFormat().format(channel.impressions)}</div>` : ''}
                  <div>
                    <span class="font-medium">Tag:</span> <span class="font-mono bg-yellow-200 px-2 py-1 rounded">${channel.tagNumber}</span>
                  </div>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function displayAllTags(result) {
      const container = document.getElementById('tagSearchResults');
      
      if (result.tags.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No tags found in any campaigns.</p>';
        return;
      }

      let html = `
        <div class="bg-blue-50 p-3 rounded-lg mb-4">
          <h4 class="text-sm font-medium text-blue-700">Found ${result.count} unique tag(s)</h4>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
      `;

      result.tags.forEach(tag => {
        html += `
          <div class="bg-gray-50 p-2 rounded border text-center">
            <span class="font-mono text-sm">${tag}</span>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    async function loadTagCounters() {
      try {
        const response = await fetch('/api/tags/counters');
        const result = await response.json();
        
        if (response.ok) {
          displayTagCounters(result);
        } else {
          alert('Error loading tag counters: ' + result.error);
        }
      } catch (err) {
        console.error('Error loading tag counters:', err);
        alert('Error loading tag counters');
      }
    }

    function displayTagCounters(result) {
      const container = document.getElementById('tagCounters');
      
      if (result.counters.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No tag counters found.</p>';
        return;
      }



      let html = '';

      result.counters.forEach(counter => {
        html += `
          <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
            <div class="text-center">
              <div class="text-lg font-bold text-purple-700 mb-1">${counter.prefix}</div>
              <div class="text-sm text-gray-600 mb-1">${counter.platformName}</div>
              <div class="text-sm text-gray-600 mb-2">Last Used: ${counter.lastNumber}</div>
              <div class="text-xs font-mono bg-purple-100 px-2 py-1 rounded">
                Next: ${counter.nextTag}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function loadCampaignChannels() {
      const campaignId = document.getElementById('updateCampaignId').value.trim();
      
      if (!campaignId) {
        alert('Please enter a campaign ID');
        return;
      }

      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        const result = await response.json();
        
        if (response.ok) {
          displayCampaignChannels(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('Error loading campaign channels:', err);
        alert('Error loading campaign channels: ' + err.message);
      }
    }

    function displayCampaignChannels(campaign) {
      const displayDiv = document.getElementById('campaignChannelsDisplay');
      const channelsList = document.getElementById('channelsList');
      
      if (!campaign.channels || campaign.channels.length === 0) {
        channelsList.innerHTML = '<p class="text-gray-500">No channels found for this campaign.</p>';
        displayDiv.classList.remove('hidden');
        return;
      }

      let html = '';
      campaign.channels.forEach((channel, index) => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
              <div>
                <p class="text-sm font-medium text-gray-700">Channel ${index + 1}</p>
                <p class="text-xs text-gray-500">${channel.type}${channel.platform ? ' - ' + channel.platform : ''}</p>
                <p class="text-xs text-gray-500">${channel.adName || 'N/A'}</p>
                ${channel.tagNumber ? `<p class="text-xs font-mono bg-yellow-100 px-2 py-1 rounded mt-1">${channel.tagNumber}</p>` : ''}
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700">Current Impressions</p>
                <p class="text-lg font-bold text-purple-600">${channel.impressions ? new Intl.NumberFormat().format(channel.impressions) : '0'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">New Impressions</label>
                <input type="number" 
                       id="impressions_${channel.tagNumber || index}" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" 
                       placeholder="Enter new value" 
                       min="0"
                       value="${channel.impressions || 0}">
              </div>
              <div>
                <p class="text-sm font-medium text-gray-700">Current Conversions</p>
                <p class="text-lg font-bold text-green-600">${channel.conversions ? new Intl.NumberFormat().format(channel.conversions) : '0'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">New Conversions</label>
                <input type="number" 
                       id="conversions_${channel.tagNumber || index}" 
                       class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       placeholder="Enter new value" 
                       min="0"
                       value="${channel.conversions || 0}">
              </div>
              <div class="flex items-end">
                <button onclick="updateChannelMetrics('${channel.tagNumber || index}', ${index})" 
                        class="btn-primary py-2 px-4 rounded-md text-sm">
                  Update
                </button>
              </div>
            </div>
          </div>
        `;
      });

      channelsList.innerHTML = html;
      displayDiv.classList.remove('hidden');
    }

    async function updateChannelMetrics(tagNumber, channelIndex) {
      const impressionsInput = document.getElementById(`impressions_${tagNumber}`);
      const conversionsInput = document.getElementById(`conversions_${tagNumber}`);
      const impressions = parseInt(impressionsInput.value);
      const conversions = parseInt(conversionsInput.value);

      if (isNaN(impressions) || impressions < 0) {
        alert('Please enter a valid impressions value (must be a positive number).');
        return;
      }

      if (isNaN(conversions) || conversions < 0) {
        alert('Please enter a valid conversions value (must be a positive number).');
        return;
      }

      const campaignId = document.getElementById('updateCampaignId').value.trim();

      try {
        let response;
        if (tagNumber && tagNumber !== channelIndex.toString()) {
          // Use tag number if available
          response = await fetch(`/api/campaigns/impressions/${tagNumber}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ impressions, conversions })
          });
        } else {
          // Fallback to channel index
          response = await fetch(`/api/campaigns/${campaignId}/channels/${channelIndex}/impressions`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ impressions, conversions })
          });
        }

        const result = await response.json();
        
        if (response.ok) {
          alert(`Impressions updated successfully!`);
          // Refresh the channels display
          loadCampaignChannels();
          // Refresh the statistics
          loadImpressionStats();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        console.error('Error updating impressions:', err);
        alert('Error updating impressions: ' + err.message);
      }
    }

    // Auto-load impression stats when the section is shown
    function showSection(sectionId) {
      console.log(`Attempting to show section: ${sectionId}`);
      // Hide all sections and clear their content where necessary
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
        // Clear content for specific sections
        if (section.id === 'query-campaign') {
          console.log('Clearing query section content');
          const queryCampaignForm = section.querySelector('#queryCampaignForm');
          if (queryCampaignForm) {
            queryCampaignForm.classList.add('hidden');
            queryCampaignForm.innerHTML = ''; // Clear form HTML
          }
          const downloadBtn = section.querySelector('#downloadExcelBtn');
          if (downloadBtn) {
            downloadBtn.classList.add('hidden');
          }
        } else if (section.id === 'edit-campaign') {
          console.log('Clearing edit section content');
          const editCampaignId = section.querySelector('#editCampaignId');
          if (editCampaignId) {
            editCampaignId.value = '';
          }
          const editCampaignForm = section.querySelector('#editCampaignForm');
          if (editCampaignForm) {
            editCampaignForm.classList.add('hidden');
            editCampaignForm.innerHTML = ''; // Clear loaded form
          }
        } else if (section.id === 'new-campaign') {
             console.log('Clearing new campaign form');
             clearForm();
             // Campaign ID will be assigned by backend when form is submitted
        }
      });
      
      // Show selected section
      const selectedSection = document.getElementById(sectionId);
      if (selectedSection) {
        selectedSection.classList.remove('hidden');
        console.log(`Section ${sectionId} is now visible.`);
        
        // Auto-load impression stats when impression tracking section is shown
        if (sectionId === 'impression-tracking') {
          loadImpressionStats();
          loadTagCounters();
        }
      } else {
        console.error(`Section with ID ${sectionId} not found.`);
      }
      
      // Update active state of buttons
      document.querySelectorAll('.mb-8 .grid button').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-purple-500');
      });
      
      // Find the button that triggers the current section and highlight it by text content
      const menuButtons = document.querySelectorAll('.mb-8 .grid button');
      let buttonTextToMatch = '';
      if (sectionId === 'new-campaign') buttonTextToMatch = 'New Campaign';
      else if (sectionId === 'edit-campaign') buttonTextToMatch = 'Edit Campaign';
      else if (sectionId === 'query-campaign') buttonTextToMatch = 'Query Campaign';
      else if (sectionId === 'export-campaign') buttonTextToMatch = 'Export Campaigns';
      else if (sectionId === 'impression-tracking') buttonTextToMatch = 'Impression Tracking';
      else if (sectionId === 'user-manager') buttonTextToMatch = 'User & Role Manager';
      else if (sectionId === 'campaigns-table') buttonTextToMatch = 'Campaigns Table';

      if (buttonTextToMatch) {
          menuButtons.forEach(button => {
              // Use textContent and trim for reliable matching
              if (button.textContent.trim() === buttonTextToMatch) {
                  button.classList.add('ring-2', 'ring-purple-500');
                  console.log(`Highlighted button for section: ${sectionId}`);
              }
          });
      } else {
          console.warn(`No button text defined for sectionId: ${sectionId}`);
      }

      // Special actions for specific sections when shown
      if (sectionId === 'new-campaign') {
         // Campaign ID will be assigned by backend when form is submitted
         // Ensure campaignId field is empty
         const campaignIdField = document.getElementById('campaignId');
         if (campaignIdField) campaignIdField.value = '';
      } else if (sectionId === 'query-campaign') {
          // Auto-load campaign details if a campaign is already selected
          console.log('Query Campaign section shown, checking for selected campaign...');
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) {
              console.log('Campaign already selected, auto-loading details...');
              console.log('Selected campaign ID:', selectedRadio.value);
              console.log('querySelectedCampaign function exists:', typeof window.querySelectedCampaign);
              // Add a small delay to ensure the section is fully visible
              setTimeout(() => {
                  console.log('Calling querySelectedCampaign after delay...');
                  querySelectedCampaign();
              }, 100);
          } else {
              console.log('No campaign selected yet');
          }
      } else if (sectionId === 'edit-campaign') {
          // Nothing needed here, load is triggered by button click
      } else if (sectionId === 'export-campaign') {
          // Nothing needed here, export is triggered by button click
      } else if (sectionId === 'impression-tracking') {
          // Auto-load stats when section is shown
          loadImpressionStats();
      } else if (sectionId === 'campaigns-table') {
          // Auto-load campaigns when table section is shown
          loadCampaignsTable();
      } else if (sectionId === 'user-manager') {
          // Only load user manager if user has permission
          if (window.sessionManager && window.sessionManager.hasPermission('manage_users')) {
              console.log('[DEBUG] showSection: user-manager section requested with permission');
              if (typeof renderUsersTable === 'function') {
                  console.log('[DEBUG] Calling renderUsersTable...');
                  renderUsersTable();
              } else {
                  console.error('[DEBUG] renderUsersTable function not found!');
              }
          } else {
              console.log('[DEBUG] User does not have permission to access user-manager');
              alert('You do not have permission to access User & Role Manager');
              // Hide the section again
              selectedSection.classList.add('hidden');
              return;
          }
      }
       console.log(`Finished showing section: ${sectionId}`);
    }

    // Function to load campaigns table
    async function loadCampaignsTable() {
      try {
        console.log('[DEBUG] Loading campaigns table...');
        const response = await fetch('/api/campaigns');
        const campaigns = await response.json();
        
        console.log('[DEBUG] API Response status:', response.status);
        console.log('[DEBUG] API Response data:', campaigns);
        
        if (response.ok) {
          displayCampaignsTable(campaigns);
        } else {
          console.error('Error loading campaigns:', campaigns.error);
        }
      } catch (err) {
        console.error('Error loading campaigns:', err);
      }
    }

    // Store original campaigns data for filtering
    let originalCampaigns = [];
    
    // Function to display campaigns in table
    function displayCampaignsTable(campaigns) {
      console.log('displayCampaignsTable called with:', campaigns);
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      console.log('Original campaigns stored:', originalCampaigns.length);
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to apply filters
    function applyFilters() {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody || !originalCampaigns) return;
      
      // Get filter values
      const campaignIdFilter = document.getElementById('filter-campaign-id')?.value.toLowerCase() || '';
      const campaignNameFilter = document.getElementById('filter-campaign-name')?.value.toLowerCase() || '';
      const offersFilter = document.getElementById('filter-offers')?.value.toLowerCase() || '';
      const workStartDateFrom = document.getElementById('filter-work-start-date-from')?.value || '';
      const workStartDateTo = document.getElementById('filter-work-start-date-to')?.value || '';
      const startDateFrom = document.getElementById('filter-start-date-from')?.value || '';
      const startDateTo = document.getElementById('filter-start-date-to')?.value || '';
      const endDateFrom = document.getElementById('filter-end-date-from')?.value || '';
      const endDateTo = document.getElementById('filter-end-date-to')?.value || '';
      const budgetMin = document.getElementById('filter-budget-min')?.value || '';
      const budgetMax = document.getElementById('filter-budget-max')?.value || '';
      const statusFilter = document.getElementById('filter-status')?.value || '';
      const targetAgeFilter = document.getElementById('filter-target-age')?.value.toLowerCase() || '';
      const targetGenderFilter = document.getElementById('filter-target-gender')?.value || '';
      const categoriesFilter = document.getElementById('filter-categories')?.value || '';
      const goalSalesMin = document.getElementById('filter-goal-sales-min')?.value || '';
      const goalSalesMax = document.getElementById('filter-goal-sales-max')?.value || '';
      const goalImpressionsMin = document.getElementById('filter-goal-impressions-min')?.value || '';
      const goalImpressionsMax = document.getElementById('filter-goal-impressions-max')?.value || '';
      const goalConversionsMin = document.getElementById('filter-goal-conversions-min')?.value || '';
      const goalConversionsMax = document.getElementById('filter-goal-conversions-max')?.value || '';
      const tagNumbersFilter = document.getElementById('filter-tag-numbers')?.value.toLowerCase() || '';
      
      // Filter campaigns
      const filteredCampaigns = originalCampaigns.filter(campaign => {
        // Campaign ID filter
        if (campaignIdFilter && !(campaign.campaignId || '').toLowerCase().includes(campaignIdFilter)) return false;
        
        // Campaign Name filter
        if (campaignNameFilter && !(campaign.name || '').toLowerCase().includes(campaignNameFilter)) return false;
        
        // Offers filter
        if (offersFilter && !(campaign.description || '').toLowerCase().includes(offersFilter)) return false;
        
        // Work Start Date filter
        if (workStartDateFrom && campaign.workStartDate && new Date(campaign.workStartDate) < new Date(workStartDateFrom)) return false;
        if (workStartDateTo && campaign.workStartDate && new Date(campaign.workStartDate) > new Date(workStartDateTo)) return false;
        
        // Start Date filter
        if (startDateFrom && campaign.startDate && new Date(campaign.startDate) < new Date(startDateFrom)) return false;
        if (startDateTo && campaign.startDate && new Date(campaign.startDate) > new Date(startDateTo)) return false;
        
        // End Date filter
        if (endDateFrom && campaign.endDate && new Date(campaign.endDate) < new Date(endDateFrom)) return false;
        if (endDateTo && campaign.endDate && new Date(campaign.endDate) > new Date(endDateTo)) return false;
        
        // Budget filter
        if (budgetMin && (!campaign.budget || campaign.budget < parseFloat(budgetMin))) return false;
        if (budgetMax && (!campaign.budget || campaign.budget > parseFloat(budgetMax))) return false;
        
        // Status filter
        if (statusFilter && campaign.status !== statusFilter) return false;
        
        // Target Age filter
        if (targetAgeFilter && !(campaign.targetAudience?.age || '').toLowerCase().includes(targetAgeFilter)) return false;
        
        // Target Gender filter
        if (targetGenderFilter && campaign.targetAudience?.gender !== targetGenderFilter) return false;
        
        // Categories filter
        if (categoriesFilter) {
          const categories = campaign.targetAudience?.categories?.map(cat => cat.category) || [];
          if (!categories.includes(categoriesFilter)) return false;
        }
        
        // Goal Sales filter
        if (goalSalesMin && (!campaign.goals?.sales || campaign.goals.sales < parseFloat(goalSalesMin))) return false;
        if (goalSalesMax && (!campaign.goals?.sales || campaign.goals.sales > parseFloat(goalSalesMax))) return false;
        
        // Goal Impressions filter
        if (goalImpressionsMin && (!campaign.goals?.impressions || campaign.goals.impressions < parseFloat(goalImpressionsMin))) return false;
        if (goalImpressionsMax && (!campaign.goals?.impressions || campaign.goals.impressions > parseFloat(goalImpressionsMax))) return false;
        
        // Goal Conversions filter
        if (goalConversionsMin && (!campaign.goals?.conversions || campaign.goals.conversions < parseFloat(goalConversionsMin))) return false;
        if (goalConversionsMax && (!campaign.goals?.conversions || campaign.goals.conversions > parseFloat(goalConversionsMax))) return false;
        
        // Tag Numbers filter
        if (tagNumbersFilter) {
          const allTagNumbers = campaign.channels ? 
            campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
          if (!allTagNumbers.toLowerCase().includes(tagNumbersFilter)) return false;
        }
        
        return true;
      });
      
      // Update count
      countSpan.textContent = filteredCampaigns.length;
      
      // Display filtered campaigns
      if (filteredCampaigns.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="20" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
        return;
      }
      
      let html = '';
      filteredCampaigns.forEach((campaign, index) => {
        const workStartDate = campaign.workStartDate ? new Date(campaign.workStartDate).toLocaleDateString() : '';
        const startDate = campaign.startDate ? new Date(campaign.startDate).toLocaleDateString() : '';
        const endDate = campaign.endDate ? new Date(campaign.endDate).toLocaleDateString() : '';
        const categories = campaign.targetAudience && campaign.targetAudience.categories ? 
          campaign.targetAudience.categories.map(cat => cat.category).join(', ') : '';
        const tagNumbers = campaign.channels ? 
          campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
        
        html += `
          <tr>
            <td><input type="radio" name="selected_campaign" value="${campaign._id}" class="select-campaign-radio"></td>
            <td>${index + 1}</td>
            <td>${campaign.campaignId || ''}</td>
            <td>${campaign.name || ''}</td>
            <td>${campaign.description || ''}</td>
            <td>${workStartDate}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${campaign.budget ? new Intl.NumberFormat().format(campaign.budget) : ''}</td>
            <td>${campaign.status || ''}</td>
            <td>${campaign.targetAudience?.age || ''}</td>
            <td>${campaign.targetAudience?.gender || ''}</td>
            <td>${categories}</td>
            <td>${campaign.goals && campaign.goals.sales ? new Intl.NumberFormat().format(campaign.goals.sales) : ''}</td>
            <td>${campaign.goals && campaign.goals.impressions ? new Intl.NumberFormat().format(campaign.goals.impressions) : ''}</td>
            <td>${campaign.goals && campaign.goals.conversions ? new Intl.NumberFormat().format(campaign.goals.conversions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.sales ? new Intl.NumberFormat().format(campaign.achieved.sales) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.impressions ? new Intl.NumberFormat().format(campaign.achieved.impressions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.conversions ? new Intl.NumberFormat().format(campaign.achieved.conversions) : ''}</td>
            <td>${tagNumbers}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    }
    
    // Override the original displayCampaignsTable function
    function displayCampaignsTable(campaigns) {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to edit campaign from table
    function editCampaignFromTable(campaignId) {
      // Set the campaign ID in the edit form and show edit section
      const editInput = document.getElementById('editCampaignId');
      if (editInput) {
        editInput.value = campaignId;
        showSection('edit-campaign');
        // Trigger the load campaign function
        loadCampaign();
      }
    }

    // Function to view campaign details
    function viewCampaignDetails(campaignId) {
      // Set the campaign ID in the query form and show query section
      const queryInput = document.getElementById('queryCampaignId');
      if (queryInput) {
        queryInput.value = campaignId;
        showSection('query-campaign');
        // Trigger the query function
        queryCampaign();
      }
    }

    // Auto-load campaigns table when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Show campaigns table by default
      showSection('campaigns-table');
      
      // Add filter event listeners
      addFilterEventListeners();
      
      // Add edit selected functionality
      addEditSelectedFunctionality();
    });
    
    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Function to add filter event listeners
    function addFilterEventListeners() {
      const filterInputs = [
        'filter-campaign-id', 'filter-campaign-name', 'filter-offers', 
        'filter-start-date-from', 'filter-start-date-to', 'filter-end-date-from', 'filter-end-date-to',
        'filter-budget-min', 'filter-budget-max', 'filter-status', 'filter-target-age', 'filter-target-gender',
        'filter-categories', 'filter-goal-sales-min', 'filter-goal-sales-max', 'filter-goal-impressions-min',
        'filter-goal-impressions-max', 'filter-goal-conversions-min', 'filter-goal-conversions-max',
        'filter-achieved-sales-min', 'filter-achieved-sales-max', 'filter-achieved-impressions-min',
        'filter-achieved-impressions-max', 'filter-achieved-conversions-min', 'filter-achieved-conversions-max',
        'filter-tag-numbers'
      ];
      
      // Create debounced version of applyFilters
      const debouncedApplyFilters = debounce(applyFilters, 300);
      
      filterInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedApplyFilters);
          element.addEventListener('change', applyFilters);
        }
      });
    }
    
    // Function to apply filters
    function applyFilters() {
      if (!originalCampaigns || originalCampaigns.length === 0) return;
      
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Get filter values
      const campaignIdFilter = document.getElementById('filter-campaign-id')?.value.toLowerCase() || '';
      const campaignNameFilter = document.getElementById('filter-campaign-name')?.value.toLowerCase() || '';
      const offersFilter = document.getElementById('filter-offers')?.value.toLowerCase() || '';
      const workStartDateFrom = document.getElementById('filter-work-start-date-from')?.value || '';
      const workStartDateTo = document.getElementById('filter-work-start-date-to')?.value || '';
      const startDateFrom = document.getElementById('filter-start-date-from')?.value || '';
      const startDateTo = document.getElementById('filter-start-date-to')?.value || '';
      const endDateFrom = document.getElementById('filter-end-date-from')?.value || '';
      const endDateTo = document.getElementById('filter-end-date-to')?.value || '';
      const budgetMin = document.getElementById('filter-budget-min')?.value || '';
      const budgetMax = document.getElementById('filter-budget-max')?.value || '';
      const statusFilter = document.getElementById('filter-status')?.value || '';
      const targetAgeFilter = document.getElementById('filter-target-age')?.value.toLowerCase() || '';
      const targetGenderFilter = document.getElementById('filter-target-gender')?.value || '';
      const categoriesFilter = document.getElementById('filter-categories')?.value || '';
      const goalSalesMin = document.getElementById('filter-goal-sales-min')?.value || '';
      const goalSalesMax = document.getElementById('filter-goal-sales-max')?.value || '';
      const goalImpressionsMin = document.getElementById('filter-goal-impressions-min')?.value || '';
      const goalImpressionsMax = document.getElementById('filter-goal-impressions-max')?.value || '';
      const goalConversionsMin = document.getElementById('filter-goal-conversions-min')?.value || '';
      const goalConversionsMax = document.getElementById('filter-goal-conversions-max')?.value || '';
      const tagNumbersFilter = document.getElementById('filter-tag-numbers')?.value.toLowerCase() || '';
      
      // Filter campaigns
      const filteredCampaigns = originalCampaigns.filter(campaign => {
        // Campaign ID filter
        if (campaignIdFilter && !(campaign.campaignId || '').toLowerCase().includes(campaignIdFilter)) return false;
        
        // Campaign Name filter
        if (campaignNameFilter && !(campaign.name || '').toLowerCase().includes(campaignNameFilter)) return false;
        
        // Offers filter
        if (offersFilter && !(campaign.description || '').toLowerCase().includes(offersFilter)) return false;
        
        // Work Start Date filter
        if (workStartDateFrom && campaign.workStartDate && new Date(campaign.workStartDate) < new Date(workStartDateFrom)) return false;
        if (workStartDateTo && campaign.workStartDate && new Date(campaign.workStartDate) > new Date(workStartDateTo)) return false;
        
        // Start Date filter
        if (startDateFrom && campaign.startDate && new Date(campaign.startDate) < new Date(startDateFrom)) return false;
        if (startDateTo && campaign.startDate && new Date(campaign.startDate) > new Date(startDateTo)) return false;
        
        // End Date filter
        if (endDateFrom && campaign.endDate && new Date(campaign.endDate) < new Date(endDateFrom)) return false;
        if (endDateTo && campaign.endDate && new Date(campaign.endDate) > new Date(endDateTo)) return false;
        
        // Budget filter
        if (budgetMin && (!campaign.budget || campaign.budget < parseFloat(budgetMin))) return false;
        if (budgetMax && (!campaign.budget || campaign.budget > parseFloat(budgetMax))) return false;
        
        // Status filter
        if (statusFilter && campaign.status !== statusFilter) return false;
        
        // Target Age filter
        if (targetAgeFilter && !(campaign.targetAudience?.age || '').toLowerCase().includes(targetAgeFilter)) return false;
        
        // Target Gender filter
        if (targetGenderFilter && campaign.targetAudience?.gender !== targetGenderFilter) return false;
        
        // Categories filter
        if (categoriesFilter) {
          const categories = campaign.targetAudience?.categories?.map(cat => cat.category) || [];
          if (!categories.includes(categoriesFilter)) return false;
        }
        
        // Goal Sales filter
        if (goalSalesMin && (!campaign.goals?.sales || campaign.goals.sales < parseFloat(goalSalesMin))) return false;
        if (goalSalesMax && (!campaign.goals?.sales || campaign.goals.sales > parseFloat(goalSalesMax))) return false;
        
        // Goal Impressions filter
        if (goalImpressionsMin && (!campaign.goals?.impressions || campaign.goals.impressions < parseFloat(goalImpressionsMin))) return false;
        if (goalImpressionsMax && (!campaign.goals?.impressions || campaign.goals.impressions > parseFloat(goalImpressionsMax))) return false;
        
        // Goal Conversions filter
        if (goalConversionsMin && (!campaign.goals?.conversions || campaign.goals.conversions < parseFloat(goalConversionsMin))) return false;
        if (goalConversionsMax && (!campaign.goals?.conversions || campaign.goals.conversions > parseFloat(goalConversionsMax))) return false;
        
        // Tag Numbers filter
        if (tagNumbersFilter) {
          const allTagNumbers = campaign.channels ? 
            campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
          if (!allTagNumbers.toLowerCase().includes(tagNumbersFilter)) return false;
        }
        
        return true;
      });
      
      // Update count
      countSpan.textContent = filteredCampaigns.length;
      
      // Display filtered campaigns
      if (filteredCampaigns.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="20" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
        return;
      }
      
      let html = '';
      filteredCampaigns.forEach((campaign, index) => {
        const workStartDate = campaign.workStartDate ? new Date(campaign.workStartDate).toLocaleDateString() : '';
        const startDate = campaign.startDate ? new Date(campaign.startDate).toLocaleDateString() : '';
        const endDate = campaign.endDate ? new Date(campaign.endDate).toLocaleDateString() : '';
        const categories = campaign.targetAudience && campaign.targetAudience.categories ? 
          campaign.targetAudience.categories.map(cat => cat.category).join(', ') : '';
        const tagNumbers = campaign.channels ? 
          campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
        
        html += `
          <tr>
            <td><input type="radio" name="selected_campaign" value="${campaign._id}" class="select-campaign-radio"></td>
            <td>${index + 1}</td>
            <td>${campaign.campaignId || ''}</td>
            <td>${campaign.name || ''}</td>
            <td>${campaign.description || ''}</td>
            <td>${workStartDate}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${campaign.budget ? new Intl.NumberFormat().format(campaign.budget) : ''}</td>
            <td>${campaign.status || ''}</td>
            <td>${campaign.targetAudience?.age || ''}</td>
            <td>${campaign.targetAudience?.gender || ''}</td>
            <td>${categories}</td>
            <td>${campaign.goals && campaign.goals.sales ? new Intl.NumberFormat().format(campaign.goals.sales) : ''}</td>
            <td>${campaign.goals && campaign.goals.impressions ? new Intl.NumberFormat().format(campaign.goals.impressions) : ''}</td>
            <td>${campaign.goals && campaign.goals.conversions ? new Intl.NumberFormat().format(campaign.goals.conversions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.sales ? new Intl.NumberFormat().format(campaign.achieved.sales) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.impressions ? new Intl.NumberFormat().format(campaign.achieved.impressions) : ''}</td>
            <td>${campaign.achieved && campaign.achieved.conversions ? new Intl.NumberFormat().format(campaign.achieved.conversions) : ''}</td>
            <td>${tagNumbers}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    }
    
    // Function to add edit and delete selected functionality
    function addEditSelectedFunctionality() {
      console.log('[DEBUG] Initializing edit and delete functionality...');
      const deleteBtn = document.getElementById('delete-selected-btn');
      let selectedCampaignId = null;
      
      console.log('[DEBUG] Delete button found:', !!deleteBtn);
      
      // Always set up radio button event listener, regardless of delete button
        document.addEventListener('change', function(e) {
          if (e.target.classList.contains('select-campaign-radio')) {
          console.log('Radio button selected:', e.target.value);
            selectedCampaignId = e.target.value;
          
          // Enable delete button if it exists
          if (deleteBtn) {
            deleteBtn.disabled = false;
            console.log('Delete button enabled:', deleteBtn.disabled);
          }
          
          // Auto-load campaign details for query section if it's visible
          const querySection = document.getElementById('query-campaign');
          if (querySection && !querySection.classList.contains('hidden')) {
            console.log('Query section is visible, auto-loading campaign details...');
            querySelectedCampaign();
          }
          
          // Update the indicator in query section if it exists
          const indicator = document.getElementById('campaign-selected-indicator');
          const instructions = document.getElementById('query-instructions');
          if (indicator && instructions) {
            indicator.classList.remove('hidden');
            instructions.classList.add('hidden');
          }
        }
      });
    }
    
    // Function to delete campaign by ID
    async function deleteCampaignById(campaignId) {
      // Check if user has permission to delete campaigns
      if (window.sessionManager && !window.sessionManager.canDeleteCampaigns()) {
        alert('You do not have permission to delete campaigns. Only Admin users can delete campaigns.');
        return;
      }
      
      try {
        // Make API call to delete campaign
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          // Remove from local data
          originalCampaigns = originalCampaigns.filter(c => c._id !== campaignId);
          
          // Clear any radio selection
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) {
            selectedRadio.checked = false;
          }
          
          // Force table refresh with empty state handling
          if (originalCampaigns.length === 0) {
            const tableBody = document.getElementById('campaigns-table-body');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="20" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
            }
          }
          
          // Refresh the table
          displayCampaignsTable(originalCampaigns);
          
          // Update campaigns count
          const campaignsCount = document.getElementById('campaigns-count');
          if (campaignsCount) {
            campaignsCount.textContent = originalCampaigns.length;
          }
          
          // Show delete input for manual deletion of other campaigns
          setDeleteCampaignInputVisibility(true);
          
          console.log('Campaign deleted, campaigns remaining:', originalCampaigns.length);
          alert('Campaign deleted successfully!');
        } else {
          const error = await response.json();
          alert(`Failed to delete campaign: ${error.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Delete campaign error:', error);
        alert('Failed to delete campaign. Please try again.');
      }
    }
    // Ensure handler is registered after DOMContentLoaded
    window.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] DOMContentLoaded - initializing functions...');
      addEditCampaignMenuFunctionality();
      console.log('[DEBUG] Calling addEditSelectedFunctionality...');
      try {
        addEditSelectedFunctionality();
        console.log('[DEBUG] addEditSelectedFunctionality completed successfully');
      } catch (error) {
        console.error('[DEBUG] Error in addEditSelectedFunctionality:', error);
      }
      console.log('[DEBUG] Functions initialized.');
      

    });
  </script>

<!-- Edit Roles Modal -->
        <div id="editRolesModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-xs relative">
        <h3 class="text-md font-semibold text-purple-700 mb-3">Edit User Roles</h3>
        <select id="editRolesSelect" multiple class="w-full mb-4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
        <div class="flex justify-end gap-2">
          <button id="editRolesCancelBtn" type="button" class="btn-secondary px-4 py-2 rounded">Cancel</button>
          <button id="editRolesSaveBtn" type="button" class="btn-primary px-4 py-2 rounded">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/public/sessionManager.js"></script>
  <script src="/public/userManager.js"></script>
  
  <!-- Initialize application -->
<script>
    // Simple test to see if JavaScript is working
    console.log('[TEST] JavaScript is working');
    
    // Initialize application when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for session manager to initialize
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Add login form submission handler
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            alert('Please enter both username and password');
            return;
          }
          
          // Show loading state
          const submitBtn = loginForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Signing in...';
          submitBtn.disabled = true;
          
          try {
            const result = await sessionManager.login(username, password);
            
            if (result.success) {
              // Login successful - session manager will handle the rest
            } else {
              // Login failed
              const errorMessage = result.error || 'Login failed. Please check your credentials.';
              
              // Clear password field first
              document.getElementById('password').value = '';
              
              // Show error message in the form
              const errorDiv = document.getElementById('loginError');
              if (errorDiv) {
                errorDiv.textContent = 'Please check your username and password and try again.';
                errorDiv.classList.remove('hidden');
                
                // Hide error after 5 seconds
                setTimeout(() => {
                  errorDiv.classList.add('hidden');
                }, 5000);
              }
              
              // Also show alert for immediate attention
              alert('Please check your username and password and try again.');
            }
          } catch (error) {
            console.error('‚ùå Login error:', error);
            alert('Login failed. Please try again.');
            // Clear password field
            document.getElementById('password').value = '';
          } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
        });
      }
      
      // Session manager will handle showing login or main content
      
      // Ensure only campaigns table is visible by default
      const allSections = document.querySelectorAll('.section');
      allSections.forEach(section => {
        if (section.id === 'campaigns-table') {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });
});
</script>

</body>