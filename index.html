<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketing Manager</title>
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    body {
      background: #fff;
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .btn-primary {
      background-color: #0066CC;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-primary:hover {
      background-color: #0052A3;
    }
    .btn-secondary {
      background-color: #4DABF7;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-secondary:hover {
      background-color: #339AF0;
    }
    .btn-danger {
      background-color: #DC2626;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-danger:hover {
      background-color: #B91C1C;
    }
    .btn-danger:disabled {
      background-color: #9CA3AF;
      cursor: not-allowed;
    }
    
    /* Priority Badge Styles */
    .priority-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .priority-high {
      background-color: #FEE2E2;
      color: #DC2626;
      border: 1px solid #FECACA;
    }
    
    /* Improved Badge and Rating Colors */
    .badge-option {
      padding: 12px 16px;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 4px;
      display: inline-block;
      min-width: 120px;
      text-align: center;
    }
    .badge-option:hover {
      border-color: #6B46C1;
      background-color: #F3F4F6;
    }
    .badge-option.selected {
      border-color: #6B46C1;
      background-color: #EDE9FE;
      color: #6B46C1;
    }
    
    .rating-option {
      padding: 12px 16px;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 4px;
      display: inline-block;
      min-width: 60px;
      text-align: center;
      font-size: 1.2rem;
    }
    .rating-option:hover {
      border-color: #10B981;
      background-color: #F0FDF4;
    }
    .rating-option.selected {
      border-color: #10B981;
      background-color: #D1FAE5;
      color: #059669;
    }
    .btn-dark-blue {
      background-color: #1E3A8A;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-dark-blue:hover {
      background-color: #1E40AF;
    }
    .btn-remove {
      background-color: #EF4444;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-remove:hover {
      background-color: #DC2626;
    }
    .btn-remove-light {
      background-color: #FFEB3B;
      color: #7C6F00;
      transition: background-color 0.3s;
      border: 1px solid #FBC02D;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      width: 100%;
    }
    .btn-remove-light:hover {
      background-color: #FFF176;
    }
    
    /* Campaign table styles */
    .crm-table {
      border-collapse: collapse;
      font-size: 13px;
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
      background: #fff;
      width: 100%;
    }
    .crm-table th, .crm-table td {
      font-weight: normal;
      padding: 0.32rem 0.6rem 0.32rem 0.6rem;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-left: none;
      vertical-align: middle;
      white-space: nowrap;
      height: 34px;
      min-width: 110px;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #fff;
    }
    .crm-table th {
      background: #f8f9fa;
      color: #222;
      font-size: 13px;
      font-weight: bold;
      border-bottom: 1.5px solid #d0d0d0;
    }
    .crm-table tbody tr:hover {
      background: #f4f7fa;
    }
    .crm-table tr:last-child td {
      border-bottom: 1px solid #e0e0e0;
    }
    .crm-table th:not(:last-child), .crm-table td:not(:last-child) {
      border-right: 1px solid #e0e0e0;
    }
    .crm-table td:last-child {
      white-space: normal;
      overflow: visible;
      min-width: 120px;
      max-width: none;
    }
    .crm-table td:last-child .btn {
      margin: 1px;
      font-size: 11px;
      padding: 2px 6px;
    }
    
    /* Filter styles */
    .form-control-sm {
      height: 28px;
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      width: 100%;
    }
    .form-control-sm:focus {
      border-color: #6B46C1;
      outline: none;
      box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.2);
    }
    .mt-1 {
      margin-top: 2px;
    }
    .section {
      width: 100%;
      padding: 1.25rem 0;
    }

    .card {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    
    /* Custom tooltip styles */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: "Tags can only be generated automatically";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      margin-bottom: 3px;
      z-index: 1000;
    }
  </style>
</head>
  <!-- Login Form -->
  <div id="login-form" class="min-h-screen flex items-center justify-center bg-white" style="display: none;">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md mx-4">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Trichy Gold</h1>
        <h2 class="text-lg font-semibold text-purple-600">Job Dashboard</h2>
      </div>
      
      <!-- Login Form -->
      <form class="space-y-8" id="loginForm">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input id="username" name="username" type="text" required autocomplete="username"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your username">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input id="password" name="password" type="password" required autocomplete="current-password"
                 class="w-full bg-white text-gray-900 placeholder-gray-400 border-0 border-b-2 border-gray-300 focus:border-purple-500 focus:ring-0 py-3 px-0 text-base transition duration-150 ease-in-out outline-none shadow-none" 
                 placeholder="Enter your password">
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-md text-sm"></div>
        <div>
          <button type="submit" 
                  class="w-full py-3 px-4 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
            Sign in
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="min-h-screen flex items-center justify-center">
  <!-- MAIN CARD - ALL UI SECTIONS MUST BE INSIDE THIS DIV -->
    <div class="card w-full p-6 relative">
            <h1 class="text-2xl font-bold text-center text-purple-700 mb-6">Trichy Gold Job Dashboard</h1>
    
    <!-- Main Menu -->
    <div class="mb-8">
      <div class="flex gap-4 justify-center">
        <button onclick="showSection('campaigns-table')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üìä</span>
          <span>Job Table</span>
        </button>
        <button onclick="showSection('new-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">‚ûï</span>
          <span>Add New</span>
        </button>
        <button onclick="showSection('query-campaign')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üîç</span>
          <span>Query</span>
        </button>
        <button onclick="showSection('edit-campaign')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">‚úèÔ∏è</span>
          <span>Edit</span>
        </button>
        <button onclick="handleDeleteClick()" class="btn-secondary py-2 px-4 rounded-md flex items-center delete-campaign-btn">
          <span class="mr-2">üóëÔ∏è</span>
          <span>Delete</span>
        </button>

        <button onclick="showSection('export-campaign')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üì•</span>
          <span>Export Jobs</span>
        </button>
        <button onclick="showSection('performance-tracking')" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <span class="mr-2">üèÜ</span>
          <span>Performance & Badges</span>
        </button>
        <button onclick="showSection('user-manager')" class="btn-primary py-2 px-4 rounded-md flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.485 0 4.797.657 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>User & Role Manager</span>
        </button>

        <button onclick="window.sessionManager.logout()" class="btn-secondary py-2 px-4 rounded-md flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Campaigns Table Section -->
    <div id="campaigns-table" class="section">
      


      <!-- Campaigns Table -->
      <div class="mb-4">
        <div class="mb-2"><b>Total Records:</b> <span id="campaigns-count">0</span></div>
      </div>
      <div style="overflow-x: auto; width: 100%; border-bottom: 1.5px solid #d0d0d0;">
        <table class="crm-table" style="min-width: max-content; width: 100%;">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th style="width: 60px;">#</th>
                              <th style="width: 120px;">Job ID</th>
              <th style="width: 150px;">Name</th>
              <th style="width: 120px;">Description</th>
              <th style="width: 100px;">Entry Date</th>
              <th style="width: 100px;">Planned Start Date</th>
              <th style="width: 100px;">Actual Start Date</th>
              <th style="width: 100px;">End Date</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 100px;">Priority</th>
              <th style="width: 120px;">Job Assigned To</th>
            </tr>
            <tr>
              <th><!-- No filter for checkbox --></th>
              <th><!-- No filter for # --></th>
                              <th><input type="text" id="filter-campaign-id" placeholder="Filter Job ID" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-campaign-name" placeholder="Filter Name" class="form-control form-control-sm"></th>
              <th><input type="text" id="filter-offers" placeholder="Filter Description" class="form-control form-control-sm"></th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">Entry Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-entry-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-entry-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">Planned Start Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-planned-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-planned-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">Actual Start Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-actual-start-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-actual-start-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th style="min-height: 80px; vertical-align: top;">
                <div class="text-xs text-gray-600 mb-1 text-center">End Date Range</div>
                <div class="space-y-1">
                  <input type="date" id="filter-end-date-from" class="form-control form-control-sm w-full" placeholder="From Date" style="display: block !important; margin-bottom: 4px;">
                  <input type="date" id="filter-end-date-to" class="form-control form-control-sm w-full" placeholder="To Date" style="display: block !important;">
                </div>
              </th>
              <th>
                <select id="filter-status" class="form-control form-control-sm">
                  <option value="">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </th>
              <th>
                <select id="filter-priority" class="form-control form-control-sm">
                  <option value="">All Priority</option>
                  <option value="High">High Priority</option>
                  <option value="No Priority">Without Priority</option>
                </select>
              </th>
              <th>
                <select id="filter-job-assigned-to" class="form-control form-control-sm">
                  <option value="">All Job Assigned To</option>
                </select>
              </th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body">
            <!-- Campaigns will be loaded here -->
          </tbody>
        </table>
      </div>
      
    </div>


    <div id="new-campaign" class="section hidden">
              <h2 class="text-lg font-semibold text-purple-700 mb-4">Create New</h2>
      <div class="space-y-6">
        <!-- Campaign Form -->
        <div class="mb-6">
          <div class="space-y-6">
            <!-- Campaign ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="campaignId" class="block text-sm font-medium text-purple-700">Job ID</label>
                <input id="campaignId" type="text" readonly class="w-full p-2 border rounded-md bg-gray-100 focus:outline-none" placeholder="Will be assigned automatically">
              </div>
              <div>
                <label for="name" class="block text-sm font-medium text-purple-700">Name</label>
                <input id="name" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Priority -->
            <div>
              <label for="priority" class="block text-sm font-medium text-purple-700">Priority</label>
              <select id="priority" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="" selected>No Priority</option>
                <option value="High">High Priority</option>
              </select>
            </div>
            
            <!-- Description -->
            <div>
              <label for="description" class="block text-sm font-medium text-purple-700">Description</label>
              <input id="description" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            

            <!-- Entry Date, Planned Start Date, Actual Start Date and End Date -->
            <div class="grid grid-cols-4 gap-4">
              <div>
                <label for="entryDate" class="block text-sm font-medium text-purple-700">Entry Date</label>
                <input id="entryDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="plannedStartDate" class="block text-sm font-medium text-purple-700">Planned Start Date</label>
                <input id="plannedStartDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="actualStartDate" class="block text-sm font-medium text-purple-700">Actual Start Date</label>
                <input id="actualStartDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label for="endDate" class="block text-sm font-medium text-purple-700">End Date</label>
                <input id="endDate" type="date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
            </div>
            
            <!-- Status and Assigned Employees -->
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label for="status" class="block text-sm font-medium text-purple-700">Status</label>
                <select id="status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required> 
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Planned">Planned</option>
                  <option value="Suggested">Suggested</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            
              <!-- Assigned Employees Section -->
                <div>
                <label class="block text-sm font-medium text-purple-700 mb-2">Assigned Employees</label>
                <div id="assignedEmployeesContainer" class="space-y-2">
                  <!-- Employee entries will be added here -->
                </div>
                <button type="button" onclick="addEmployeeEntry()" class="btn-secondary mt-2 py-2 px-4 rounded-md" style="width: 200px;">
                  <span class="mr-2">‚ûï</span>
                  Add Employee
                    </button>
                </div>
              </div>
              
            <!-- Job Progress Details Section -->
                <div>
              <label class="block text-sm font-medium text-purple-700 mb-2">Job Progress Tracking</label>
              <div id="progressDetailsContainer" class="space-y-2">
                <!-- Progress details will be added here -->
                </div>
              <button type="button" onclick="addProgressDetail()" class="btn-secondary mt-2 py-2 px-4 rounded-md" style="width: 200px;">
                <span class="mr-2">‚ûï</span>
                Add Details
                    </button>
            </div>
            
            <!-- File Upload Section -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-purple-700 mb-4">File Attachments</h3>
              <div class="mb-4">
                <input type="file" id="fileUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <p class="text-sm text-gray-600 mt-1">Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, JPEG, PNG, TXT</p>
                  </div>
              <div id="fileList" class="space-y-2">
                <!-- Uploaded files will be listed here -->
                </div>
            </div>
            
            <button onclick="submitCampaign()" class="btn-primary w-full py-2 rounded-md">Add New</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Campaign Section -->
    <div id="edit-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Edit</h2>
      <div class="space-y-6">
        <div class="mb-6">
          <label for="editCampaignId" class="block text-sm font-medium text-gray-700 mb-2">Enter Job ID to Edit</label>
          <div class="flex items-center space-x-4">
            <input id="editCampaignId" type="text" 
                   class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   placeholder="e.g., JOB_00001">
            <button onclick="loadCampaignForEdit()" 
                    class="btn-secondary py-2 px-4 rounded-md whitespace-nowrap ml-12">
              Load
            </button>
          </div>
        </div>
        <div id="editCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign form will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Query Campaign Section -->
    <div id="query-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Query</h2>
      <div class="space-y-4">
        <!-- Manual Campaign Code Entry -->
        <div id="queryManualEntryContainer" class="flex gap-2 items-end">
          <input id="queryCampaignCodeInput" type="text" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter Job ID (e.g., JOB_00001)">
          <button id="queryLoadBtn" class="btn-secondary py-2 px-4 rounded-md">Load</button>
          </div>
        <div id="queryCampaignForm" class="hidden mt-6 pt-4 border-t">
          <!-- Campaign details form will be loaded here -->
</div>
</div>
<button id="downloadExcelBtn" onclick="exportCampaigns()" class="btn-secondary mt-3 py-2 px-4 rounded-md hidden">Export Jobs</button>
<script>
        // Helper to show/hide query campaign input section
        function setQueryCampaignInputVisibility(visible) {
          console.log('setQueryCampaignInputVisibility called with visible:', visible);
          const manualInput = document.getElementById('queryManualEntryContainer');
          if (manualInput) {
            if (visible) {
              console.log('Showing manual input');
              manualInput.classList.remove('hidden');
            } else {
              console.log('Hiding manual input');
              manualInput.classList.add('hidden');
            }
          } else {
            console.log('Manual input container not found');
          }
          // Also show/hide the query form based on visibility
          const queryForm = document.getElementById('queryCampaignForm');
          if (queryForm) {
            if (visible) {
              console.log('Hiding query form');
              queryForm.classList.add('hidden');    // Hide form when showing manual input
            } else {
              console.log('Showing query form');
              queryForm.classList.remove('hidden'); // Show form when hiding manual input
            }
          } else {
            console.log('Query form not found in setQueryCampaignInputVisibility');
          }
        }

        // Update query section menu functionality to handle both entry points
        function addQueryCampaignMenuFunctionality() {
          const queryMenuBtn = document.querySelector("button[onclick=\"showSection('query-campaign')\"]");
          console.log('Query menu button found:', !!queryMenuBtn);
          if (!queryMenuBtn) { console.log('Query menu button not found'); return; }
          queryMenuBtn.addEventListener('click', async function(event) {
            event.preventDefault();
            console.log('Query button clicked');
            // Find selected campaign (same approach as edit)
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
            console.log('Selected radio in query button click:', selectedRadio);
            console.log('All radio buttons:', document.querySelectorAll('input[name="selected_campaign"]'));
            if (selectedRadio) {
              console.log('Radio selected, processing query...');
              // Query via radio selection: hide input, show form
              const selectedCampaignId = selectedRadio.value;
              console.log('Selected campaign ID:', selectedCampaignId);
              let campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
              console.log('Found campaign:', campaign);
              
              // If campaign not found, try to reload data
              if (!campaign) {
                console.log('Campaign not found, reloading campaigns data...');
                await loadCampaignsTable();
                campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
                console.log('Found campaign after reload:', campaign);
              }
              
              if (campaign) {
                // Show section AFTER getting the data (same as edit)
                console.log('About to show query section...');
              showSection('query-campaign');
                console.log('Query section shown, setting visibility...');
                setQueryCampaignInputVisibility(false);
                console.log('About to call querySelectedCampaign...');
                // Call the query function with the campaign data
                window.querySelectedCampaign(selectedCampaignId);
                console.log('querySelectedCampaign called');
              // Ensure the query form is visible
              const queryForm = document.getElementById('queryCampaignForm');
                if (queryForm) {
                  queryForm.classList.remove('hidden');
                  console.log('Query form should now be visible.');
            } else {
                  console.log('Query form not found!');
                }
            } else {
                console.log('Campaign not found after reload');
                alert('Job not found. Please try again.');
              }
            } else {
              console.log('No radio selected, showing manual input');
              // Query via menu: show input, hide form
              showSection('query-campaign');
              setQueryCampaignInputVisibility(true);
              const queryForm = document.getElementById('queryCampaignForm');
              if (queryForm) queryForm.classList.add('hidden');
            }
          });
        }

        // Manual campaign code entry logic for Query
  document.addEventListener('DOMContentLoaded', function() {
          addQueryCampaignMenuFunctionality();
            const queryLoadBtn = document.getElementById('queryLoadBtn');
            if (queryLoadBtn) {
              queryLoadBtn.addEventListener('click', function() {
                const code = document.getElementById('queryCampaignCodeInput').value.trim();
                if (!code) {
                  alert('Please enter a marketing code.');
                  return;
                }
                // Find by campaignId (not _id)
                const campaign = originalCampaigns.find(c => c.campaignId === code);
                if (!campaign) {
                  alert('Job not found.');
                  return;
                }
                // Simulate radio selection logic
                window.querySelectedCampaignById(campaign._id);
              });
            }
            // Update visibility on page load
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          setQueryCampaignInputVisibility(!selectedRadio);
            // Radio button change is handled by the main event listener below
          });
          // Helper to trigger query by _id
          window.querySelectedCampaignById = function(campaignId) {
            if (typeof window.querySelectedCampaign === 'function') {
              window.querySelectedCampaign(campaignId);
            }
          }
</script>
    </div>

    <!-- Export Section -->
    <div id="export-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Export All Jobs to Excel</h2>
              <button onclick="exportCampaigns()" class="btn-primary w-full py-2 rounded-md">Export Jobs</button>
    </div>

    <!-- Performance Tracking & Appreciation Section -->
    <div id="performance-tracking" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">üèÜ Performance Tracking & Appreciation</h2>
      
      <!-- Performance Overview Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
            <div class="p-2 bg-green-100 rounded-lg">
              <span class="text-green-600 text-xl">‚è∞</span>
        </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-600">On-Time Jobs</p>
              <p class="text-2xl font-semibold text-gray-900" id="onTimeCount">0</p>
      </div>
        </div>
      </div>

        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
            <div class="p-2 bg-blue-100 rounded-lg">
              <span class="text-blue-600 text-xl">‚≠ê</span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-600">Excellent Ratings</p>
              <p class="text-2xl font-semibold text-gray-900" id="excellentCount">0</p>
            </div>
            </div>
          </div>
          
        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
            <div class="p-2 bg-yellow-100 rounded-lg">
              <span class="text-yellow-600 text-xl">üèÖ</span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-600">Total Badges</p>
              <p class="text-2xl font-semibold text-gray-900" id="totalBadges">0</p>
          </div>
        </div>
      </div>

        <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
            <div class="p-2 bg-purple-100 rounded-lg">
              <span class="text-purple-600 text-xl">üë•</span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-600">Active Employees</p>
              <p class="text-2xl font-semibold text-gray-900" id="activeEmployees">0</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Rating Section (Admin Only) -->
      <div id="performanceRatingSection" class="bg-white p-6 rounded-lg border border-gray-200 mb-6" style="display: none;">
        <h3 class="text-lg font-semibold text-purple-700 mb-4">üìä Rate Job Performance</h3>
        <div class="space-y-4">
            <div>
            <label for="ratingJobSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Job to Rate</label>
            <select id="ratingJobSelect" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Choose a completed job...</option>
            </select>
            </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Performance Rating</label>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="rating-option rating-btn" data-rating="excellent">
                <div class="text-2xl mb-1">üåü</div>
                <div class="text-sm font-medium">Excellent</div>
              </button>
              <button type="button" class="rating-option rating-btn" data-rating="good">
                <div class="text-2xl mb-1">üëç</div>
                <div class="text-sm font-medium">Good</div>
              </button>
              <button type="button" class="rating-option rating-btn" data-rating="average">
                <div class="text-2xl mb-1">üëå</div>
                <div class="text-sm font-medium">Average</div>
              </button>
              <button type="button" class="rating-option rating-btn" data-rating="bad">
                <div class="text-2xl mb-1">üëé</div>
                <div class="text-sm font-medium">Bad</div>
              </button>
            </div>
            </div>
          
          <div>
            <label for="ratingComments" class="block text-sm font-medium text-gray-700 mb-2">Comments (Optional)</label>
            <textarea id="ratingComments" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Add feedback or comments about the job performance..."></textarea>
          </div>
          
          <div class="flex gap-2">
            <button id="submitRatingBtn" class="btn-primary px-4 py-2 rounded-md">Submit Rating</button>
            <button id="clearRatingBtn" class="btn-secondary px-4 py-2 rounded-md">Clear</button>
          </div>
        </div>
      </div>

      <!-- Badge Awarding Section (Admin Only) -->
      <div id="badgeAwardSection" class="bg-white p-6 rounded-lg border border-gray-200 mb-6" style="display: none;">
        <h3 class="text-lg font-semibold text-purple-700 mb-4">üèÖ Award Appreciation Badges</h3>
        <div class="space-y-4">
          <div>
            <label for="badgeJobSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Job for Badge</label>
            <select id="badgeJobSelect" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Choose a job...</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Badge Type</label>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="badge-option badge-btn" data-badge="on_time_completion">
                <div class="text-2xl mb-1">‚è∞</div>
                <div class="text-sm font-medium">On-Time Completion</div>
                <div class="text-xs text-gray-500">Meeting deadlines</div>
              </button>
              <button type="button" class="badge-option badge-btn" data-badge="fast_delivery">
                <div class="text-2xl mb-1">üöÄ</div>
                <div class="text-sm font-medium">Fast Delivery</div>
                <div class="text-xs text-gray-500">Completing ahead of schedule</div>
              </button>
              <button type="button" class="badge-option badge-btn" data-badge="innovation">
                <div class="text-2xl mb-1">üí°</div>
                <div class="text-sm font-medium">Innovation</div>
                <div class="text-xs text-gray-500">Creative solutions</div>
              </button>
              <button type="button" class="badge-option badge-btn" data-badge="problem_solver">
                <div class="text-2xl mb-1">üîß</div>
                <div class="text-sm font-medium">Problem Solver</div>
                <div class="text-xs text-gray-500">Overcoming challenges</div>
              </button>
              <button type="button" class="badge-option badge-btn" data-badge="team_player">
                <div class="text-2xl mb-1">ü§ù</div>
                <div class="text-sm font-medium">Team Player</div>
                <div class="text-xs text-gray-500">Collaboration excellence</div>
              </button>
        </div>
      </div>

          <div>
            <label for="badgeDescription" class="block text-sm font-medium text-gray-700 mb-2">Badge Description</label>
            <textarea id="badgeDescription" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Describe why this badge is being awarded..."></textarea>
          </div>
          
          <div class="flex gap-2">
            <button id="submitBadgeBtn" class="btn-primary px-4 py-2 rounded-md">Award Badge</button>
            <button id="clearBadgeBtn" class="btn-secondary px-4 py-2 rounded-md">Clear</button>
          </div>
        </div>
      </div>
      
      <!-- Employee Performance Leaderboard -->
      <div class="bg-white p-6 rounded-lg border border-gray-200 mb-6">
        <h3 class="text-lg font-semibold text-purple-700 mb-4">üèÜ Employee Performance Leaderboard</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jobs Completed</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">On-Time Rate</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Rating</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Badges</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody" class="bg-white divide-y divide-gray-200">
              <!-- Leaderboard data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Recent Performance Activity -->
      <div class="bg-white p-6 rounded-lg border border-gray-200">
        <h3 class="text-lg font-semibold text-purple-700 mb-4">üìà Recent Performance Activity</h3>
        <div id="recentActivity" class="space-y-3">
          <!-- Recent activity will be loaded here -->
        </div>
      </div>
    </div>

    <!-- User & Role Manager Section -->
    <div id="user-manager" class="section hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4">User & Role Manager</h2>
          <div class="flex gap-4 mb-6">
        <button id="toggleUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">User</button>
        <button id="toggleRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Role</button>
        <button id="toggleEmployeeBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Employee</button>
          </div>
          <div id="user-manager-user-section">
                      <div class="flex gap-4 mb-6">
                <button id="addUserBtn" class="btn-primary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add User</button>
                <button id="addRoleBtn" class="btn-secondary px-6 py-3 rounded-md font-medium text-lg w-[180px]">Add Role</button>
              </div>
        
        <!-- User Table -->
        <div id="user-table-section">
            <div class="w-full overflow-x-auto">
              <table class="crm-table w-full mb-6 whitespace-nowrap">
                <thead>
                  <tr>
                    <th class="text-lg font-bold">Username</th>
                    <th class="text-lg font-bold">Role</th>
                    <th class="text-lg font-bold">Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <!-- Users will be loaded here -->
                </tbody>
              </table>
          </div>
        </div>
        
        <!-- User Create Form -->
        <div id="user-create-form-section" class="hidden">
          <h2 class="text-3xl font-semibold text-purple-700 mb-4 text-left">Create New User</h2>
          
          <div class="w-full max-w-xl mx-auto">
            <form id="createUserForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end bg-white p-8 rounded-lg shadow">
              <div class="sm:col-span-2">
                <label for="newUserUsername" class="block text-sm font-medium text-purple-700">Username</label>
                <input id="newUserUsername" name="username" type="text" required autocomplete="username" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2">
                <label for="newUserPassword" class="block text-sm font-medium text-purple-700">Password</label>
                <input id="newUserPassword" name="password" type="password" required autocomplete="new-password" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
              </div>
              <div class="sm:col-span-2 flex flex-col">
                <label for="newUserRoles" class="block text-sm font-medium text-purple-700">Role</label>
                <select id="newUserRoles" name="roles" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full"></select>
              </div>
              <div class="col-span-full flex justify-end gap-2">
                <button type="button" id="cancelCreateUserBtn" class="btn-secondary py-2 px-6 rounded-md">Cancel</button>
                <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create User</button>
              </div>
            </form>
          </div>
            </div>
          </div>
          <div id="user-manager-role-section" class="hidden">
        <div class="w-full max-w-xl mx-auto mb-6 hidden" id="role-create-form-container">
              <form id="createRoleForm" class="grid grid-cols-1 gap-4 bg-white p-8 rounded-lg shadow">
                <div>
                  <label for="newRoleName" class="block text-sm font-medium text-purple-700">Role Name</label>
                  <input id="newRoleName" name="roleName" type="text" required class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full">
                </div>
            <div>
              <label for="newRoleDescription" class="block text-sm font-medium text-purple-700">Description</label>
              <textarea id="newRoleDescription" name="roleDescription" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" rows="3" placeholder="Describe what this role can do..."></textarea>
                </div>
            <div>
              <label class="block text-sm font-medium text-purple-700 mb-3">Permissions</label>
              <div class="grid grid-cols-1 gap-3">
                <div class="flex items-center">
                  <input type="checkbox" id="perm_create_jobs" name="permissions" value="create_jobs" class="mr-3">
                  <label for="perm_create_jobs" class="text-sm">Create Jobs</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_edit_jobs" name="permissions" value="edit_jobs" class="mr-3">
                  <label for="perm_edit_jobs" class="text-sm">Edit Jobs</label>
            </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_delete_jobs" name="permissions" value="delete_jobs" class="mr-3">
                  <label for="perm_delete_jobs" class="text-sm">Delete Jobs</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_jobs" name="permissions" value="view_jobs" class="mr-3" checked>
                  <label for="perm_view_jobs" class="text-sm">View Jobs</label>
        </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_view_reports" name="permissions" value="view_reports" class="mr-3">
                  <label for="perm_view_reports" class="text-sm">View Reports</label>
      </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_export_data" name="permissions" value="export_data" class="mr-3">
                  <label for="perm_export_data" class="text-sm">Export Data</label>
    </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_users" name="permissions" value="manage_users" class="mr-3">
                  <label for="perm_manage_users" class="text-sm">Manage Users</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_roles" name="permissions" value="manage_roles" class="mr-3">
                  <label for="perm_manage_roles" class="text-sm">Manage Roles</label>
          </div>
                <div class="flex items-center">
                  <input type="checkbox" id="perm_manage_employees" name="permissions" value="manage_employees" class="mr-3">
                  <label for="perm_manage_employees" class="text-sm">Manage Employees</label>
          </div>
              </div>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" id="backToRolesBtn" class="btn-secondary py-2 px-6 rounded-md">Back to Roles</button>
              <button type="submit" class="btn-primary py-2 px-6 rounded-md">Create Role</button>
          </div>
        </form>
        </div>
        <div class="w-full max-w-xl mx-auto" id="roles-table-container">
          <div class="mb-3">
            <h3 class="text-lg font-semibold text-purple-700">Roles</h3>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role Name</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="roles-table-body">
                <!-- Roles will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Employee Manager Section -->
      <div id="user-manager-employee-section" class="hidden">
        <!-- Add Employee Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
          <h3 class="text-lg font-semibold text-purple-700 mb-4">Add New Employee</h3>
          <form id="createEmployeeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="newEmployeeName" class="block text-sm font-medium text-purple-700">Employee Name</label>
              <input id="newEmployeeName" type="text" required class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label for="newEmployeeWhatsApp" class="block text-sm font-medium text-purple-700">WhatsApp Number</label>
              <input id="newEmployeeWhatsApp" type="tel" placeholder="+1234567890" required class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label for="newEmployeeDepartment" class="block text-sm font-medium text-purple-700">Department</label>
              <input id="newEmployeeDepartment" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label for="newEmployeePosition" class="block text-sm font-medium text-purple-700">Position</label>
              <input id="newEmployeePosition" type="text" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="md:col-span-2">
              <button type="submit" class="btn-primary py-2 px-4 rounded-md">Add Employee</button>
              <button type="button" onclick="window.clearEmployeeForm()" class="btn-secondary py-2 px-4 rounded-md ml-2">Clear</button>
            </div>
          </form>
    </div>

        <!-- Employees Table -->
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Employee Name</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">WhatsApp</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Department</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Position</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
              </tr>
            </thead>
            <tbody id="employees-table-body">
              <!-- Employee rows will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- Delete Campaign Section -->
    <div id="delete-campaign" class="section hidden">
      <h2 class="text-lg font-semibold text-purple-700 mb-4">Delete Job</h2>
      <div class="space-y-6">
        
        <div id="deleteSelectedContainer" class="hidden">
          <div class="bg-white p-6 rounded-lg shadow-md border border-purple-200">
            <h3 class="text-lg font-semibold text-purple-700 mb-4">Confirm Job Deletion</h3>
            <div id="deleteJobDetails" class="mb-4">
              <!-- Job details will be loaded here -->
        </div>
            <div class="flex gap-4">
              <button id="confirmDeleteBtn" class="btn-primary py-2 px-4 rounded-md">
                Delete
              </button>
              <button id="cancelDeleteBtn" class="btn-secondary py-2 px-4 rounded-md">
                Cancel
              </button>
            </div>
          </div>
        </div>
        
        <div id="deleteResultMsg" class="hidden mt-4"></div>
      </div>
      <script>
        // Simple delete click handler
        function handleDeleteClick() {
          console.log('[DEBUG] Delete button clicked');
          
            // Check if user has permission to delete campaigns
          if (window.sessionManager && !window.sessionManager.canDeleteJobs()) {
            window.sessionManager.showPermissionDenied('delete');
              return;
            }
          
            const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          
            if (selectedRadio) {
            // Radio button selected - show confirmation form
            console.log('[DEBUG] Radio selected, showing delete confirmation');
              showSection('delete-campaign');
              const campaignId = selectedRadio.value;
            window.deleteSelectedCampaign(campaignId);
            } else {
            // No radio selected - show text input box
            console.log('[DEBUG] No radio selected, showing text input');
              showSection('delete-campaign');
            showManualDeleteInput();
          }
        }

        // Function to show manual delete input (when no radio selected)
        function showManualDeleteInput() {
          const deleteSelectedContainer = document.getElementById('deleteSelectedContainer');
          if (deleteSelectedContainer) {
            deleteSelectedContainer.style.display = 'block';
            deleteSelectedContainer.innerHTML = `
              <div class="bg-white border border-purple-200 rounded-lg p-6 shadow-lg">
                <h3 class="text-lg font-semibold text-purple-700 mb-4">Enter Job ID to Delete</h3>
                <div class="mb-4">
                  <input type="text" id="manualDeleteJobId" placeholder="Enter Job ID (e.g., JOB_00001)" 
                         class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex gap-4">
                  <button onclick="deleteJobById()" class="btn-primary py-2 px-4 rounded-md">
                    Delete
                  </button>
                  <button onclick="hideDeleteConfirmation()" class="btn-secondary py-2 px-4 rounded-md">
                    Cancel
                  </button>
                </div>
              </div>
            `;
          }
        }

        // Function to delete job by ID (manual input)
        async function deleteJobById() {
          const jobIdInput = document.getElementById('manualDeleteJobId');
          const jobId = jobIdInput.value.trim();
          
          if (!jobId) {
            alert('Please enter a Job ID.');
                return;
              }
          
          // Find campaign by campaignId
          const campaign = originalCampaigns.find(c => c.campaignId === jobId);
              if (!campaign) {
            alert('Job not found with ID: ' + jobId);
                return;
              }
          
              try {
                const response = await fetch(`/api/campaigns/${campaign._id}`, {
                  method: 'DELETE',
              headers: getAuthHeaders()
                });
            
                if (response.ok) {
              alert('Job deleted successfully!');
              hideDeleteConfirmation();
              // Show campaigns table and reload it
              console.log('[DEBUG] Job deleted successfully, refreshing campaigns table...');
              showSection('campaigns-table');
              setTimeout(() => {
                loadCampaignsTable();
              }, 100);
            } else {
              const error = await response.json();
              alert(`Failed to delete job: ${error.error || 'Unknown error'}`);
            }
          } catch (error) {
            console.error('Error deleting job:', error);
            alert('Error deleting job.');
          }
        }

        // Function to hide delete confirmation
        function hideDeleteConfirmation() {
          const deleteContainer = document.getElementById('deleteSelectedContainer');
          if (deleteContainer) {
            deleteContainer.style.display = 'none';
            deleteContainer.innerHTML = '';
          }
        }

        // Function to handle radio button selection for delete
        window.deleteSelectedCampaign = async function(campaignId) {
          console.log('deleteSelectedCampaign called with ID:', campaignId);
          
          if (!campaignId) {
            alert('Please select a job to delete.');
                return;
              }
              
          try {
            // Find the campaign in originalCampaigns
            let campaign = originalCampaigns.find(c => c._id === campaignId);
            
            if (!campaign) {
              console.log('Campaign not found in originalCampaigns, reloading data...');
              const response = await fetch('/api/campaigns', {
                headers: getAuthHeaders()
              });
              if (response.ok) {
                originalCampaigns = await response.json();
                campaign = originalCampaigns.find(c => c._id === campaignId);
              }
            }

              if (!campaign) {
              alert('Job not found.');
                return;
              }

            // Show delete confirmation with job details
            showDeleteConfirmation(campaign);
            
          } catch (error) {
            console.error('Error loading job for deletion:', error);
            alert('Error loading job details.');
          }
        };

        function showDeleteConfirmation(campaign) {
          console.log('[DEBUG] showDeleteConfirmation called with campaign:', campaign);
          const deleteContainer = document.getElementById('deleteSelectedContainer');
          
          if (!deleteContainer) {
            console.log('[DEBUG] deleteContainer not found');
            return;
          }

          // Show simple confirmation form
          deleteContainer.style.display = 'block';
          deleteContainer.innerHTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-lg">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Delete</h3>
              <div class="mb-4">
                <p class="text-gray-600 mb-2">Are you sure you want to delete this job?</p>
                <div class="bg-gray-50 p-3 rounded-md">
                  <p><strong>Job ID:</strong> ${campaign.campaignId || 'N/A'}</p>
                  <p><strong>Name:</strong> ${campaign.name || 'N/A'}</p>
                  <p><strong>Description:</strong> ${campaign.description || 'N/A'}</p>
                  <p><strong>Status:</strong> ${campaign.status || 'N/A'}</p>
                  <p><strong>Entry Date:</strong> ${campaign.entryDate ? new Date(campaign.entryDate).toLocaleDateString() : 'N/A'}</p>
                  <p><strong>Planned Start Date:</strong> ${campaign.plannedStartDate ? new Date(campaign.plannedStartDate).toLocaleDateString() : 'N/A'}</p>
                  <p><strong>Actual Start Date:</strong> ${campaign.startDate ? new Date(campaign.startDate).toLocaleDateString() : 'N/A'}</p>
                  <p><strong>End Date:</strong> ${campaign.endDate ? new Date(campaign.endDate).toLocaleDateString() : 'N/A'}</p>
                  <p><strong>Assigned Employees:</strong> ${campaign.assignedEmployees && campaign.assignedEmployees.length > 0 ? 
                    campaign.assignedEmployees.map(emp => emp.employeeName || emp.employeeId).join(', ') : 
                    (campaign.jobAssignedTo || 'N/A')}</p>
                </div>
              </div>
              <div class="flex gap-4">
                <button onclick="confirmDeleteJob('${campaign._id}')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md">
                  Confirm Delete
                </button>
                <button onclick="hideDeleteConfirmation()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md">
                  Cancel
                </button>
              </div>
            </div>
          `;
        }

        // Function to confirm deletion
        async function confirmDeleteJob(campaignId) {
          console.log('confirmDeleteJob called with campaignId:', campaignId);
          
          if (!campaignId) {
            alert('No job selected for deletion.');
            return;
          }


          try {
            console.log('Sending DELETE request to:', `/api/campaigns/${campaignId}`);
            
            const response = await fetch(`/api/campaigns/${campaignId}`, {
              method: 'DELETE',
              headers: getAuthHeaders()
            });

            console.log('Delete response status:', response.status);
            const result = await response.json();
            console.log('Delete response result:', result);

            if (response.ok) {
              alert('Job deleted successfully!');
              hideDeleteConfirmation();
              // Show campaigns table and reload it
              console.log('[DEBUG] Job deleted successfully, refreshing campaigns table...');
              showSection('campaigns-table');
              setTimeout(() => {
                if (typeof loadCampaignsTable === 'function') {
                  loadCampaignsTable();
                }
              }, 100);
                } else {
              alert('Error deleting job: ' + result.error);
                }
              } catch (error) {
            console.error('Error deleting job:', error);
            alert('Failed to delete job: ' + error.message);
          }
        }

        // Function to cancel deletion
        function cancelDeleteJob() {
          const deleteContainer = document.getElementById('deleteSelectedContainer');
          deleteContainer.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', function() {
          // Ensure delete section is properly hidden on page load
          const deleteSection = document.getElementById('delete-campaign');
          if (deleteSection) {
            deleteSection.classList.add('hidden');
          }
          
          
          
        });
      </script>
    </div>
  </div>

  <script>
    // Helper function to get auth token
    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    // Helper function to get auth headers
    function getAuthHeaders() {
      const token = getAuthToken();
      console.log('üîç getAuthHeaders debug:');
      console.log('Token present:', token ? 'Yes' : 'No');
      console.log('Token value:', token ? token.substring(0, 20) + '...' : 'null');
      
      if (!token) {
        console.error('‚ùå No auth token found in localStorage');
        alert('Authentication error: Please log in again.');
        return {
          'Content-Type': 'application/json'
        };
      }
      
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    // Employee Management Functions
    function addEmployeeEntry() {
      // Check if user is logged in
      const token = getAuthToken();
      if (!token) {
        alert('Please log in first to add employees to jobs.');
        return;
      }

      // Find the container - could be in main form or edit form
      let container = document.getElementById('assignedEmployeesContainer');
      
      // If not found in main document, look in edit form
      if (!container) {
        const editForm = document.getElementById('editCampaignForm');
        if (editForm) {
          container = editForm.querySelector('#assignedEmployeesContainer');
        }
      }
      
      if (!container) {
        console.error('‚ùå assignedEmployeesContainer not found');
        console.log('Searched in main document and edit form');
        alert('Error: Employee container not found');
        return;
      }
      
      console.log('‚úÖ Found assignedEmployeesContainer:', container);
      
      const employeeEntry = document.createElement('div');
      employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
      
      employeeEntry.innerHTML = `
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
          <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select Employee</option>
            </select>
          </div>
        <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
          ‚úï
              </button>
      `;
      
      container.appendChild(employeeEntry);
      
      // Load employees into the new dropdown
      loadEmployeesIntoSelect(employeeEntry.querySelector('.employee-select'));
      
      // Add real-time validation
      const select = employeeEntry.querySelector('.employee-select');
      select.addEventListener('change', validateEmployeeSelections);
    }

    function removeEmployeeEntry(button) {
      button.closest('.employee-entry').remove();
      // Re-validate after removing an entry
      validateEmployeeSelections();
    }

    // Function to add progress detail entry
    function addProgressDetail() {
      const container = document.getElementById('progressDetailsContainer');
      const detailId = 'progress_' + Date.now();
      
      const detailHTML = `
        <div id="${detailId}" class="bg-white p-4 rounded-lg border border-gray-200 mb-3">
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" class="progress-date w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="flex items-end">
              <button type="button" onclick="removeProgressDetail('${detailId}')" class="text-gray-500 hover:text-gray-700 px-2 py-2">
                ‚úï
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Description</label>
            <textarea class="progress-description w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Enter progress details..."></textarea>
          </div>
            </div>
      `;
      
      container.insertAdjacentHTML('beforeend', detailHTML);
    }
    
    // Function to remove progress detail entry
    function removeProgressDetail(detailId) {
      const element = document.getElementById(detailId);
      if (element) {
        element.remove();
      }
    }
    
    // Function to handle file upload
    function handleFileUpload() {
      const fileInput = document.getElementById('fileUpload');
      const fileList = document.getElementById('fileList');
      
      if (fileInput.files.length > 0) {
        fileList.innerHTML = '';
        
        Array.from(fileInput.files).forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
          fileItem.innerHTML = `
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-700">${file.name}</span>
              <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
            </div>
            <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-800 text-sm">
              ‚úï
            </button>
          `;
          fileList.appendChild(fileItem);
        });
      }
    }
    
    // Function to remove file from list
    function removeFile(index) {
      const fileInput = document.getElementById('fileUpload');
      const dt = new DataTransfer();
      
      Array.from(fileInput.files).forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      fileInput.files = dt.files;
      handleFileUpload();
    }
    
    // Function to validate employee selections in real-time
    function validateEmployeeSelections() {
      console.log('üîç [DEBUG] validateEmployeeSelections called');
      
      // Get employee entries from the currently visible form only
      let employeeEntries = [];
      
      // Check if we're in the new campaign form
      const newCampaignForm = document.getElementById('new-campaign');
      if (newCampaignForm && !newCampaignForm.classList.contains('hidden')) {
        employeeEntries = document.querySelectorAll('#new-campaign .employee-entry');
        console.log('üîç Validating NEW job form, found entries:', employeeEntries.length);
      }
      
      // Check if we're in the edit form
      const editForm = document.getElementById('editCampaignForm');
      if (editForm && !editForm.classList.contains('hidden')) {
        employeeEntries = document.querySelectorAll('#editAssignedEmployeesContainer .employee-entry');
        console.log('üîç Validating EDIT job form, found entries:', employeeEntries.length);
      }
      
      const selectedEmployees = [];
      const duplicateEmployees = [];
      
      employeeEntries.forEach((entry, index) => {
        const employeeSelect = entry.querySelector('.employee-select');
        if (employeeSelect && employeeSelect.value && employeeSelect.value !== '') {
          console.log(`üîç Checking employee ${index + 1}: ${employeeSelect.value}`);
          if (selectedEmployees.includes(employeeSelect.value)) {
            duplicateEmployees.push(employeeSelect.value);
            console.log(`‚ùå Duplicate found: ${employeeSelect.value}`);
            // Highlight the duplicate selection
            employeeSelect.style.borderColor = '#EF4444';
            employeeSelect.style.backgroundColor = '#FEF2F2';
          } else {
            selectedEmployees.push(employeeSelect.value);
            console.log(`‚úÖ Valid selection: ${employeeSelect.value}`);
            // Reset styling for valid selection
            employeeSelect.style.borderColor = '';
            employeeSelect.style.backgroundColor = '';
          }
        }
      });
      
      console.log('üîç Final selected employees in THIS job:', selectedEmployees);
      console.log('üîç Duplicate employees in THIS job:', duplicateEmployees);
      console.log('üîç Validation result:', duplicateEmployees.length === 0);
      
      // If there are duplicates, show a warning
      if (duplicateEmployees.length > 0) {
        console.warn('‚ö†Ô∏è Duplicate employee selections detected in THIS job:', duplicateEmployees);
        // You could show a subtle warning here if needed
      }
      
      return duplicateEmployees.length === 0; // Return true if no duplicates
    }

    async function loadEmployeesIntoSelect(selectElement) {
      try {
        console.log('üîç Loading employees into dropdown...');
        const token = getAuthToken();
        console.log('Auth token:', token ? 'Present' : 'Missing');
        
        const response = await fetch('/api/employees', {
          headers: getAuthHeaders()
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error:', response.status, errorText);
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const employees = await response.json();
        console.log('Employees loaded:', employees.length);
        
        employees.forEach(employee => {
          if (employee.status === 'active') {
            const option = document.createElement('option');
            option.value = employee.name;
            option.textContent = employee.name;
            selectElement.appendChild(option);
          }
        });
        
        console.log('‚úÖ Employee dropdown populated successfully');
      } catch (error) {
        console.error('‚ùå Error loading employees:', error);
        // Show error in dropdown
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading employees';
        selectElement.appendChild(option);
      }
    }

    // Add employee entry specifically for edit form
    function addEmployeeEntryForEditForm() {
      // Check if user is logged in
      const token = getAuthToken();
      if (!token) {
        alert('Please log in first to add employees to jobs.');
        return;
      }
      
      // Find the edit form container
      const container = document.getElementById('editAssignedEmployeesContainer');
      
      if (!container) {
        console.error('‚ùå editAssignedEmployeesContainer not found');
        alert('Error: Edit form employee container not found');
        return;
      }
      
      console.log('‚úÖ Found editAssignedEmployeesContainer:', container);
      
      const employeeEntry = document.createElement('div');
      employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
      
      employeeEntry.innerHTML = `
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
          <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select Employee</option>
          </select>
        </div>
        <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
          ‚úï
        </button>
      `;
      
      container.appendChild(employeeEntry);
      
      // Load employees into the new dropdown
      const selectElement = employeeEntry.querySelector('.employee-select');
      loadEmployeesIntoSelect(selectElement);
      
      // Add change event listener to prevent duplicate selections
      selectElement.addEventListener('change', function() {
        validateEmployeeSelections();
      });
      
      console.log('‚úÖ Added new employee entry to edit form');
    }

    // Load assigned employees into edit form
    async function loadAssignedEmployeesIntoEditForm(editForm, campaign) {
      try {
        const assignedEmployeesContainer = editForm.querySelector('#editAssignedEmployeesContainer');
        if (!assignedEmployeesContainer) {
          console.log('editAssignedEmployeesContainer not found in edit form');
          return;
        }
        
        // Clear existing employee entries
        assignedEmployeesContainer.innerHTML = '';
        
        // Load assigned employees from campaign data
        if (campaign.assignedEmployees && Array.isArray(campaign.assignedEmployees)) {
          for (const employee of campaign.assignedEmployees) {
            // Create employee entry
            const employeeEntry = document.createElement('div');
            employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
            
            employeeEntry.innerHTML = `
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
                <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Select Employee</option>
            </select>
          </div>
              <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
                ‚úï
            </button>
            `;
            
            assignedEmployeesContainer.appendChild(employeeEntry);
            
            // Load employees into the dropdown
            await loadEmployeesIntoSelect(employeeEntry.querySelector('.employee-select'));
            
            // Set the selected employee
            const select = employeeEntry.querySelector('.employee-select');
            // Match by employee name
            select.value = employee.employeeName || employee.employeeId || '';
            
            // Add change event listener to prevent duplicate selections
            select.addEventListener('change', function() {
              validateEmployeeSelections();
            });
          }
        }
        
        console.log('‚úÖ Assigned employees loaded into edit form');
      } catch (error) {
        console.error('‚ùå Error loading assigned employees into edit form:', error);
      }
    }

    // A variation of addChannelEntry for the edit form to ensure correct scoping
    // Channel functionality removed - this function is no longer needed

    async function submitCampaignUpdate() {
      try {
        // Check if user is logged in
        const token = getAuthToken();
        if (!token) {
          alert('Please log in first to update jobs.');
          return;
        }
        
        // Get the edit form
        const editForm = document.getElementById('editCampaignForm');
        
        // Validate category selection
        const editCategorySelects = editForm.querySelectorAll('.targetCategory');
        // All dropdowns must be selected (not empty)
        const allCategoriesSelected = Array.from(editCategorySelects).every(select => select.value && select.value.trim() !== '');
        if (!allCategoriesSelected) {
          alert('‚ö†Ô∏è Warning: Please select a category for every row before updating the job.');
          return;
        }
        
        // Validate Status (mandatory)
        const status = editForm.querySelector('#status')?.value;
        if (!status || status.trim() === '') {
          alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this job.');
          return;
        }
        
        // Validate Planned Start Date (mandatory only when status is "Planned")
        const plannedStartDate = editForm.querySelector('#plannedStartDate')?.value;
        if (status === 'Planned' && (!plannedStartDate || plannedStartDate.trim() === '')) {
          alert('‚ö†Ô∏è Warning: Planned Start Date is mandatory when status is "Planned". Please select a planned start date for this job.');
          return;
        }
        
        if (!editForm) {
          throw new Error('Edit form not found');
        }

        // Get the MongoDB _id from the hidden input
        const mongoIdInput = editForm.querySelector('#editCampaignMongoId');
        if (!mongoIdInput || !mongoIdInput.value) {
          throw new Error('Campaign ID for update not found');
        }
        const campaignId = mongoIdInput.value;

        // Gather all categories and tags
        const categorySelects = editForm.querySelectorAll('.targetCategory');
        const tagInputs = editForm.querySelectorAll('.categoryTag');
        const categories = Array.from(categorySelects).map((sel, idx) => {
          return {
            category: sel.value,
            tag: tagInputs[idx] ? tagInputs[idx].value : ''
          };
        }).filter(obj => obj.category);

        // Get all form fields
        const formData = {
          campaignId: editForm.querySelector('#campaignId')?.value || '',
          name: editForm.querySelector('#name')?.value || '',
          description: editForm.querySelector('#description')?.value || '',
          plannedStartDate: editForm.querySelector('#plannedStartDate')?.value || '',
          startDate: editForm.querySelector('#startDate')?.value || '',
          endDate: editForm.querySelector('#endDate')?.value || '',
          budget: parseFloat(editForm.querySelector('#budget')?.value) || 0,
          status: editForm.querySelector('#status')?.value || 'Active',
          jobAssignedTo: editForm.querySelector('#jobAssignedTo')?.value || '',
          targetAudience: {
            age: editForm.querySelector('#targetAge')?.value || '',
            gender: editForm.querySelector('#targetGender')?.value || 'All',
            categories: categories
          },
          goals: {
            sales: parseFloat(editForm.querySelector('#goalSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#goalImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#goalConversions')?.value) || 0,
          },
          achieved: {
            sales: parseFloat(editForm.querySelector('#achievedSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#achievedImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#achievedConversions')?.value) || 0,
          },
          channels: []
        };

        // Collect assigned employees from edit form
        const assignedEmployees = [];
        const editEmployeeEntries = editForm.querySelectorAll('#editAssignedEmployeesContainer .employee-entry');
        editEmployeeEntries.forEach(entry => {
          const employeeSelect = entry.querySelector('.employee-select');
          if (employeeSelect.value) {
            assignedEmployees.push({
              employeeId: employeeSelect.value,
              employeeName: employeeSelect.value
            });
          }
        });

        // Validate that all employee entries have selected employees
        const unselectedEmployees = [];
        editEmployeeEntries.forEach((entry, index) => {
          const employeeSelect = entry.querySelector('.employee-select');
          if (!employeeSelect.value || employeeSelect.value === '') {
            unselectedEmployees.push(index + 1);
          }
        });

        if (unselectedEmployees.length > 0) {
          alert(`‚ö†Ô∏è Warning: Please select an employee for all employee entries.\n\nUnselected entries: ${unselectedEmployees.join(', ')}`);
          return;
        }

        // Validate that no employee is selected more than once (only within this form)
        if (!validateEmployeeSelections()) {
          alert(`‚ö†Ô∏è Warning: Some employees are selected more than once in this job.\n\nPlease select each employee only once.`);
          return;
        }

        // Add assigned employees to form data
        formData.assignedEmployees = assignedEmployees;

        // Collect progress details
        const progressDetails = [];
        const progressEntries = editForm.querySelectorAll('#progressDetailsContainer > div');
        progressEntries.forEach(entry => {
          const date = entry.querySelector('.progress-date')?.value;
          const description = entry.querySelector('.progress-description')?.value;
          if (date && description) {
            progressDetails.push({ date, description });
          }
        });
        formData.progressDetails = progressDetails;

        // Collect file attachments
        const fileInput = editForm.querySelector('#fileUpload');
        const files = fileInput ? Array.from(fileInput.files) : [];
        formData.files = files;

        // Add priority
        formData.priority = editForm.querySelector('#priority')?.value || 'No Priority';

        console.log('Form data for update:', formData);

        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ campaignData: formData })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server returned an error: ${errorText}`);
        }

        const result = await response.json();
        console.log('Update result:', result);

        alert('Job updated successfully!');
        
        // Hide the edit form
        const editFormContainer = document.getElementById('editCampaignFormContainer');
        if (editFormContainer) {
          editFormContainer.classList.add('hidden');
        }
        
        // Show the campaigns table
        showSection('campaigns-table');
        
        // Refresh the campaigns table
        loadCampaignsTable();
        
      } catch (error) {
        console.error('Error updating campaign:', error);
        alert(`Failed to update job: ${error.message}`);
      }
    }

    // Update loadCampaignForEdit to prevent empty input
    async function loadCampaignForEdit() {
      const campaignId = document.getElementById('editCampaignId').value.trim();
      if (!campaignId) {
        alert('Please enter a Job ID.');
        return;
      }
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          headers: getAuthHeaders()
        });
        const result = await response.json();
        if (response.ok) {
          setEditCampaignInputVisibility(false);
          await loadCampaignForEditDirect(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function loadCampaignForEditDirect(campaign) {
      // Clone the new campaign form
      const newCampaignFormTemplate = document.querySelector('#new-campaign .space-y-6');
      const editFormContainer = document.getElementById('editCampaignForm');
      
      // Clear previous content
      editFormContainer.innerHTML = '';

      // Create a new form element and append cloned children
      const editForm = document.createElement('div');
      editForm.className = newCampaignFormTemplate.className; // Copy classes
      
      Array.from(newCampaignFormTemplate.children).forEach(child => {
          editForm.appendChild(child.cloneNode(true));
      });

      // Add hidden input for MongoDB _id
      const hiddenIdInput = document.createElement('input');
      hiddenIdInput.type = 'hidden';
      hiddenIdInput.id = 'editCampaignMongoId';
      hiddenIdInput.value = campaign._id;
      editForm.appendChild(hiddenIdInput);
      
      // Fill in the form with campaign data
      fillFormWithCampaignData(editForm, campaign);

      // Fix ID conflict by giving edit form container a unique ID
      const assignedEmployeesContainer = editForm.querySelector('#assignedEmployeesContainer');
      if (assignedEmployeesContainer) {
        assignedEmployeesContainer.id = 'editAssignedEmployeesContainer';
        console.log('‚úÖ Changed edit form container ID to editAssignedEmployeesContainer');
      }

      // Load assigned employees into the edit form
      await loadAssignedEmployeesIntoEditForm(editForm, campaign);

      // Attach Add Employee button functionality to edit form
      const addEmployeeBtn = editForm.querySelector('button[onclick="addEmployeeEntry()"]');
      console.log('üîç Looking for Add Employee button in edit form:', addEmployeeBtn);
      if (addEmployeeBtn) {
        console.log('‚úÖ Found Add Employee button, attaching click handler');
        addEmployeeBtn.onclick = function() {
          console.log('Add Employee button clicked in edit form');
          addEmployeeEntryForEditForm();
        };
      } else {
        console.log('‚ùå Add Employee button not found in edit form');
      }

      // Modify the submit button to handle updates
      const submitButton = editForm.querySelector('button[onclick="submitCampaign()"]');
      if (submitButton) {
         submitButton.onclick = () => submitCampaignUpdate();
         submitButton.textContent = 'Update Campaign';
      }
      
      // Show the form
      editFormContainer.appendChild(editForm);
      editFormContainer.classList.remove('hidden');

      // Channel functionality removed - no longer needed

       // Channel functionality removed - no longer needed
        
        // Re-attach category removal event listeners AFTER form data is filled
        updateRemoveCategoryBtns();
        
        // Re-attach add category button functionality for edit form
        const editAddCategoryBtn = editForm.querySelector('#addCategoryBtn');
        if (editAddCategoryBtn) {
            editAddCategoryBtn.onclick = function() {
                console.log('Add Category button clicked in edit form');
                const catContainer = editForm.querySelector('#targetCategoryContainer');
                const div = document.createElement('div');
                div.className = 'targetCategorySelect flex flex-wrap items-center gap-2';
                div.innerHTML = `<select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Select Category</option>
                    <option>Tourist</option>
                    <option>Resident</option>
                    <option>All Walkin</option>
                    <option>Social Media</option>
                    <option>Social Groups</option>
                    <option>What'sup group</option>
                    <option>Corporates</option>
                    <option>Residential Cmty</option>
                    <option>Local Cmty</option>
                    <option>Blue collar wrkrs</option>
                    <option>Existing cutomers</option>
                    <option>HNTW</option>
                    <option>Channel Partner</option>
                    <option>DGJG</option>
                    <option>Hotels</option>
                    <option>Tourism Companies</option>
                    <option>Tour Drivers</option>
                    <option>Other Tours Assctd cmpy</option>
                    <option>Festival & Occasion Buyers</option>
                    <option>Product Launch</option>
                </select><input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tag"><button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>`;
                catContainer.appendChild(div);
                updateRemoveCategoryBtns();
            };
        }
    }

    function fillFormWithCampaignData(form, campaign) {
      console.log('=== fillFormWithCampaignData called ===');
      console.log('Form element:', form);
      console.log('Campaign data:', campaign);
      console.log('Campaign structure:', {
        _id: campaign._id,
        campaignId: campaign.campaignId,
        name: campaign.name,
        priority: campaign.priority
      });
      
      // Fill in basic fields
      const campaignIdInput = form.querySelector('#campaignId');
      if (campaignIdInput) campaignIdInput.value = campaign.campaignId || '';
      const nameInput = form.querySelector('#name');
      if (nameInput) nameInput.value = campaign.name || '';
      const descInput = form.querySelector('#description');
      if (descInput) descInput.value = campaign.description || '';
      const plannedStartDateInput = form.querySelector('#plannedStartDate');
      if (plannedStartDateInput) plannedStartDateInput.value = campaign.plannedStartDate || '';
      const startDateInput = form.querySelector('#startDate');
      if (startDateInput) startDateInput.value = campaign.startDate || '';
      const endDateInput = form.querySelector('#endDate');
      if (endDateInput) endDateInput.value = campaign.endDate || '';
      const budgetInput = form.querySelector('#budget');
      if (budgetInput) budgetInput.value = campaign.budget || '';
      const statusInput = form.querySelector('#status');
      if (statusInput) {
        statusInput.value = campaign.status || '';
        
        // Add event listener for status change to validate Planned Start Date
        statusInput.addEventListener('change', function() {
          const plannedStartDateInput = form.querySelector('#plannedStartDate');
          if (this.value === 'Planned' && (!plannedStartDateInput.value || plannedStartDateInput.value.trim() === '')) {
            alert('‚ö†Ô∏è Warning: Planned Start Date is now required since status changed to "Planned". Please select a planned start date for this job.');
            plannedStartDateInput.focus();
          }
        });
      }
      const jobAssignedToSelect = form.querySelector('#jobAssignedTo');
      if (jobAssignedToSelect) {
        // Set the value if it exists in the dropdown options
        const optionExists = Array.from(jobAssignedToSelect.options).some(option => option.value === campaign.jobAssignedTo);
        if (optionExists) {
          jobAssignedToSelect.value = campaign.jobAssignedTo || '';
        } else {
          // If the assigned user doesn't exist in current users, add it as an option
          if (campaign.jobAssignedTo) {
            const option = document.createElement('option');
            option.value = campaign.jobAssignedTo;
            option.textContent = campaign.jobAssignedTo;
            jobAssignedToSelect.appendChild(option);
            jobAssignedToSelect.value = campaign.jobAssignedTo;
          }
        }
      }

      // Fill in priority
      const priorityInput = form.querySelector('#priority');
      if (priorityInput) priorityInput.value = campaign.priority || '';

      // Channel functionality removed - no longer needed
    }


    // Employee Management Functions
    function addEmployeeEntry() {
      // Check if user is logged in
      const token = getAuthToken();
      if (!token) {
        alert('Please log in first to add employees to jobs.');
        return;
      }
      
      // Find the container - could be in main form or edit form
      let container = document.getElementById('assignedEmployeesContainer');
      
      // If not found in main document, look in edit form
      if (!container) {
        const editForm = document.getElementById('editCampaignForm');
        if (editForm) {
          container = editForm.querySelector('#assignedEmployeesContainer');
        }
      }
      
      if (!container) {
        console.error('‚ùå assignedEmployeesContainer not found');
        console.log('Searched in main document and edit form');
        alert('Error: Employee container not found');
        return;
      }
      
      console.log('‚úÖ Found assignedEmployeesContainer:', container);
      
      const employeeEntry = document.createElement('div');
      employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
      
      employeeEntry.innerHTML = `
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
          <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select Employee</option>
          </select>
        </div>
        <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
          ‚úï
              </button>
      `;
      
      container.appendChild(employeeEntry);
      
      // Load employees into the new dropdown
      const selectElement = employeeEntry.querySelector('.employee-select');
      loadEmployeesIntoSelect(selectElement);
      
      // Add change event listener to prevent duplicate selections
      selectElement.addEventListener('change', function() {
        validateEmployeeSelections();
      });
    }

    function removeEmployeeEntry(button) {
      button.closest('.employee-entry').remove();
      // Re-validate after removing an entry
      validateEmployeeSelections();
    }

    // Function to add progress detail entry
    function addProgressDetail() {
      const container = document.getElementById('progressDetailsContainer');
      const detailId = 'progress_' + Date.now();
      
      const detailHTML = `
        <div id="${detailId}" class="bg-white p-4 rounded-lg border border-gray-200 mb-3">
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" class="progress-date w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="flex items-end">
              <button type="button" onclick="removeProgressDetail('${detailId}')" class="text-gray-500 hover:text-gray-700 px-2 py-2">
                ‚úï
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Description</label>
            <textarea class="progress-description w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Enter progress details..."></textarea>
          </div>
            </div>
      `;
      
      container.insertAdjacentHTML('beforeend', detailHTML);
    }
    
    // Function to remove progress detail entry
    function removeProgressDetail(detailId) {
      const element = document.getElementById(detailId);
      if (element) {
        element.remove();
      }
    }
    
    // Function to handle file upload
    function handleFileUpload() {
      const fileInput = document.getElementById('fileUpload');
      const fileList = document.getElementById('fileList');
      
      if (fileInput.files.length > 0) {
        fileList.innerHTML = '';
        
        Array.from(fileInput.files).forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
          fileItem.innerHTML = `
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-700">${file.name}</span>
              <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
            </div>
            <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-800 text-sm">
              ‚úï
            </button>
          `;
          fileList.appendChild(fileItem);
        });
      }
    }
    
    // Function to remove file from list
    function removeFile(index) {
      const fileInput = document.getElementById('fileUpload');
      const dt = new DataTransfer();
      
      Array.from(fileInput.files).forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      fileInput.files = dt.files;
      handleFileUpload();
    }

    // Add employee entry specifically for edit form
    function addEmployeeEntryForEditForm() {
      // Check if user is logged in
      const token = getAuthToken();
      if (!token) {
        alert('Please log in first to add employees to jobs.');
        return;
      }
      
      // Find the edit form container
      const container = document.getElementById('editAssignedEmployeesContainer');
      
      if (!container) {
        console.error('‚ùå editAssignedEmployeesContainer not found');
        alert('Error: Edit form employee container not found');
        return;
      }
      
      console.log('‚úÖ Found editAssignedEmployeesContainer:', container);
      
      const employeeEntry = document.createElement('div');
      employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
      
      employeeEntry.innerHTML = `
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
          <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select Employee</option>
          </select>
        </div>
        <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
          ‚úï
        </button>
      `;
      
      container.appendChild(employeeEntry);
      
      // Load employees into the new dropdown
      const selectElement = employeeEntry.querySelector('.employee-select');
      loadEmployeesIntoSelect(selectElement);
      
      // Add change event listener to prevent duplicate selections
      selectElement.addEventListener('change', function() {
        validateEmployeeSelections();
      });
      
      console.log('‚úÖ Added new employee entry to edit form');
    }

    async function loadEmployeesIntoSelect(selectElement) {
      try {
        console.log('üîç Loading employees into dropdown...');
        const token = getAuthToken();
        console.log('Auth token:', token ? 'Present' : 'Missing');
        
        const response = await fetch('/api/employees', {
          headers: getAuthHeaders()
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error:', response.status, errorText);
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const employees = await response.json();
        console.log('Employees loaded:', employees.length);
        
        employees.forEach(employee => {
          if (employee.status === 'active') {
            const option = document.createElement('option');
            option.value = employee.name;
            option.textContent = employee.name;
            selectElement.appendChild(option);
          }
        });
        
        console.log('‚úÖ Employee dropdown populated successfully');
      } catch (error) {
        console.error('‚ùå Error loading employees:', error);
        // Show error in dropdown
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading employees';
        selectElement.appendChild(option);
      }
    }

    window.submitCampaign = async function submitCampaign() {
      console.log('Submit button clicked - starting validation...');
      console.log('submitCampaign function is defined and accessible');
      
      // Validate Status (mandatory)
      const status = document.getElementById('status').value;
      if (!status || status.trim() === '') {
        alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this job.');
        return;
      }
      
      // Validate Planned Start Date (mandatory only when status is "Planned")
      const plannedStartDate = document.getElementById('plannedStartDate').value;
      if (status === 'Planned' && (!plannedStartDate || plannedStartDate.trim() === '')) {
        alert('‚ö†Ô∏è Warning: Planned Start Date is mandatory when status is "Planned". Please select a planned start date for this job.');
        return;
      }
      
      // Collect details data
      const details = [];
      const detailsEntries = document.querySelectorAll('.detailsEntry');
      detailsEntries.forEach(entry => {
        const date = entry.querySelector('.detailsDate').value;
        const progress = entry.querySelector('.detailsProgress').value;
        if (date || progress) { // Only include if at least one field has data
          details.push({
            date: date,
            progress: progress
          });
        }
      });

      // Collect assigned employees
      // Validate that no employee is selected more than once (only within this form)
      console.log('üîç [DEBUG] About to validate employee selections...');
      if (!validateEmployeeSelections()) {
        console.log('‚ùå [DEBUG] Validation failed - duplicates detected');
        alert(`‚ö†Ô∏è Warning: Some employees are selected more than once in this job.\n\nPlease select each employee only once.`);
        return;
      }
      console.log('‚úÖ [DEBUG] Validation passed - no duplicates');

      // Collect assigned employees AFTER validation
      const assignedEmployees = [];
      const employeeEntries = document.querySelectorAll('.employee-entry');
      employeeEntries.forEach(entry => {
        const employeeSelect = entry.querySelector('.employee-select');
        if (employeeSelect.value) {
          assignedEmployees.push({
            employeeId: employeeSelect.value,
            employeeName: employeeSelect.value,
            assignedAt: new Date().toISOString()
          });
        }
      });

      // Validate that all employee entries have selected employees
      const unselectedEmployees = [];
      employeeEntries.forEach((entry, index) => {
        const employeeSelect = entry.querySelector('.employee-select');
        if (!employeeSelect.value || employeeSelect.value === '') {
          unselectedEmployees.push(index + 1);
        }
      });

      if (unselectedEmployees.length > 0) {
        alert(`‚ö†Ô∏è Warning: Please select an employee for all employee entries.\n\nUnselected entries: ${unselectedEmployees.join(', ')}`);
            return;
          }

      // Collect progress details
      const progressDetails = [];
      document.querySelectorAll('#progressDetailsContainer .bg-white').forEach(detail => {
        const date = detail.querySelector('.progress-date').value;
        const description = detail.querySelector('.progress-description').value;
        if (date && description) {
          progressDetails.push({ date, description });
        }
      });
      
      // Collect file information
      const files = Array.from(document.getElementById('fileUpload').files).map(file => ({
        name: file.name,
        size: file.size,
        type: file.type
      }));
      
      // Collect job data from form
      const jobData = {
        // campaignId will be assigned by the backend persistent counter
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        entryDate: document.getElementById('entryDate').value,
        plannedStartDate: document.getElementById('plannedStartDate').value,
        actualStartDate: document.getElementById('actualStartDate').value,
        endDate: document.getElementById('endDate').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        assignedEmployees: assignedEmployees, // New field for multiple employees
        progressDetails: progressDetails,
        files: files
      };
      
      console.log('=== FINAL JOB DATA BEFORE SUBMISSION ===');
      console.log('Job data:', JSON.stringify(jobData, null, 2));

      try {
        const response = await fetch('/api/campaigns', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ jobData: jobData }),
        });
        const result = await response.json();
        if (response.ok) {
          // Display the campaignId assigned by the backend
          document.getElementById('campaignId').value = result.campaignId;
          alert(result.message);
          clearForm();
          
          // Refresh the campaigns table to show the newly added job
          console.log('[DEBUG] Job created successfully, refreshing campaigns table...');
          showSection('campaigns-table');
          setTimeout(() => {
            loadCampaignsTable();
          }, 100);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Function to load users for job assignment dropdown
    async function loadUsersForJobAssignment() {
      try {
        const response = await fetch('/api/users', {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const users = await response.json();
          const jobAssignedToSelect = document.getElementById('jobAssignedTo');
          if (jobAssignedToSelect) {
            // Clear existing options except the first one
            jobAssignedToSelect.innerHTML = '<option value="">Select Employee</option>';
            
            // Add ONLY active users (excluding Superuser) - NO deleted users in new campaign form
            users.forEach(user => {
              if (user.username !== 'Superuser') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                jobAssignedToSelect.appendChild(option);
              }
            });
          }
        } else {
          console.error('Failed to load users:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Function to get existing job assignments from campaigns
    async function getExistingJobAssignments() {
      try {
        const response = await fetch('/api/campaigns', {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const campaigns = await response.json();
          const assignments = new Set();
          campaigns.forEach(campaign => {
            if (campaign.jobAssignedTo && campaign.jobAssignedTo.trim() !== '') {
              assignments.add(campaign.jobAssignedTo);
            }
          });
          return Array.from(assignments);
        }
        return [];
      } catch (error) {
        console.error('Error fetching existing job assignments:', error);
        return [];
      }
    }

    // Function to refresh job assignment dropdowns (call this when users are added/updated)
    // Note: Not called when users are deleted to preserve existing job assignments
    function refreshJobAssignmentDropdowns() {
      // Refresh dropdown in new campaign form
      const newCampaignSelect = document.getElementById('jobAssignedTo');
      if (newCampaignSelect) {
        loadUsersForJobAssignment();
      }
      
      // Refresh dropdown in edit form if it exists
      const editForm = document.getElementById('editCampaignForm');
      if (editForm) {
        const editSelect = editForm.querySelector('#jobAssignedTo');
        if (editSelect) {
          // Get current assigned user from the dropdown value
          const currentAssignedUser = editSelect.value || null;
          loadUsersForJobAssignmentInForm(editForm, currentAssignedUser);
        }
      }
      
      // Refresh filter dropdown in campaigns table
      loadUsersForJobAssignmentFilter();
    }

    // Make refresh function globally available
    window.refreshJobAssignmentDropdowns = refreshJobAssignmentDropdowns;
    
    // Make loadUsersForJobAssignment globally available for testing
    window.loadUsersForJobAssignment = loadUsersForJobAssignment;

    // Function to load users for job assignment dropdown in a specific form
    async function loadUsersForJobAssignmentInForm(formContainer, currentAssignedUser = null) {
      try {
        const response = await fetch('/api/users', {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const users = await response.json();
          const jobAssignedToSelect = formContainer.querySelector('#jobAssignedTo');
          if (jobAssignedToSelect) {
            // Clear existing options except the first one
            jobAssignedToSelect.innerHTML = '<option value="">Select Employee</option>';
            
            // Add ONLY active users (excluding Superuser) - NO deleted users in edit form
            users.forEach(user => {
              if (user.username !== 'Superuser') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                jobAssignedToSelect.appendChild(option);
              }
            });
            
            // Special case: If the campaign being edited has a deleted user assigned,
            // add that specific user to the dropdown so the current assignment is preserved
            if (currentAssignedUser) {
              const isActiveUser = users.find(user => user.username === currentAssignedUser);
              if (!isActiveUser && currentAssignedUser !== 'Superuser') {
                const option = document.createElement('option');
                option.value = currentAssignedUser;
                option.textContent = currentAssignedUser + ' (Inactive)';
                option.style.color = '#6B7280';
                jobAssignedToSelect.appendChild(option);
              }
            }
          }
        } else {
          console.error('Failed to load users for edit form:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading users for edit form:', error);
      }
    }

    // Function to load users for job assignment filter dropdown
    async function loadUsersForJobAssignmentFilter() {
      try {
        const response = await fetch('/api/employees', {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const employees = await response.json();
          const filterSelect = document.getElementById('filter-job-assigned-to');
          if (filterSelect) {
            // Clear existing options except the first one
            filterSelect.innerHTML = '<option value="">All Job Assigned To</option>';
            
            // Add active employees
            employees.forEach(employee => {
              if (employee.status === 'active') {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = employee.name;
                filterSelect.appendChild(option);
              }
            });
          }
        } else {
          console.error('Failed to load employees for filter:', response.statusText);
        }
      } catch (error) {
        console.error('Error loading employees for filter:', error);
      }
    }

    function clearForm() {
      // Clear job fields
      document.getElementById('name').value = '';
      document.getElementById('description').value = '';
      // Set entry date to current date
      setEntryDateToToday();
      document.getElementById('plannedStartDate').value = '';
      document.getElementById('actualStartDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('status').value = 'Active';
      document.getElementById('priority').value = '';
      
      // Clear assigned employees entries
      const assignedEmployeesContainer = document.getElementById('assignedEmployeesContainer');
      if (assignedEmployeesContainer) {
        assignedEmployeesContainer.innerHTML = '';
      }
      
      // Clear progress details
      const progressContainer = document.getElementById('progressDetailsContainer');
      if (progressContainer) {
        progressContainer.innerHTML = '';
      }
      
      // Clear file upload
      const fileUpload = document.getElementById('fileUpload');
      if (fileUpload) {
        fileUpload.value = '';
      }
      
      // Clear file list
      const fileList = document.getElementById('fileList');
      if (fileList) {
        fileList.innerHTML = '';
      }
      
      // Clear campaignId field - it will be assigned by backend
      document.getElementById('campaignId').value = '';
    }

    // Employee Management Functions
    window.loadEmployees = async function loadEmployees() {
      try {
        const response = await fetch('/api/employees', {
          headers: getAuthHeaders()
        });
        const employees = await response.json();
        
        const tbody = document.getElementById('employees-table-body');
        tbody.innerHTML = '';
        
        if (employees.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No employees found.</td></tr>';
          return;
        }
        
        employees.forEach(employee => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${employee.name}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${employee.whatsapp || 'N/A'}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${employee.department || 'N/A'}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${employee.position || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 text-xs rounded-full ${employee.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${employee.status || 'inactive'}
              </span>
            </td>
                  <td class="px-4 py-3 text-sm">
                    <button onclick="editEmployee('${employee._id}')" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                    <button onclick="toggleEmployeeStatus('${employee._id}', '${employee.status}')" class="text-green-600 hover:text-green-800 mr-2">
                      ${employee.status === 'active' ? 'Deactivate' : 'Activate'}
                    </button>
                    <button onclick="deleteEmployee('${employee._id}')" class="text-red-600 hover:text-red-800">Delete</button>
                  </td>
          `;
        });
      } catch (error) {
        console.error('Error loading employees:', error);
      }
    }

    window.handleCreateEmployee = async function handleCreateEmployee(event) {
      console.log('[DEBUG] handleCreateEmployee called');
      event.preventDefault();
      
      const employeeData = {
        name: document.getElementById('newEmployeeName').value,
        whatsapp: document.getElementById('newEmployeeWhatsApp').value,
        department: document.getElementById('newEmployeeDepartment').value,
        position: document.getElementById('newEmployeePosition').value,
        status: 'active'
      };
      
      console.log('[DEBUG] Employee data:', employeeData);
      
      try {
        const response = await fetch('/api/employees', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(employeeData)
        });
        
        if (response.ok) {
          alert('Employee created successfully!');
          clearEmployeeForm();
          loadEmployees();
        } else {
          const error = await response.json();
          alert('Error creating employee: ' + error.error);
        }
      } catch (error) {
        console.error('Error creating employee:', error);
        alert('Failed to create employee.');
      }
    }

    window.clearEmployeeForm = function clearEmployeeForm() {
      document.getElementById('newEmployeeName').value = '';
      document.getElementById('newEmployeeWhatsApp').value = '';
      document.getElementById('newEmployeeDepartment').value = '';
      document.getElementById('newEmployeePosition').value = '';
    }


    window.editEmployee = async function editEmployee(employeeId) {
      try {
        // Fetch employee data
        const response = await fetch(`/api/employees/${employeeId}`, {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          alert('Error loading employee data.');
          return;
        }
        
        const employee = await response.json();
        
        // Create edit form
        const editForm = document.createElement('div');
        editForm.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        editForm.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h3 class="text-lg font-semibold text-purple-700 mb-4">Edit Employee</h3>
            <form id="editEmployeeForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Employee Name</label>
                <input id="editEmployeeName" type="text" value="${employee.name}" required class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">WhatsApp Number</label>
                <input id="editEmployeeWhatsApp" type="tel" value="${employee.whatsapp}" required class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Department</label>
                <input id="editEmployeeDepartment" type="text" value="${employee.department || ''}" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Position</label>
                <input id="editEmployeePosition" type="text" value="${employee.position || ''}" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Status</label>
                <select id="editEmployeeStatus" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="active" ${employee.status === 'active' ? 'selected' : ''}>Active</option>
                  <option value="inactive" ${employee.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                </select>
              </div>
              <div class="flex gap-4">
                <button type="submit" class="btn-primary py-2 px-4 rounded-md">Update Employee</button>
                <button type="button" onclick="closeEditEmployeeModal()" class="btn-secondary py-2 px-4 rounded-md">Cancel</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(editForm);
        
        // Add form submission handler
        editForm.querySelector('#editEmployeeForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await updateEmployee(employeeId, editForm);
        });
        
      } catch (error) {
        console.error('Error editing employee:', error);
        alert('Failed to load employee data.');
      }
    }

    async function updateEmployee(employeeId, editForm) {
      try {
        const employeeData = {
          name: editForm.querySelector('#editEmployeeName').value,
          whatsapp: editForm.querySelector('#editEmployeeWhatsApp').value,
          department: editForm.querySelector('#editEmployeeDepartment').value,
          position: editForm.querySelector('#editEmployeePosition').value,
          status: editForm.querySelector('#editEmployeeStatus').value
        };
        
        const response = await fetch(`/api/employees/${employeeId}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify(employeeData)
        });
        
        if (response.ok) {
          alert('Employee updated successfully!');
          closeEditEmployeeModal();
          loadEmployees();
        } else {
          const error = await response.json();
          alert('Error updating employee: ' + error.error);
        }
      } catch (error) {
        console.error('Error updating employee:', error);
        alert('Failed to update employee.');
      }
    }

    function closeEditEmployeeModal() {
      const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
      if (modal) {
        modal.remove();
      }
    }

    window.toggleEmployeeStatus = async function toggleEmployeeStatus(employeeId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const action = newStatus === 'active' ? 'activate' : 'deactivate';
      
      if (confirm(`Are you sure you want to ${action} this employee?`)) {
        try {
          const response = await fetch(`/api/employees/${employeeId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ status: newStatus })
          });
          
          if (response.ok) {
            alert(`Employee ${action}d successfully!`);
            loadEmployees();
          } else {
            const error = await response.json();
            alert('Error updating employee status: ' + error.error);
          }
        } catch (error) {
          console.error('Error updating employee status:', error);
          alert('Failed to update employee status.');
        }
      }
    }

    window.deleteEmployee = async function deleteEmployee(employeeId) {
      if (confirm('Are you sure you want to delete this employee?')) {
        try {
          const response = await fetch(`/api/employees/${employeeId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
          });
          
          if (response.ok) {
            alert('Employee deleted successfully!');
            loadEmployees();
          } else {
            const error = await response.json();
            alert('Error deleting employee: ' + error.error);
          }
        } catch (error) {
          console.error('Error deleting employee:', error);
          alert('Failed to delete employee.');
        }
      }
    }

    // Function to query selected campaign (new radio-based approach)
    window.querySelectedCampaign = async function(campaignId) {
      console.log('querySelectedCampaign function called');
      let idToUse = campaignId;
      if (!idToUse) {
      const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
      if (!selectedRadio) {
        console.log('No campaign selected');
        alert('Please select a job from the Job Table first.');
        // Reset the indicator
        const indicator = document.getElementById('campaign-selected-indicator');
        const instructions = document.getElementById('query-instructions');
        if (indicator && instructions) {
          indicator.classList.add('hidden');
          instructions.classList.remove('hidden');
        }
        return;
      }
        idToUse = selectedRadio.value;
      }
      const queryCampaignForm = document.getElementById('queryCampaignForm');
      if (!queryCampaignForm) {
        console.error('queryCampaignForm element not found');
        return;
      }
      // Check if originalCampaigns is available
      if (!originalCampaigns || !Array.isArray(originalCampaigns)) {
        console.error('originalCampaigns is not available or not an array');
        console.log('originalCampaigns:', originalCampaigns);
        // Try to reload campaigns data
        console.log('Attempting to reload campaigns data...');
        await loadCampaignsTable();
        if (!originalCampaigns || !Array.isArray(originalCampaigns)) {
          console.error('Still no originalCampaigns after reload');
        return;
        }
      }
      console.log('originalCampaigns length:', originalCampaigns.length);
      console.log('Looking for campaign with ID:', idToUse);
      // Find the campaign in original data
      const campaign = originalCampaigns.find(c => c._id === idToUse);
      if (!campaign) {
        console.log('Campaign not found in original data');
        console.log('Available campaign IDs:', originalCampaigns.map(c => c._id));
        return;
      }
      console.log('Found campaign:', campaign);
      try {
        // Use the campaign data directly instead of making an API call
        const result = campaign;
        // Show the queryCampaignForm div
        queryCampaignForm.classList.remove('hidden');
        // Show the Download as Excel button
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.remove('hidden');
        // Create plain text description layout
        let formHTML = `
          <div class="space-y-4">
            <!-- Job ID and Name -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Job ID</label>
                <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Name</label>
                <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
              </div>
            </div>
            <!-- Description -->
            <div>
              <label class="block text-sm font-medium text-purple-700">Description</label>
              <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
            </div>
            <!-- Entry Date, Planned Start Date, Actual Start Date and End Date -->
            <div class="grid grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Entry Date</label>
                <p class="text-base text-gray-900">${result.entryDate ? formatDateDDMMYY(result.entryDate) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Planned Start Date</label>
                <p class="text-base text-gray-900">${result.plannedStartDate ? formatDateDDMMYY(result.plannedStartDate) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">Actual Start Date</label>
                <p class="text-base text-gray-900">${result.actualStartDate ? formatDateDDMMYY(result.actualStartDate) : 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-purple-700">End Date</label>
                <p class="text-base text-gray-900">${result.endDate ? formatDateDDMMYY(result.endDate) : 'N/A'}</p>
              </div>
            </div>
            <!-- Status -->
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-purple-700">Status</label>
                <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
              </div>
            </div>
            <!-- Assigned Employees -->
            <div class="grid grid-cols-1 gap-4">
                <div>
                <label class="block text-sm font-medium text-purple-700">Assigned Employees</label>
                <p class="text-base text-gray-900">${result.assignedEmployees && result.assignedEmployees.length > 0 ? 
                  result.assignedEmployees.map(emp => emp.employeeName || emp.employeeId).join(', ') : 
                  (result.jobAssignedTo || 'N/A')}</p>
                </div>
                </div>

          </div>`;
        queryCampaignForm.innerHTML = formHTML;
        console.log('Query successful, form displayed.');
      } catch (err) {
        if (queryCampaignForm) {
          queryCampaignForm.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">Error: ${err.message}</p>
            </div>`;
          queryCampaignForm.classList.remove('hidden');
        }
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
      console.log('querySelectedCampaign function finished.');
    }

    // Debug function to check selected campaign
    window.checkSelectedCampaign = function() {
      console.log('=== DEBUG: Checking Selected Campaign ===');
      const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
      console.log('Selected radio:', selectedRadio);
      
      if (selectedRadio) {
        console.log('Selected campaign ID:', selectedRadio.value);
        console.log('originalCampaigns available:', !!originalCampaigns);
        console.log('originalCampaigns length:', originalCampaigns ? originalCampaigns.length : 'N/A');
        
        if (originalCampaigns) {
          const campaign = originalCampaigns.find(c => c._id === selectedRadio.value);
          console.log('Found campaign in data:', !!campaign);
          if (campaign) {
            console.log('Campaign name:', campaign.name);
            console.log('Campaign ID:', campaign.campaignId);
          }
        }
      } else {
        console.log('No campaign selected');
      }
      
      console.log('querySelectedCampaign function exists:', typeof window.querySelectedCampaign);
      console.log('=== END DEBUG ===');
    };


    // Keep the old function for backward compatibility (but it's no longer used)
    async function queryCampaign() {
      
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          headers: getAuthHeaders()
        });
        const result = await response.json();
        
        if (response.ok) {
          // Show the queryResult div
          queryResult.classList.remove('hidden');
          // Show the Download as Excel button
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.remove('hidden');
          let formattedResult = `
            <div class="space-y-6">
              <!-- Basic Information -->
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-lg font-semibold text-purple-700 mb-3">Campaign Information</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Campaign ID</p>
                    <p class="text-base text-gray-900">${result.campaignId || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Name</p>
                    <p class="text-base text-gray-900">${result.name || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Status</p>
                    <p class="text-base text-gray-900">${result.status || 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Job Assigned To</p>
                    <p class="text-base text-gray-900">${result.assignedEmployees && result.assignedEmployees.length > 0 ? 
                      result.assignedEmployees.map(emp => emp.employeeName || emp.employeeId).join(', ') : 
                      (result.jobAssignedTo || 'N/A')}</p>
                  </div>
                </div>
                <div class="mt-3">
                  <p class="text-sm font-medium text-gray-600">Offers</p>
                  <p class="text-base text-gray-900">${result.description || 'No description provided'}</p>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-3">
                  <div>
                    <p class="text-sm font-medium text-gray-600">Work Start Date</p>
                    <p class="text-base text-gray-900">${result.workStartDate ? formatDateDDMMYY(result.workStartDate) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">Start Date</p>
                    <p class="text-base text-gray-900">${result.startDate ? formatDateDDMMYY(result.startDate) : 'N/A'}</p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-600">End Date</p>
                    <p class="text-base text-gray-900">${result.endDate ? formatDateDDMMYY(result.endDate) : 'N/A'}</p>
                  </div>
                </div>
              </div>




            </div>`;

          queryResult.innerHTML = formattedResult;
          queryResult.classList.remove('hidden');
          console.log('Query successful, result displayed.');
        } else {
          queryResult.innerHTML = `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <p class="text-red-700">${result.error}</p>
            </div>`;
          queryResult.classList.remove('hidden');
          console.warn('Query failed, displaying error:', result.error);
          const excelBtn = document.getElementById('downloadExcelBtn');
          if (excelBtn) excelBtn.classList.add('hidden');
        }
      } catch (err) {
        queryResult.innerHTML = `
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <p class="text-red-700">Error: ${err.message}</p>
          </div>`;
        queryResult.classList.remove('hidden');
        console.error('Error querying campaign:', err);
        const excelBtn = document.getElementById('downloadExcelBtn');
        if (excelBtn) excelBtn.classList.add('hidden');
      }
        console.log('queryCampaign function finished.');
    }

    async function exportCampaigns() {
      try {
      console.log('exportCampaigns function called');
        
        // Check if user is logged in
        const token = getAuthToken();
        if (!token) {
          alert('Please log in first to export jobs.');
          return;
        }
        
        // Create a temporary link with authentication
        const response = await fetch('/api/campaigns/export', {
          method: 'GET',
          headers: getAuthHeaders()
        });
        
        if (response.ok) {
          // Get the blob data
          const blob = await response.blob();
          
          // Create download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'jobs.xlsx';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          console.log('Export completed successfully');
        } else {
          const error = await response.json();
          alert(`Export failed: ${error.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Export error:', error);
        alert('Export failed. Please try again.');
      }
    }

    // Campaign ID will be assigned by the backend persistent counter
    // No need to pre-generate IDs on the frontend

    // Unified navigation function for all sections
    function showSection(sectionId) {
      console.log(`Attempting to show section: ${sectionId}`);
      // Hide all sections and clear their content where necessary
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
        // Clear content for specific sections
        if (section.id === 'query-campaign') {
          console.log('Clearing query section content');
          const queryIdElement = section.querySelector('#queryCampaignId');
          if (queryIdElement) queryIdElement.value = '';
          const resultContainer = section.querySelector('#queryResultContainer');
          if (resultContainer) resultContainer.innerHTML = '';
          const filterContainer = section.querySelector('#queryFilterContainer');
          if (filterContainer) filterContainer.innerHTML = '';
        } else if (section.id === 'new-campaign') {
          console.log('Clearing new campaign form');
          const form = section.querySelector('form');
          if (form) form.reset();
          // Clear campaignId field - it will be assigned by backend
          const campaignIdField = document.getElementById('campaignId');
          if (campaignIdField) campaignIdField.value = '';
          // Set entry date to current date
          setEntryDateToToday();
          // Reset categories
          const categoriesContainer = document.getElementById('categoriesContainer');
          if (categoriesContainer) categoriesContainer.innerHTML = '';
          // Re-add initial category input
          if (typeof addCategory === 'function') addCategory();
        }
      });
      
      // Check permissions before showing sections
      if (window.sessionManager) {
        if (sectionId === 'delete-campaign' && !window.sessionManager.canDeleteJobs()) {
          window.sessionManager.showPermissionDenied('delete');
          return;
        }
        if (sectionId === 'user-manager' && !window.sessionManager.canManageUsers()) {
          window.sessionManager.showPermissionDenied('user_manager');
          return;
        }
        if (sectionId === 'new-campaign' && !window.sessionManager.canCreateJobs()) {
          window.sessionManager.showPermissionDenied('create');
          return;
        }
        if (sectionId === 'edit-campaign' && !window.sessionManager.canEditJobs()) {
          window.sessionManager.showPermissionDenied('edit');
          return;
        }
      }
      
      // Show the requested section
      const sectionToShow = document.getElementById(sectionId);
      if (sectionToShow) {
        console.log(`Found section: ${sectionId}`);
        sectionToShow.classList.remove('hidden');
      } else {
        console.error(`Section ${sectionId} not found`);
      }
      
      // Take specific actions based on section
      if (sectionId === 'campaigns-table') {
        // Auto-load campaigns when table section is shown
        if (typeof loadCampaignsTable === 'function') loadCampaignsTable();
      } else if (sectionId === 'user-manager') {
        // Initialize user manager section - show user section by default
        setTimeout(() => {
          if (typeof showUserSection === 'function') showUserSection();
        }, 100);
      } else if (sectionId === 'new-campaign') {
        // Load users for job assignment dropdown when new-campaign section is shown
        setTimeout(() => {
          if (typeof loadUsersForJobAssignment === 'function') loadUsersForJobAssignment();
        }, 100);
        // Reset the form
        const form = document.querySelector('#new-campaign form');
        if (form) form.reset();
        // Clear campaignId field - it will be assigned by backend
        const campaignIdField = document.getElementById('campaignId');
        if (campaignIdField) campaignIdField.value = '';
        // Set entry date to current date
        setEntryDateToToday();
         // Campaign ID will be assigned by backend when form is submitted
      } else if (sectionId === 'query-campaign') {
          // Don't clear radio selection - let the query button logic handle it
          if (typeof updateQueryManualEntryVisibility === 'function') updateQueryManualEntryVisibility();
      } else if (sectionId === 'edit-campaign') {
          // Nothing needed here, load is triggered by button click
      } else if (sectionId === 'delete-campaign') {
          // Permission check already handled above
      } else if (sectionId === 'export-campaign') {
          // Nothing needed here, export is triggered by button click
      } else if (sectionId === 'performance-tracking') {
          // Initialize performance tracking when section is shown
          if (typeof initializePerformanceTracking === 'function') {
            initializePerformanceTracking();
          }
      }
       console.log(`Finished showing section: ${sectionId}`);
    }

    // Helper to show/hide edit campaign input section
    function setEditCampaignInputVisibility(visible) {
      const editInputSection = document.querySelector('#edit-campaign > .space-y-6 > .mb-6');
      if (editInputSection) {
        if (visible) {
          editInputSection.classList.remove('hidden');
        } else {
          editInputSection.classList.add('hidden');
        }
      }
      // Also hide the edit form if not visible
      const editForm = document.getElementById('editCampaignForm');
      if (!visible && editForm) {
        editForm.classList.remove('hidden');
      }
    }

    // Update addEditCampaignMenuFunctionality to handle both entry points
    function addEditCampaignMenuFunctionality() {
      const editMenuBtn = document.querySelector("button[onclick=\"showSection('edit-campaign')\"]");
      if (!editMenuBtn) { console.log('Edit menu button not found'); return; }
      editMenuBtn.addEventListener('click', async function(event) {
        event.preventDefault();
        // Find selected campaign
        const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
        console.log('Edit menu clicked. Selected radio:', selectedRadio);
        if (selectedRadio) {
          // Edit via radio selection: hide input, show form
          const selectedCampaignId = selectedRadio.value;
          console.log('Selected campaign ID:', selectedCampaignId);
          let campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
          console.log('Found campaign:', campaign);
          
          // If campaign not found, try to reload data
          if (!campaign) {
            console.log('Campaign not found, reloading campaigns data...');
            await loadCampaignsTable();
            campaign = originalCampaigns.find(c => c._id === selectedCampaignId);
            console.log('Found campaign after reload:', campaign);
          }
          
          if (campaign) {
            const editInput = document.getElementById('editCampaignId');
            if (editInput) editInput.value = campaign.campaignId;
            showSection('edit-campaign');
            setEditCampaignInputVisibility(false);
            await loadCampaignForEditDirect(campaign);
            // Ensure the edit form is visible
            const editForm = document.getElementById('editCampaignForm');
            if (editForm) editForm.classList.remove('hidden');
            console.log('Edit form should now be visible.');
          } else {
            console.log('Campaign not found in originalCampaigns.');
          }
        } else {
          // Edit via menu: show input, hide form
          showSection('edit-campaign');
          setEditCampaignInputVisibility(true);
          const editForm = document.getElementById('editCampaignForm');
          if (editForm) editForm.classList.add('hidden');
          console.log('No campaign selected, showing input.');
        }
      });
    }

    // Update loadCampaignForEdit to prevent empty input
    async function loadCampaignForEdit() {
      const campaignId = document.getElementById('editCampaignId').value.trim();
      if (!campaignId) {
        alert('Please enter a Job ID.');
        return;
      }
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          headers: getAuthHeaders()
        });
        const result = await response.json();
        if (response.ok) {
          setEditCampaignInputVisibility(false);
          await loadCampaignForEditDirect(result);
        } else {
          alert('Error: ' + result.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function loadCampaignForEditDirect(campaign) {
      // Clone the new campaign form
      const newCampaignFormTemplate = document.querySelector('#new-campaign .space-y-6');
      const editFormContainer = document.getElementById('editCampaignForm');
      
      // Clear previous content
      editFormContainer.innerHTML = '';

      // Create a new form element and append cloned children
      const editForm = document.createElement('div');
      editForm.className = newCampaignFormTemplate.className; // Copy classes
      
      Array.from(newCampaignFormTemplate.children).forEach(child => {
          editForm.appendChild(child.cloneNode(true));
      });

      // Add hidden input for MongoDB _id
      const hiddenIdInput = document.createElement('input');
      hiddenIdInput.type = 'hidden';
      hiddenIdInput.id = 'editCampaignMongoId';
      hiddenIdInput.value = campaign._id;
      editForm.appendChild(hiddenIdInput);
      
      // Fill in the form with campaign data
      fillFormWithCampaignData(editForm, campaign);

      // Fix ID conflict by giving edit form container a unique ID
      const assignedEmployeesContainer = editForm.querySelector('#assignedEmployeesContainer');
      if (assignedEmployeesContainer) {
        assignedEmployeesContainer.id = 'editAssignedEmployeesContainer';
        console.log('‚úÖ Changed edit form container ID to editAssignedEmployeesContainer');
      }

      // Load assigned employees into the edit form
      await loadAssignedEmployeesIntoEditForm(editForm, campaign);

      // Attach Add Employee button functionality to edit form
      const addEmployeeBtn = editForm.querySelector('button[onclick="addEmployeeEntry()"]');
      console.log('üîç Looking for Add Employee button in edit form:', addEmployeeBtn);
      if (addEmployeeBtn) {
        console.log('‚úÖ Found Add Employee button, attaching click handler');
        addEmployeeBtn.onclick = function() {
          console.log('Add Employee button clicked in edit form');
          addEmployeeEntryForEditForm();
        };
      } else {
        console.log('‚ùå Add Employee button not found in edit form');
      }

      // Modify the submit button to handle updates
      const submitButton = editForm.querySelector('button[onclick="submitCampaign()"]');
      if (submitButton) {
         submitButton.onclick = () => submitCampaignUpdate();
         submitButton.textContent = 'Update Campaign';
      }
      
      // Show the form
      editFormContainer.appendChild(editForm);
      editFormContainer.classList.remove('hidden');

      // Channel functionality removed - no longer needed

       // Channel functionality removed - no longer needed
        
        // Re-attach category removal event listeners AFTER form data is filled
        updateRemoveCategoryBtns();
        
        // Re-attach add category button functionality for edit form
        const editAddCategoryBtn = editForm.querySelector('#addCategoryBtn');
        if (editAddCategoryBtn) {
            editAddCategoryBtn.onclick = function() {
                console.log('Add Category button clicked in edit form');
                const catContainer = editForm.querySelector('#targetCategoryContainer');
                const div = document.createElement('div');
                div.className = 'targetCategorySelect flex flex-wrap items-center gap-2';
                div.innerHTML = `<select class="targetCategory flex-1 min-w-0 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Select Category</option>
                    <option>Tourist</option>
                    <option>Resident</option>
                    <option>All Walkin</option>
                    <option>Social Media</option>
                    <option>Social Groups</option>
                    <option>What'sup group</option>
                    <option>Corporates</option>
                    <option>Residential Cmty</option>
                    <option>Local Cmty</option>
                    <option>Blue collar wrkrs</option>
                    <option>Existing cutomers</option>
                    <option>HNTW</option>
                    <option>Channel Partner</option>
                    <option>DGJG</option>
                    <option>Hotels</option>
                    <option>Tourism Companies</option>
                    <option>Tour Drivers</option>
                    <option>Other Tours Assctd cmpy</option>
                    <option>Festival & Occasion Buyers</option>
                    <option>Product Launch</option>
                </select><input type="text" class="categoryTag w-32 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tag"><button type="button" class="removeCategoryBtn text-red-500 px-2 py-2 hover:bg-red-50 rounded">‚úï</button>`;
                catContainer.appendChild(div);
                updateRemoveCategoryBtns();
            };
        }
    }

    // Load assigned employees into edit form
    async function loadAssignedEmployeesIntoEditForm(editForm, campaign) {
      try {
        const assignedEmployeesContainer = editForm.querySelector('#editAssignedEmployeesContainer');
        if (!assignedEmployeesContainer) {
          console.log('editAssignedEmployeesContainer not found in edit form');
          return;
        }
        
        // Clear existing employee entries
        assignedEmployeesContainer.innerHTML = '';
        
        // Load assigned employees from campaign data
        if (campaign.assignedEmployees && Array.isArray(campaign.assignedEmployees)) {
          for (const employee of campaign.assignedEmployees) {
            // Create employee entry
            const employeeEntry = document.createElement('div');
            employeeEntry.className = 'employee-entry flex gap-2 items-end p-3 border rounded-md bg-gray-50';
            
            employeeEntry.innerHTML = `
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
                <select class="employee-select w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Select Employee</option>
            </select>
          </div>
              <button type="button" onclick="removeEmployeeEntry(this)" class="text-gray-500 hover:text-red-500">
                ‚úï
            </button>
            `;
            
            assignedEmployeesContainer.appendChild(employeeEntry);
            
            // Load employees into the dropdown
            await loadEmployeesIntoSelect(employeeEntry.querySelector('.employee-select'));
            
            // Set the selected employee
            const select = employeeEntry.querySelector('.employee-select');
            // Match by employee name
            select.value = employee.employeeName || employee.employeeId || '';
            
            // Add change event listener to prevent duplicate selections
            select.addEventListener('change', function() {
              validateEmployeeSelections();
            });
          }
        }
        
        console.log('‚úÖ Assigned employees loaded into edit form');
      } catch (error) {
        console.error('‚ùå Error loading assigned employees into edit form:', error);
      }
    }

    // A variation of addChannelEntry for the edit form to ensure correct scoping
    // Channel functionality removed - this function is no longer needed

    async function submitCampaignUpdate() {
      try {
        // Check if user is logged in
        const token = getAuthToken();
        if (!token) {
          alert('Please log in first to update jobs.');
          return;
        }
        
        // Get the edit form
        const editForm = document.getElementById('editCampaignForm');
        
        // Validate category selection
        const editCategorySelects = editForm.querySelectorAll('.targetCategory');
        // All dropdowns must be selected (not empty)
        const allCategoriesSelected = Array.from(editCategorySelects).every(select => select.value && select.value.trim() !== '');
        if (!allCategoriesSelected) {
          alert('‚ö†Ô∏è Warning: Please select a category for every row before updating the job.');
          return;
        }
        
        // Validate Status (mandatory)
        const status = editForm.querySelector('#status')?.value;
        if (!status || status.trim() === '') {
          alert('‚ö†Ô∏è Warning: Status is mandatory. Please select a status for this job.');
          return;
        }
        
        // Validate Planned Start Date (mandatory only when status is "Planned")
        const plannedStartDate = editForm.querySelector('#plannedStartDate')?.value;
        if (status === 'Planned' && (!plannedStartDate || plannedStartDate.trim() === '')) {
          alert('‚ö†Ô∏è Warning: Planned Start Date is mandatory when status is "Planned". Please select a planned start date for this job.');
          return;
        }
        
        if (!editForm) {
          throw new Error('Edit form not found');
        }

        // Get the MongoDB _id from the hidden input
        const mongoIdInput = editForm.querySelector('#editCampaignMongoId');
        if (!mongoIdInput || !mongoIdInput.value) {
          throw new Error('Campaign ID for update not found');
        }
        const campaignId = mongoIdInput.value;

        // Gather all categories and tags
        const categorySelects = editForm.querySelectorAll('.targetCategory');
        const tagInputs = editForm.querySelectorAll('.categoryTag');
        const categories = Array.from(categorySelects).map((sel, idx) => {
          return {
            category: sel.value,
            tag: tagInputs[idx] ? tagInputs[idx].value : ''
          };
        }).filter(obj => obj.category);

        // Get all form fields
        const formData = {
          campaignId: editForm.querySelector('#campaignId')?.value || '',
          name: editForm.querySelector('#name')?.value || '',
          description: editForm.querySelector('#description')?.value || '',
          plannedStartDate: editForm.querySelector('#plannedStartDate')?.value || '',
          startDate: editForm.querySelector('#startDate')?.value || '',
          endDate: editForm.querySelector('#endDate')?.value || '',
          budget: parseFloat(editForm.querySelector('#budget')?.value) || 0,
          status: editForm.querySelector('#status')?.value || 'Active',
          jobAssignedTo: editForm.querySelector('#jobAssignedTo')?.value || '',
          targetAudience: {
            age: editForm.querySelector('#targetAge')?.value || '',
            gender: editForm.querySelector('#targetGender')?.value || 'All',
            categories: categories
          },
          goals: {
            sales: parseFloat(editForm.querySelector('#goalSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#goalImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#goalConversions')?.value) || 0,
          },
          achieved: {
            sales: parseFloat(editForm.querySelector('#achievedSales')?.value) || 0,
            impressions: parseFloat(editForm.querySelector('#achievedImpressions')?.value) || 0,
            conversions: parseFloat(editForm.querySelector('#achievedConversions')?.value) || 0,
          },
          channels: []
        };

        // Collect assigned employees from edit form
        const assignedEmployees = [];
        const editEmployeeEntries = editForm.querySelectorAll('#editAssignedEmployeesContainer .employee-entry');
        editEmployeeEntries.forEach(entry => {
          const employeeSelect = entry.querySelector('.employee-select');
          if (employeeSelect.value) {
            assignedEmployees.push({
              employeeId: employeeSelect.value,
              employeeName: employeeSelect.value
            });
          }
        });

        // Validate that all employee entries have selected employees
        const unselectedEmployees = [];
        editEmployeeEntries.forEach((entry, index) => {
          const employeeSelect = entry.querySelector('.employee-select');
          if (!employeeSelect.value || employeeSelect.value === '') {
            unselectedEmployees.push(index + 1);
          }
        });

        if (unselectedEmployees.length > 0) {
          alert(`‚ö†Ô∏è Warning: Please select an employee for all employee entries.\n\nUnselected entries: ${unselectedEmployees.join(', ')}`);
          return;
        }

        // Validate that no employee is selected more than once (only within this form)
        if (!validateEmployeeSelections()) {
          alert(`‚ö†Ô∏è Warning: Some employees are selected more than once in this job.\n\nPlease select each employee only once.`);
          return;
        }

        formData.assignedEmployees = assignedEmployees;

        console.log('üìù Collected assigned employees for update:', assignedEmployees);

        // Send update request
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify(formData)
        });
        const result = await response.json();
        if (response.ok) {
          alert('Job updated successfully!');
          showSection('campaigns-table');
          // Reload campaigns to show updated data
          console.log('[DEBUG] Job updated successfully, refreshing campaigns table...');
          setTimeout(() => {
            loadCampaignsTable();
          }, 100);
        } else {
          throw new Error('Server returned an error: ' + JSON.stringify(result));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function fillFormWithCampaignData(form, campaign) {
      console.log('=== fillFormWithCampaignData called ===');
      console.log('Form element:', form);
      console.log('Campaign data:', campaign);
      console.log('Campaign structure:', {
        _id: campaign._id,
        campaignId: campaign.campaignId,
        name: campaign.name,
        targetAudience: campaign.targetAudience,
        channels: campaign.channels
      });
      
      // Fill in basic fields
      const campaignIdInput = form.querySelector('#campaignId');
      if (campaignIdInput) campaignIdInput.value = campaign.campaignId || '';
      const nameInput = form.querySelector('#name');
      if (nameInput) nameInput.value = campaign.name || '';
      const descInput = form.querySelector('#description');
      if (descInput) descInput.value = campaign.description || '';
      const plannedStartDateInput = form.querySelector('#plannedStartDate');
      if (plannedStartDateInput) plannedStartDateInput.value = campaign.plannedStartDate || '';
      const startDateInput = form.querySelector('#startDate');
      if (startDateInput) startDateInput.value = campaign.startDate || '';
      const endDateInput = form.querySelector('#endDate');
      if (endDateInput) endDateInput.value = campaign.endDate || '';
      const budgetInput = form.querySelector('#budget');
      if (budgetInput) budgetInput.value = campaign.budget || '';
      const statusInput = form.querySelector('#status');
      if (statusInput) {
        statusInput.value = campaign.status || '';
        
        // Add event listener for status change to validate Planned Start Date
        statusInput.addEventListener('change', function() {
          const plannedStartDateInput = form.querySelector('#plannedStartDate');
          if (this.value === 'Planned' && (!plannedStartDateInput.value || plannedStartDateInput.value.trim() === '')) {
            alert('‚ö†Ô∏è Warning: Planned Start Date is now required since status changed to "Planned". Please select a planned start date for this job.');
            plannedStartDateInput.focus();
          }
        });
      }
      const jobAssignedToSelect = form.querySelector('#jobAssignedTo');
      if (jobAssignedToSelect) {
        // Set the value if it exists in the dropdown options
        const optionExists = Array.from(jobAssignedToSelect.options).some(option => option.value === campaign.jobAssignedTo);
        if (optionExists) {
          jobAssignedToSelect.value = campaign.jobAssignedTo || '';
        } else {
          // If the assigned user doesn't exist in current users, add it as an option
          if (campaign.jobAssignedTo) {
            const option = document.createElement('option');
            option.value = campaign.jobAssignedTo;
            option.textContent = campaign.jobAssignedTo;
            jobAssignedToSelect.appendChild(option);
            jobAssignedToSelect.value = campaign.jobAssignedTo;
          }
        }
      }

      // Fill in priority
      const priorityInput = form.querySelector('#priority');
      if (priorityInput) priorityInput.value = campaign.priority || '';

      // Channel functionality removed - no longer needed
    }


    // Marketing-related functions removed - no longer needed







    // Function to load campaigns table
    async function loadCampaignsTable() {
      try {
        console.log('[DEBUG] Loading campaigns table...');
        // Add cache-busting parameter to ensure fresh data
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/campaigns?t=${timestamp}`, {
          headers: getAuthHeaders()
        });
        const campaigns = await response.json();
        
        console.log('[DEBUG] API Response status:', response.status);
        console.log('[DEBUG] API Response data:', campaigns);
        
        if (response.ok) {
          // Clear any cached data and update originalCampaigns
          originalCampaigns = campaigns;
          console.log('[DEBUG] Updated originalCampaigns with fresh data:', originalCampaigns.length, 'campaigns');
          
          // Load job assignment filter dropdown
          loadUsersForJobAssignmentFilter();
          displayCampaignsTable(campaigns);
        } else {
          console.error('Error loading campaigns:', campaigns.error);
        }
      } catch (err) {
        console.error('Error loading campaigns:', err);
      }
    }

    // Store original campaigns data for filtering
    let originalCampaigns = [];
    
    // Helper function to format dates in dd/mm/yy format
    function formatDateDDMMYY(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      
      return `${day}/${month}/${year}`;
    }
    
    // Function to display campaigns in table
    function displayCampaignsTable(campaigns) {
      console.log('displayCampaignsTable called with:', campaigns);
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      console.log('Original campaigns stored:', originalCampaigns.length);
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to apply filters
    function applyFilters() {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody || !originalCampaigns) return;
      
      // Get filter values
      const campaignIdFilter = document.getElementById('filter-campaign-id')?.value.toLowerCase() || '';
      const campaignNameFilter = document.getElementById('filter-campaign-name')?.value.toLowerCase() || '';
      const offersFilter = document.getElementById('filter-offers')?.value.toLowerCase() || '';
      const entryDateFrom = document.getElementById('filter-entry-date-from')?.value || '';
      const entryDateTo = document.getElementById('filter-entry-date-to')?.value || '';
      const plannedStartDateFrom = document.getElementById('filter-planned-start-date-from')?.value || '';
      const plannedStartDateTo = document.getElementById('filter-planned-start-date-to')?.value || '';
      const actualStartDateFrom = document.getElementById('filter-actual-start-date-from')?.value || '';
      const actualStartDateTo = document.getElementById('filter-actual-start-date-to')?.value || '';
      const endDateFrom = document.getElementById('filter-end-date-from')?.value || '';
      const endDateTo = document.getElementById('filter-end-date-to')?.value || '';
      const statusFilter = document.getElementById('filter-status')?.value || '';
      const jobAssignedToFilter = document.getElementById('filter-job-assigned-to')?.value || '';
      
      // Filter campaigns
      const filteredCampaigns = originalCampaigns.filter(campaign => {
        // Campaign ID filter
        if (campaignIdFilter && !(campaign.campaignId || '').toLowerCase().includes(campaignIdFilter)) return false;
        
        // Campaign Name filter
        if (campaignNameFilter && !(campaign.name || '').toLowerCase().includes(campaignNameFilter)) return false;
        
        // Offers filter
        if (offersFilter && !(campaign.description || '').toLowerCase().includes(offersFilter)) return false;
        
        // Entry Date filter
        if (entryDateFrom && campaign.entryDate && new Date(campaign.entryDate) < new Date(entryDateFrom)) return false;
        if (entryDateTo && campaign.entryDate && new Date(campaign.entryDate) > new Date(entryDateTo)) return false;
        
        // Planned Start Date filter
        if (plannedStartDateFrom && campaign.plannedStartDate && new Date(campaign.plannedStartDate) < new Date(plannedStartDateFrom)) return false;
        if (plannedStartDateTo && campaign.plannedStartDate && new Date(campaign.plannedStartDate) > new Date(plannedStartDateTo)) return false;
        
        // Actual Start Date filter
        if (actualStartDateFrom && campaign.actualStartDate && new Date(campaign.actualStartDate) < new Date(actualStartDateFrom)) return false;
        if (actualStartDateTo && campaign.actualStartDate && new Date(campaign.actualStartDate) > new Date(actualStartDateTo)) return false;
        
        // End Date filter
        if (endDateFrom && campaign.endDate && new Date(campaign.endDate) < new Date(endDateFrom)) return false;
        if (endDateTo && campaign.endDate && new Date(campaign.endDate) > new Date(endDateTo)) return false;
        
        
        // Status filter
        if (statusFilter && campaign.status !== statusFilter) return false;
        
        // Priority filter
        const priorityFilter = document.getElementById('filter-priority')?.value || '';
        if (priorityFilter) {
          if (priorityFilter === 'High' && campaign.priority !== 'High') return false;
          if (priorityFilter === 'No Priority' && campaign.priority && campaign.priority !== '') return false;
        }
        
        // Job Assigned To filter - check both assignedEmployees and jobAssignedTo
        if (jobAssignedToFilter) {
          const assignedEmployeeNames = campaign.assignedEmployees ? 
            campaign.assignedEmployees.map(emp => emp.employeeName || emp.employeeId) : [];
          const hasMatchingEmployee = assignedEmployeeNames.some(name => name === jobAssignedToFilter) ||
            campaign.jobAssignedTo === jobAssignedToFilter;
          if (!hasMatchingEmployee) return false;
        }
        
        
        return true;
      });
      
      // Update count
      countSpan.textContent = filteredCampaigns.length;
      
      // Display filtered campaigns
      if (filteredCampaigns.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
        return;
      }
      
      let html = '';
      filteredCampaigns.forEach((campaign, index) => {
        const entryDate = formatDateDDMMYY(campaign.entryDate);
        const plannedStartDate = formatDateDDMMYY(campaign.plannedStartDate);
        const actualStartDate = formatDateDDMMYY(campaign.actualStartDate);
        const endDate = formatDateDDMMYY(campaign.endDate);
        const categories = campaign.targetAudience && campaign.targetAudience.categories ? 
          campaign.targetAudience.categories.map(cat => cat.category).join(', ') : '';
        const tagNumbers = campaign.channels ? 
          campaign.channels.map(channel => channel.tagNumber).filter(tag => tag).join(', ') : '';
        
        html += `
          <tr>
            <td><input type="radio" name="selected_campaign" value="${campaign._id}" class="select-campaign-radio"></td>
            <td>${index + 1}</td>
            <td>${campaign.campaignId || ''}</td>
            <td>${campaign.name || ''}</td>
            <td>${campaign.description || ''}</td>
            <td>${entryDate}</td>
            <td>${plannedStartDate}</td>
            <td>${actualStartDate}</td>
            <td>${endDate}</td>
            <td>${campaign.status || ''}</td>
            <td>${campaign.priority === 'High' ? '<span class="priority-badge priority-high">High Priority</span>' : ''}</td>
            <td>${campaign.assignedEmployees && campaign.assignedEmployees.length > 0 ? 
              campaign.assignedEmployees.map(emp => emp.employeeName || emp.employeeId).join(', ') : 
              (campaign.jobAssignedTo || '')}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    }
    
    // Override the original displayCampaignsTable function
    function displayCampaignsTable(campaigns) {
      const tableBody = document.getElementById('campaigns-table-body');
      const countSpan = document.getElementById('campaigns-count');
      
      if (!tableBody) return;
      
      // Store original data for filtering
      originalCampaigns = campaigns;
      
      // Apply filters and display
      applyFilters();
    }
    
    // Function to edit campaign from table
    function editCampaignFromTable(campaignId) {
      // Set the campaign ID in the edit form and show edit section
      const editInput = document.getElementById('editCampaignId');
      if (editInput) {
        editInput.value = campaignId;
        showSection('edit-campaign');
        // Trigger the load campaign function
        loadCampaign();
      }
    }

    // Function to view campaign details
    function viewCampaignDetails(campaignId) {
      // Set the campaign ID in the query form and show query section
      const queryInput = document.getElementById('queryCampaignId');
      if (queryInput) {
        queryInput.value = campaignId;
        showSection('query-campaign');
        // Trigger the query function
        queryCampaign();
      }
    }

    // Auto-load campaigns table when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Show campaigns table by default
      showSection('campaigns-table');
      
      // Add filter event listeners
      addFilterEventListeners();
      
      // Add edit selected functionality
      addEditSelectedFunctionality();
      
      // Add file upload event listener
      const fileUpload = document.getElementById('fileUpload');
      if (fileUpload) {
        fileUpload.addEventListener('change', handleFileUpload);
      }
    });
    
    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Function to add filter event listeners
    function addFilterEventListeners() {
      const filterInputs = [
        'filter-campaign-id', 'filter-campaign-name', 'filter-offers', 
        'filter-entry-date-from', 'filter-entry-date-to', 'filter-planned-start-date-from', 'filter-planned-start-date-to', 'filter-actual-start-date-from', 'filter-actual-start-date-to', 'filter-end-date-from', 'filter-end-date-to',
        'filter-status', 'filter-priority', 'filter-job-assigned-to'
      ];
      
      // Create debounced version of applyFilters
      const debouncedApplyFilters = debounce(applyFilters, 300);
      
      filterInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedApplyFilters);
          element.addEventListener('change', applyFilters);
        }
      });
    }
    
    
    // Function to add edit and delete selected functionality
    function addEditSelectedFunctionality() {
      console.log('[DEBUG] Initializing edit and delete functionality...');
      const deleteBtn = document.getElementById('delete-selected-btn');
      let selectedCampaignId = null;
      
      console.log('[DEBUG] Delete button found:', !!deleteBtn);
      
      // Always set up radio button event listener, regardless of delete button
        document.addEventListener('change', function(e) {
          if (e.target.classList.contains('select-campaign-radio')) {
          console.log('Radio button selected:', e.target.value);
            selectedCampaignId = e.target.value;
          
          // Enable delete button if it exists
          if (deleteBtn) {
            deleteBtn.disabled = false;
            console.log('Delete button enabled:', deleteBtn.disabled);
          }
          
          // Auto-load campaign details for query section if it's visible
          const querySection = document.getElementById('query-campaign');
          if (querySection && !querySection.classList.contains('hidden')) {
            console.log('Query section is visible, auto-loading campaign details...');
            querySelectedCampaign(e.target.value);
          }
          
          // Update the indicator in query section if it exists
          const indicator = document.getElementById('campaign-selected-indicator');
          const instructions = document.getElementById('query-instructions');
          if (indicator && instructions) {
            indicator.classList.remove('hidden');
            instructions.classList.add('hidden');
          }
        }
      });
    }
    
    // Function to delete campaign by ID
    async function deleteCampaignById(campaignId) {
      // Check if user has permission to delete campaigns
      if (window.sessionManager && !window.sessionManager.canDeleteJobs()) {
                alert('You do not have permission to delete jobs. Only Admin users can delete jobs.');
        return;
      }
      
      try {
        // Make API call to delete campaign
        const response = await fetch(`/api/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        
        if (response.ok) {
          // Remove from local data
          originalCampaigns = originalCampaigns.filter(c => c._id !== campaignId);
          
          // Clear any radio selection
          const selectedRadio = document.querySelector('input[name="selected_campaign"]:checked');
          if (selectedRadio) {
            selectedRadio.checked = false;
          }
          
          // Force table refresh with empty state handling
          if (originalCampaigns.length === 0) {
            const tableBody = document.getElementById('campaigns-table-body');
            if (tableBody) {
              tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-4">No campaigns found</td></tr>';
            }
          }
          
          // Refresh the table
          displayCampaignsTable(originalCampaigns);
          
          // Update campaigns count
          const campaignsCount = document.getElementById('campaigns-count');
          if (campaignsCount) {
            campaignsCount.textContent = originalCampaigns.length;
          }
          
          
          console.log('Campaign deleted, campaigns remaining:', originalCampaigns.length);
          alert('Job deleted successfully!');
        } else {
          const error = await response.json();
          alert(`Failed to delete job: ${error.error || 'Unknown error'}`);
              }
      } catch (error) {
        console.error('Delete campaign error:', error);
        alert('Failed to delete job. Please try again.');
      }
    }
    // Ensure handler is registered after DOMContentLoaded
    window.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] DOMContentLoaded - initializing functions...');
      addEditCampaignMenuFunctionality();
      console.log('[DEBUG] Calling addEditSelectedFunctionality...');
      try {
        addEditSelectedFunctionality();
        console.log('[DEBUG] addEditSelectedFunctionality completed successfully');
      } catch (error) {
        console.error('[DEBUG] Error in addEditSelectedFunctionality:', error);
      }
      console.log('[DEBUG] Functions initialized.');
      

    });
  </script>

<!-- Edit Roles Modal -->
        <div id="editRolesModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 w-full max-w-xs relative">
        <h3 class="text-md font-semibold text-purple-700 mb-3">Edit User Roles</h3>
        <select id="editRolesSelect" multiple class="w-full mb-4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
        <div class="flex justify-end gap-2">
          <button id="editRolesCancelBtn" type="button" class="btn-secondary px-4 py-2 rounded">Cancel</button>
          <button id="editRolesSaveBtn" type="button" class="btn-primary px-4 py-2 rounded">Save</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/public/sessionManager.js"></script>
  <script src="/public/userManager.js"></script>
  
  <!-- Initialize application -->
<script>
    // Simple test to see if JavaScript is working
    console.log('[TEST] JavaScript is working');
    
    // Make sure submitCampaign is accessible globally
    window.submitCampaign = window.submitCampaign || function() {
      console.log('submitCampaign function not found!');
      alert('Error: submitCampaign function not found!');
    };
    
    // Helper function to set entry date to current date
    function setEntryDateToToday() {
      const entryDateField = document.getElementById('entryDate');
      if (entryDateField) {
        const today = new Date();
        const todayString = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        entryDateField.value = todayString;
        console.log('[DEBUG] Entry date set to:', todayString);
        return true;
      }
      return false;
    }
    
    // Initialize application when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for session manager to initialize
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Set entry date to current date
      setEntryDateToToday();
      
      // Add login form submission handler
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          if (!username || !password) {
            alert('Please enter both username and password');
            return;
          }
          
          // Show loading state
          const submitBtn = loginForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Signing in...';
          submitBtn.disabled = true;
          
          try {
            const result = await sessionManager.login(username, password);
            
            if (result.success) {
              // Login successful - session manager will handle the rest
            } else {
              // Login failed
              const errorMessage = result.error || 'Login failed. Please check your credentials.';
              
              // Clear password field first
              document.getElementById('password').value = '';
              
              // Show error message in the form
              const errorDiv = document.getElementById('loginError');
              if (errorDiv) {
                errorDiv.textContent = 'Please check your username and password and try again.';
                errorDiv.classList.remove('hidden');
                
                // Hide error after 5 seconds
                setTimeout(() => {
                  errorDiv.classList.add('hidden');
                }, 5000);
              }
              
              // Also show alert for immediate attention
              alert('Please check your username and password and try again.');
            }
          } catch (error) {
            console.error('‚ùå Login error:', error);
            alert('Login failed. Please try again.');
            // Clear password field
            document.getElementById('password').value = '';
          } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
        });
      }
      
      // Session manager will handle showing login or main content
      
      // Multiple image upload handling
      let imageCounter = 1;
      
      // Handle image upload for existing and new image inputs
      function setupImageHandling(imageInput) {
        imageInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
              alert('File size must be less than 5MB');
              this.value = '';
              return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
              alert('Please select an image file');
              this.value = '';
              return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = imageInput.closest('.image-upload-item').querySelector('.image-preview');
              const previewImg = preview.querySelector('img');
              previewImg.src = e.target.result;
              preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      // Handle remove image button
      function setupRemoveImage(removeBtn) {
        removeBtn.addEventListener('click', function() {
          const imageItem = this.closest('.image-upload-item');
          const imageInput = imageItem.querySelector('.image-upload-input');
          const preview = imageItem.querySelector('.image-preview');
          
          imageInput.value = '';
          preview.classList.add('hidden');
          preview.querySelector('img').src = '';
        });
      }
      
      // Handle remove image field button
      function setupRemoveImageField(removeFieldBtn) {
        removeFieldBtn.addEventListener('click', function() {
          const imageItem = this.closest('.image-upload-item');
          imageItem.remove();
        });
      }
      
      // Setup initial image handling
      document.querySelectorAll('.image-upload-input').forEach(setupImageHandling);
      document.querySelectorAll('.remove-image-btn').forEach(setupRemoveImage);
      document.querySelectorAll('.remove-image-field-btn').forEach(setupRemoveImageField);
      

      
      // Add more images functionality
      const addImageBtn = document.getElementById('addImageBtn');
      const imageContainer = document.getElementById('imageUploadContainer');
      
      if (addImageBtn) {
        addImageBtn.addEventListener('click', function() {
          imageCounter++;
          const newImageItem = document.createElement('div');
          newImageItem.className = 'image-upload-item mb-4';
          newImageItem.innerHTML = `
            <input type="file" accept="image/*" class="image-upload-input w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div class="flex items-center justify-between mt-1">
              <p class="text-xs text-gray-500">Upload an image for this campaign (JPG, PNG, GIF - Max 5MB)</p>
              <button type="button" class="remove-image-field-btn text-red-500 hover:text-red-700 text-lg font-bold ml-2">√ó</button>
            </div>
            <div class="image-preview mt-2 hidden">
              <img src="" alt="Campaign Preview" class="max-w-xs h-32 object-cover rounded-md border">
              <button type="button" class="remove-image-btn mt-1 text-sm text-red-600 hover:text-red-800">Remove Image</button>
            </div>
          `;
          
          imageContainer.appendChild(newImageItem);
          
          // Setup handling for new image input
          const newImageInput = newImageItem.querySelector('.image-upload-input');
          const newRemoveBtn = newImageItem.querySelector('.remove-image-btn');
          const newRemoveFieldBtn = newImageItem.querySelector('.remove-image-field-btn');
          setupImageHandling(newImageInput);
          setupRemoveImage(newRemoveBtn);
          setupRemoveImageField(newRemoveFieldBtn);
        });
      }
      
      // Ensure only campaigns table is visible by default
      const allSections = document.querySelectorAll('.section');
      allSections.forEach(section => {
        if (section.id === 'campaigns-table') {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });
});

// Performance Tracking & Appreciation System
let selectedRating = null;
let selectedBadge = null;

// Initialize performance tracking when section is shown
function initializePerformanceTracking() {
  console.log('Initializing performance tracking...');
  
  // Check if user is admin
  const isAdmin = window.sessionManager && window.sessionManager.hasPermission('manage_users');
  
  // Show/hide admin sections
  const performanceRatingSection = document.getElementById('performanceRatingSection');
  const badgeAwardSection = document.getElementById('badgeAwardSection');
  
  if (isAdmin) {
    performanceRatingSection.style.display = 'block';
    badgeAwardSection.style.display = 'block';
    loadJobsForRating();
    loadJobsForBadge();
  } else {
    performanceRatingSection.style.display = 'none';
    badgeAwardSection.style.display = 'none';
  }
  
  // Load performance data
  loadPerformanceOverview();
  loadLeaderboard();
  loadRecentActivity();
  
  // Setup event listeners
  setupPerformanceEventListeners();
}

// Setup event listeners for performance tracking
function setupPerformanceEventListeners() {
  // Rating buttons
  document.querySelectorAll('.rating-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all buttons
      document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
      // Add active class to clicked button
      this.classList.add('selected');
      selectedRating = this.dataset.rating;
    });
  });
  
  // Badge buttons
  document.querySelectorAll('.badge-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all buttons
      document.querySelectorAll('.badge-btn').forEach(b => b.classList.remove('selected'));
      // Add active class to clicked button
      this.classList.add('selected');
      selectedBadge = this.dataset.badge;
    });
  });
  
  // Submit rating
  document.getElementById('submitRatingBtn').addEventListener('click', submitPerformanceRating);
  
  // Submit badge
  document.getElementById('submitBadgeBtn').addEventListener('click', awardBadge);
  
  // Employee form submission
  const createEmployeeForm = document.getElementById('createEmployeeForm');
  if (createEmployeeForm) {
    console.log('[DEBUG] Adding event listener to employee form');
    createEmployeeForm.addEventListener('submit', window.handleCreateEmployee);
  } else {
    console.log('[DEBUG] Employee form not found!');
  }
  
  // Clear buttons
  document.getElementById('clearRatingBtn').addEventListener('click', clearRatingForm);
  document.getElementById('clearBadgeBtn').addEventListener('click', clearBadgeForm);
}

// Load jobs for rating dropdown
async function loadJobsForRating() {
  try {
    const response = await fetch('/api/jobs', {
      headers: getAuthHeaders()
    });
    const jobs = await response.json();
    
    const select = document.getElementById('ratingJobSelect');
    select.innerHTML = '<option value="">Choose a completed job...</option>';
    
    // Filter completed jobs that haven't been rated yet
    const completedJobs = jobs.filter(job => 
      job.status === 'Completed' && 
      (!job.performanceRating || !job.performanceRating.rating)
    );
    
    completedJobs.forEach(job => {
      const option = document.createElement('option');
      option.value = job._id;
      option.textContent = `${job.campaignId} - ${job.name || 'Untitled Job'} - ${job.description || 'No description'}`;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading jobs for rating:', error);
  }
}

// Load jobs for badge dropdown
async function loadJobsForBadge() {
  try {
    const response = await fetch('/api/jobs', {
      headers: getAuthHeaders()
    });
    const jobs = await response.json();
    
    const select = document.getElementById('badgeJobSelect');
    select.innerHTML = '<option value="">Choose a job...</option>';
    
    jobs.forEach(job => {
      const option = document.createElement('option');
      option.value = job._id;
      option.textContent = `${job.campaignId} - ${job.name || 'Untitled Job'} - ${job.description || 'No description'}`;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading jobs for badge:', error);
  }
}

// Submit performance rating
async function submitPerformanceRating() {
  const jobId = document.getElementById('ratingJobSelect').value;
  const comments = document.getElementById('ratingComments').value;
  
  if (!jobId || !selectedRating) {
    alert('Please select a job and rating.');
    return;
  }
  
  try {
    const ratingData = {
      performanceRating: {
        rating: selectedRating,
        ratedBy: window.sessionManager.currentUser?.id,
        ratedAt: new Date().toISOString(),
        comments: comments
      }
    };
    
    const response = await fetch(`/api/jobs/${jobId}/rating`, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify(ratingData)
    });
    
    if (response.ok) {
      alert('Performance rating submitted successfully!');
      clearRatingForm();
      loadJobsForRating();
      loadPerformanceOverview();
      loadLeaderboard();
      loadRecentActivity();
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error submitting rating:', error);
    alert('Error submitting rating.');
  }
}

// Award badge
async function awardBadge() {
  const jobId = document.getElementById('badgeJobSelect').value;
  const description = document.getElementById('badgeDescription').value;
  
  if (!jobId || !selectedBadge) {
    alert('Please select a job and badge type.');
    return;
  }
  
  try {
    const badgeData = {
      appreciationBadges: [{
        badgeType: selectedBadge,
        awardedBy: window.sessionManager.currentUser?.id,
        awardedAt: new Date().toISOString(),
        description: description
      }]
    };
    
    const response = await fetch(`/api/jobs/${jobId}/badge`, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify(badgeData)
    });
    
    if (response.ok) {
      alert('Badge awarded successfully!');
      clearBadgeForm();
      loadPerformanceOverview();
      loadLeaderboard();
      loadRecentActivity();
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error awarding badge:', error);
    alert('Error awarding badge.');
  }
}

// Clear rating form
function clearRatingForm() {
  document.getElementById('ratingJobSelect').value = '';
  document.getElementById('ratingComments').value = '';
  selectedRating = null;
  document.querySelectorAll('.rating-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
}

// Clear badge form
function clearBadgeForm() {
  document.getElementById('badgeJobSelect').value = '';
  document.getElementById('badgeDescription').value = '';
  selectedBadge = null;
  document.querySelectorAll('.badge-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
}

// Load performance overview statistics
async function loadPerformanceOverview() {
  try {
    const response = await fetch('/api/jobs', {
      headers: getAuthHeaders()
    });
    const jobs = await response.json();
    
    // Calculate statistics
    const completedJobs = jobs.filter(job => job.status === 'Completed');
    const onTimeJobs = completedJobs.filter(job => {
      if (!job.endDate || !job.plannedStartDate) return false;
      const endDate = new Date(job.endDate);
      const plannedEnd = new Date(job.plannedStartDate);
      return endDate <= plannedEnd;
    });
    
    const excellentRatings = completedJobs.filter(job => 
      job.performanceRating && job.performanceRating.rating === 'excellent'
    );
    
    const totalBadges = jobs.reduce((total, job) => {
      return total + (job.appreciationBadges ? job.appreciationBadges.length : 0);
    }, 0);
    
    const uniqueEmployees = new Set(jobs.map(job => job.jobAssignedTo).filter(Boolean));
    
    // Update UI
    document.getElementById('onTimeCount').textContent = onTimeJobs.length;
    document.getElementById('excellentCount').textContent = excellentRatings.length;
    document.getElementById('totalBadges').textContent = totalBadges;
    document.getElementById('activeEmployees').textContent = uniqueEmployees.size;
  } catch (error) {
    console.error('Error loading performance overview:', error);
  }
}

// Load leaderboard
async function loadLeaderboard() {
  try {
    const response = await fetch('/api/jobs', {
      headers: getAuthHeaders()
    });
    const jobs = await response.json();
    
    // Group jobs by employee
    const employeeStats = {};
    
    jobs.forEach(job => {
      // Handle both old single employee and new multiple employees
      const employees = job.assignedEmployees || 
        (job.jobAssignedTo ? [{ employeeName: job.jobAssignedTo }] : []);
      
      employees.forEach(employee => {
        const empName = employee.employeeName || employee.employeeId;
        if (!empName) return;
        
        if (!employeeStats[empName]) {
          employeeStats[empName] = {
            name: empName,
            totalJobs: 0,
            completedJobs: 0,
            onTimeJobs: 0,
            ratings: [],
            badges: 0
          };
        }
        
        employeeStats[empName].totalJobs++;
        
        if (job.status === 'Completed') {
          employeeStats[empName].completedJobs++;
          
          // Check if on time
          if (job.endDate && job.plannedStartDate) {
            const endDate = new Date(job.endDate);
            const plannedEnd = new Date(job.plannedStartDate);
            if (endDate <= plannedEnd) {
              employeeStats[empName].onTimeJobs++;
            }
          }
          
          // Add rating
          if (job.performanceRating && job.performanceRating.rating) {
            employeeStats[empName].ratings.push(job.performanceRating.rating);
          }
        }
        
        // Count badges
        if (job.appreciationBadges) {
          employeeStats[empName].badges += job.appreciationBadges.length;
        }
      });
    });
    
    // Calculate averages and sort
    const leaderboard = Object.values(employeeStats)
      .filter(emp => emp.completedJobs > 0)
      .map(emp => {
        const onTimeRate = emp.completedJobs > 0 ? (emp.onTimeJobs / emp.completedJobs * 100).toFixed(1) : 0;
        const avgRating = emp.ratings.length > 0 ? 
          emp.ratings.reduce((sum, rating) => {
            const ratingValues = { 'excellent': 4, 'good': 3, 'average': 2, 'bad': 1 };
            return sum + (ratingValues[rating] || 0);
          }, 0) / emp.ratings.length : 0;
        
        return {
          ...emp,
          onTimeRate,
          avgRating: avgRating.toFixed(1)
        };
      })
      .sort((a, b) => {
        // Sort by average rating, then by on-time rate, then by badges
        if (b.avgRating !== a.avgRating) return b.avgRating - a.avgRating;
        if (b.onTimeRate !== a.onTimeRate) return b.onTimeRate - a.onTimeRate;
        return b.badges - a.badges;
      })
      .slice(0, 10); // Top 10
    
    // Update UI
    const tbody = document.getElementById('leaderboardBody');
    tbody.innerHTML = '';
    
    leaderboard.forEach((emp, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
          ${index + 1}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
          ${emp.name}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${emp.completedJobs}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${emp.onTimeRate}%
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${emp.avgRating}/4.0
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${emp.badges}
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading leaderboard:', error);
  }
}

// Load recent activity
async function loadRecentActivity() {
  try {
    const response = await fetch('/api/jobs', {
      headers: getAuthHeaders()
    });
    const jobs = await response.json();
    
    const activities = [];
    
    jobs.forEach(job => {
      // Add rating activities
      if (job.performanceRating && job.performanceRating.ratedAt) {
        activities.push({
          type: 'rating',
          jobId: job.campaignId,
          jobName: job.name,
          employee: job.jobAssignedTo,
          rating: job.performanceRating.rating,
          timestamp: job.performanceRating.ratedAt,
          ratedBy: job.performanceRating.ratedBy
        });
      }
      
      // Add badge activities
      if (job.appreciationBadges) {
        job.appreciationBadges.forEach(badge => {
          activities.push({
            type: 'badge',
            jobId: job.campaignId,
            jobName: job.name,
            employee: job.jobAssignedTo,
            badgeType: badge.badgeType,
            timestamp: badge.awardedAt,
            awardedBy: badge.awardedBy,
            description: badge.description
          });
        });
      }
    });
    
    // Sort by timestamp (newest first) and take latest 10
    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const recentActivities = activities.slice(0, 10);
    
    // Update UI
    const container = document.getElementById('recentActivity');
    container.innerHTML = '';
    
    recentActivities.forEach(activity => {
      const activityDiv = document.createElement('div');
      activityDiv.className = 'flex items-center p-3 bg-gray-50 rounded-lg';
      
      const icon = activity.type === 'rating' ? '‚≠ê' : 'üèÖ';
      const action = activity.type === 'rating' ? 'rated' : 'awarded badge';
      const details = activity.type === 'rating' ? 
        `${activity.rating} rating` : 
        `${activity.badgeType.replace('_', ' ')} badge`;
      
      activityDiv.innerHTML = `
        <div class="text-2xl mr-3">${icon}</div>
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-900">
            ${activity.employee} ${action} ${activity.jobId} - ${activity.jobName || 'Untitled Job'}
          </p>
          <p class="text-xs text-gray-500">${details} ‚Ä¢ ${new Date(activity.timestamp).toLocaleDateString()}</p>
        </div>
      `;
      container.appendChild(activityDiv);
    });
  } catch (error) {
    console.error('Error loading recent activity:', error);
  }
}

// Performance tracking functionality removed - no longer needed
</script>

</body>